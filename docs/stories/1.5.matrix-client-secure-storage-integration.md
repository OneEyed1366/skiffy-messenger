# Story 1.5: Интеграция MatrixClient с SecureStorage

**As a** разработчик skiffy-core,
**I want to** полностью интегрировать модуль MatrixClient с реализованной в Story 1.3 абстракцией SecureStorage,
**so that** обеспечить безопасное, персистентное хранение токенов доступа и данных сессии, устранив замечания из аудита безопасности.

---

## Status: Ready for Review

---

## Acceptance Criteria

1. **Модификация метода `login`:**
   - Сигнатура метода `login` в `MatrixClient` изменена и теперь принимает ссылку на `&dyn SecureStorage`, как рекомендовано в отчете об аудите.
   - После успешной аутентификации через `matrix-rust-sdk` полученные `access_token` и `refresh_token` **немедленно** сохраняются в `SecureStorage` с использованием стандартизированных ключей (например, `"skiffy__access_token"`).
   - `user_id` и `device_id` также сохраняются в `SecureStorage` для последующего восстановления сессии.

2. **Реализация восстановления сессии:**
   - Создан новый метод `restore_session`, который вызывается при старте приложения.
   - Этот метод пытается загрузить `access_token`, `user_id` и `device_id` из `SecureStorage`.
   - В случае успеха, `matrix-rust-sdk` инициализируется с использованием этих данных, что позволяет восстановить сессию без повторного ввода пароля.

3. **Корректная реализация `logout`:**
   - Метод `logout` теперь не только завершает сессию на сервере, но и **полностью очищает** все связанные с ней данные (`access_token`, `refresh_token`, `user_id`, `device_id`) из `SecureStorage`.

4. **Соответствие аудиту:**
   - Проблема "⚠️ ATTENTION REQUIRED: Matrix Client Authentication" из отчета `SECURITY_AUDIT.md` полностью решена.
   - Приложение больше не передает и не хранит учетные данные в виде простого текста после этапа первичного входа.

---

## Tasks / Subtasks

- [x] Modify MatrixClient login method signature (AC: 1)
  - [x] Update `rust/src/core/matrix_client/structs.rs` to accept `&dyn SecureStorage` parameter
  - [x] Update FFI API in `rust/src/api/auth.rs` to pass SecureStorage instance
  - [x] Modify login implementation to store tokens immediately after successful authentication
  - [x] Store `access_token`, `refresh_token`, `user_id`, and `device_id` with standardized keys

- [x] Implement session restoration functionality (AC: 2)
  - [x] Create `restore_session` method in MatrixClient
  - [x] Load stored credentials from SecureStorage on startup
  - [x] Initialize matrix-rust-sdk with restored session data
  - [x] Add error handling for missing or invalid stored credentials
  - [x] Expose restore_session via FFI layer

- [x] Update logout implementation (AC: 3)
  - [x] Modify `logout` method to clear all session data from SecureStorage
  - [x] Clear `access_token`, `refresh_token`, `user_id`, and `device_id`
  - [x] Ensure server-side logout is performed before clearing local data
  - [x] Handle partial failure scenarios gracefully

- [x] Integration testing and security verification (AC: 4)
  - [x] Write unit tests for modified login method with SecureStorage
  - [x] Write unit tests for restore_session functionality
  - [x] Write unit tests for logout with SecureStorage cleanup
  - [x] Verify no plaintext credentials are stored anywhere
  - [x] Test fallback scenarios (Linux in-memory storage)

- [x] Update Flutter integration layer
  - [x] Create FFI API layer for authentication (`rust/src/api/auth.rs`)
  - [x] Implement login, logout, restore_session, and has_stored_session methods
  - [x] Handle session restoration success/failure in FFI layer
  - [x] Test complete authentication flow through integration tests

---

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.3.secure-credential-storage.md]

Story 1.3 successfully implemented the complete SecureStorage system with:

- `SecureStorage` trait defined in `rust/src/core/storage/mod.rs`
- Platform-specific implementations:
  - macOS/iOS: `rust/src/core/storage/keychain.rs` using security-framework
  - Windows: `rust/src/core/storage/windows.rs` using keyring
  - Linux: `rust/src/core/storage/linux.rs` using keyring
- Fallback implementation: `rust/src/core/storage/memory.rs` for in-memory storage
- FFI API layer: `rust/src/api/secure_storage.rs`
- Flutter integration complete with warning banner for non-persistent sessions

[Source: docs/stories/story-1.2-matrix-sdk-integration.md]

Story 1.2 implemented basic Matrix SDK integration:

- `MatrixClient` struct in `rust/src/core/matrix_client/client.rs`
- Available methods: `new`, `login`, `send_message`, `sync`, `get_user_info`, `is_logged_in`
- All methods exposed via flutter_rust_bridge FFI layer
- Current login method signature: `pub async fn login(&self, username: String, password: String) -> Result<User>`

### Rust Module Structure

[Source: architecture/project-structure.md#rust-core-structure]

The MatrixClient module is located at:

```
rust/src/
├── core/
│   ├── matrix_client/
│   │   ├── mod.rs
│   │   ├── client.rs      # Main MatrixClient implementation
│   │   ├── config.rs      # Configuration
│   │   └── wrapper.rs     # SDK wrapper utilities
│   ├── storage/
│   │   ├── mod.rs         # SecureStorage trait
│   │   └── ...            # Platform implementations
```

[Source: architecture/project-structure.md#module-boundaries]

- Core business logic has no UI dependencies
- Dependencies flow: API → Core → Data
- MatrixClient is in Core layer, SecureStorage is in Data layer

### Required Changes to MatrixClient

[Source: architecture/tech-stack.md#architecture-patterns]

Current MatrixClient implementation needs modification to:

1. Accept `&dyn SecureStorage` in login method
2. Store session tokens using SecureStorage after successful authentication
3. Implement new `restore_session` method for session persistence
4. Update `logout` to clear stored credentials

Standardized key names for SecureStorage:

- `"skiffy__access_token"` - Access token from Matrix server
- `"skiffy__refresh_token"` - Refresh token for token renewal
- `"skiffy__user_id"` - User ID (e.g., @user:matrix.org)
- `"skiffy__device_id"` - Device ID for this client instance

### Error Handling Patterns

[Source: architecture/coding-standards.md#error-handling]

Use Result type with context:

```rust
use anyhow::{Result, Context};

pub async fn login(&self, username: String, password: String, storage: &dyn SecureStorage) -> Result<User> {
    let response = self.client
        .login_username(&username, &password)
        .await
        .context("Failed to authenticate with Matrix server")?;

    storage.set("skiffy__access_token", &response.access_token)
        .await
        .context("Failed to store access token")?;

    // ... continue
}
```

[Source: architecture/coding-standards.md#error-handling-across-ffi]

FFI-safe error types:

```rust
#[derive(Debug, thiserror::Error)]
pub enum AuthError {
    #[error("Authentication failed")]
    Authentication,

    #[error("Storage error: {0}")]
    Storage(String),

    #[error("Session not found")]
    SessionNotFound,
}
```

### FFI Bridge Updates

[Source: architecture/tech-stack.md#bridge-structure]

Update FFI API in `rust/src/api/auth.rs`:

- Modify login function to create and pass SecureStorage instance
- Add restore_session function to FFI API
- Ensure proper error mapping for FFI boundary

[Source: architecture/coding-standards.md#ffi-bridge-standards]

Keep FFI methods simple:

```rust
#[frb]
pub async fn login(username: String, password: String) -> Result<User> {
    let storage = create_secure_storage().await?;
    let client = MatrixClient::new().await?;
    client.login(username, password, &storage).await
}

#[frb]
pub async fn restore_session() -> Result<Option<User>> {
    let storage = create_secure_storage().await?;
    let client = MatrixClient::new().await?;
    client.restore_session(&storage).await
}
```

### Testing Requirements

[Source: architecture/coding-standards.md#testing-standards]

Test file locations:

- Unit tests: `rust/src/core/matrix_client/client.rs` (in-file #[cfg(test)] module)
- Integration tests: `rust/tests/matrix_client_integration.rs`

Required test coverage:

- Login with successful token storage
- Login with storage failure handling
- Session restoration with valid tokens
- Session restoration with missing tokens
- Logout with complete cleanup
- Platform-specific storage scenarios

Test pattern:

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use crate::core::storage::memory::InMemoryStorage;

    #[tokio::test]
    async fn test_login_stores_tokens() {
        // Arrange
        let storage = InMemoryStorage::new();
        let client = MatrixClient::new().await.unwrap();

        // Act
        let result = client.login("user", "pass", &storage).await;

        // Assert
        assert!(result.is_ok());
        assert!(storage.get("skiffy__access_token").await.is_ok());
    }
}
```

### Security Considerations

[Source: architecture/tech-stack.md#security-infrastructure]

- Never log sensitive data (tokens, passwords)
- Use Debug trait redaction for sensitive structs
- Ensure tokens are only stored via SecureStorage
- Clear all credentials on logout

[Source: architecture/coding-standards.md#security-standards]

Implement Debug carefully:

```rust
impl Debug for SessionData {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("SessionData")
            .field("user_id", &self.user_id)
            .field("device_id", &self.device_id)
            .field("access_token", &"[REDACTED]")
            .field("refresh_token", &"[REDACTED]")
            .finish()
    }
}
```

### Flutter Integration Updates

[Source: Previous story insights]

The Flutter layer already has:

- AuthBloc using BLoC pattern
- SecureStorage warning banner implementation
- FFI integration via flutter_rust_bridge

Updates needed:

- Modify AuthBloc to handle session restoration on app startup
- Update login event handler to use new FFI signature
- Add session restoration state to AuthState
- Handle restoration failures gracefully

---

## Testing

### Test File Locations

[Source: architecture/coding-standards.md#testing-standards]

**Rust Tests:**

- Unit tests: In-file `#[cfg(test)]` modules in respective source files
- Integration tests: `rust/tests/` directory
- Coverage target: >90% for security-critical code

**Flutter Tests:**

- Widget tests: `test/widgets/`
- BLoC tests: `test/blocs/`
- Integration tests: `integration_test/`

### Testing Standards

[Source: architecture/coding-standards.md#testing-standards]

- Use descriptive test names following pattern: `test_component_scenario_expected_outcome`
- Group related tests in describe/group blocks
- Follow Arrange-Act-Assert pattern
- Mock external dependencies (Matrix server, platform storage)
- Test both success and failure scenarios
- Minimum 80% coverage for new code

### Testing Frameworks

[Source: architecture/tech-stack.md#testing-stack]

**Rust:**

- Built-in `#[test]` and `#[tokio::test]` for async tests
- `mockall` for mocking traits
- `tempfile` for temporary test data

**Flutter:**

- `flutter_test` for widget and unit tests
- `bloc_test` for BLoC testing
- `mockito` for mocking services

### Story-Specific Testing Requirements

1. **Security Testing:**
   - Verify no plaintext passwords in memory after login
   - Ensure tokens are never logged
   - Test secure deletion of credentials on logout

2. **Integration Testing:**
   - Full authentication flow with real SecureStorage
   - Session restoration across app restarts
   - Fallback to in-memory storage on Linux

3. **Error Scenarios:**
   - Network failures during login
   - Storage failures when saving tokens
   - Corrupted stored session data
   - Expired tokens during restoration

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-17 | 1.1 | Story approved after validation | Sarah (Product Owner) |
| 2025-09-17 | 1.2 | Implementation completed, all acceptance criteria met | James (Developer) |

---

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514) - James the Developer persona

### Debug Log References

No critical issues encountered during implementation. All compilation errors were resolved through proper matrix-sdk 0.14.0 API usage.

### Completion Notes List

- ✅ Successfully integrated MatrixClient with SecureStorage abstraction
- ✅ Fixed matrix-sdk 0.14.0 API usage (AuthSession -> MatrixSession with SessionMeta/SessionTokens)
- ✅ Updated FFI bridge configuration to only expose API layer (removed core exposure)
- ✅ Added comprehensive test coverage for session management scenarios
- ✅ All existing integration tests updated for new login signature
- ✅ Security audit issue "⚠️ ATTENTION REQUIRED: Matrix Client Authentication" resolved

### File List

**Modified Files:**
- `rust/src/core/matrix_client/structs.rs` - Updated login/logout methods, added restore_session
- `rust/src/core/matrix_client/unit_tests.rs` - Added comprehensive test coverage
- `rust/src/core/matrix_client/integration_tests.rs` - Updated for new login signature
- `rust/src/core/storage/mod.rs` - Added Clone derive to SecureStorageError
- `rust/src/lib.rs` - Added auth API exports
- `flutter_rust_bridge.yaml` - Updated to only expose API layer

**New Files:**
- `rust/src/api/auth.rs` - New FFI authentication API layer
- `rust/src/api/mod.rs` - Updated to include auth module

---

## QA Results

*This section is populated by the QA agent during review*
