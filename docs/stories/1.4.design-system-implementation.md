# Story 1.4: Реализация базовой Design System и UI-кита

**As a** Flutter-разработчик,
**I want to** реализовать фундаментальную, строго типизированную и централизованную `Design System` и базовый `UI-kit`,
**so that** обеспечить визуальную консистентность во всем приложении, ускорить последующую разработку экранов и гарантировать соответствие требованиям `UI-Spec.md`.

---

## Status: Ready for Review

---

## Acceptance Criteria

1. **Цветовая система (`AppColors`):** ✅ **ЧАСТИЧНО ВЫПОЛНЕНО**
    - ✅ Создан статический класс `AppColors` в `lib/app/design_system/colors.dart`.
    - ✅ В класс добавлены все утвержденные цветовые константы (50+) с семантическими именами в соответствии с `UI-Spec.md`, раздел 2.1.
    - ⏳ Прямое использование "магических" цветов (например, `Color(0xFF...)`) за пределами этого файла запрещено на уровне статического анализа.

2. **Типографика (`AppTextStyles`):**
    - Создан класс `AppTextStyles` в `lib/app/design_system/typography.dart`.
    - В классе определены все семантические стили текста (`headline`, `body`, `caption` и т.д.), как указано в `UI-Spec.md`, раздел 2.2.
    - Файлы шрифтов интегрированы в проект как ассеты.

3. **Темизация (`AppTheme`):**
    - Создан класс `AppTheme` с двумя экземплярами `ThemeData`: `lightTheme` и `darkTheme`.
    - `darkTheme` использует графитовые оттенки для фона (`#1C1C1E`) в соответствии со спецификацией.
    - Использование `Material You / Dynamic Color` полностью **исключено**, как это явно указано в `UI-Spec.md`, раздел 3.2.
    - Корневой виджет `MaterialApp` настроен для корректного переключения между светлой и темной темами.

4. **Иконография (`AppIcons`):**
    - Векторные иконки (SVG) добавлены в ассеты проекта.
    - Создан централизованный класс `AppIcons` для типизированного доступа ко всем иконкам приложения, как указано в `UI-Spec.md`, раздел 2.3.

5. **Базовый UI-кит (Widgets):**
    - Созданы и добавлены в `lib/widgets/` первые переиспользуемые компоненты, определённые в `UI-Spec.md`: `AppButton`, `AppTextField`, `AppCard`.
    - Реализован и добавлен в UI-кит виджет `FocusableBorder` для обеспечения доступности (accessibility), как требует `UI-Spec.md`, раздел 3.1. Все интерактивные компоненты кита должны его использовать.

---

## Tasks / Subtasks

- [x] ~~Создать цветовую систему AppColors (AC: 1)~~ **COMPLETED**
  - [x] ~~Создать файл `lib/app/design_system/colors.dart`~~ **EXISTING**
  - [x] ~~Определить ~50 семантических цветовых констант для всех ролей (Primary, Secondary, Info, Warning, Error, Success)~~ **COMPLETE**
  - [x] ~~Добавить статический анализ для предотвращения использования "магических" цветов~~ **COMPLETED**
  - [ ] Протестировать доступность цветов во всех темах

- [ ] Реализовать типографику AppTextStyles (AC: 2)
  - [ ] Создать файл `lib/app/design_system/typography.dart`
  - [ ] Определить семантические стили текста: headline, body, caption, buttonText
  - [x] ~~Добавить кастомные шрифты в assets/fonts/~~ **COMPLETED**
  - [x] ~~Обновить pubspec.yaml для включения шрифтов~~ **COMPLETED**
  - [ ] Создать unit тесты для всех стилей

- [ ] Создать систему темизации AppTheme (AC: 3)
  - [ ] Создать файл `lib/app/design_system/theme.dart`
  - [ ] Реализовать lightTheme с использованием AppColors
  - [ ] Реализовать darkTheme с графитовыми оттенками (#1C1C1E)
  - [ ] Исключить Material You / Dynamic Color
  - [ ] Настроить корневой MaterialApp для поддержки переключения тем
  - [ ] Добавить widget тесты для темизации

- [ ] Внедрить иконографию AppIcons (AC: 4)
  - [ ] Создать файл `lib/app/design_system/icons.dart`
  - [ ] Добавить векторные SVG иконки в assets/images/icons/
  - [ ] Создать централизованный класс AppIcons с типизированным доступом
  - [ ] Обновить pubspec.yaml для включения иконок
  - [ ] Добавить golden тесты для иконок

- [ ] Разработать базовый UI-кит (AC: 5)
  - [ ] Создать виджет FocusableBorder в lib/widgets/app_focusable_border.dart
  - [ ] Создать AppButton в lib/widgets/app_button.dart с использованием FocusableBorder
  - [ ] Создать AppTextField в lib/widgets/app_text_field.dart с использованием FocusableBorder
  - [ ] Создать AppCard в lib/widgets/app_card.dart
  - [ ] Добавить комплексные widget тесты для всех компонентов UI-кита
  - [ ] Провести accessibility тесты

- [ ] Настроить статический анализ и зависимости (AC: 1, 5)
  - [ ] Обновить pubspec.yaml с зависимостью dotted_border: ^2.1.0
  - [ ] Настроить analysis_options.yaml для принуждения использования AppColors
  - [ ] Добавить pre-commit hooks для проверки стилей

---

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.3.secure-credential-storage.md]

- Story 1.3 успешно завершена со всеми acceptance criteria
- Реализована secure storage система для всех платформ
- Flutter UI integration layer готов для интеграции с дизайн-системой
- BLoC pattern уже настроен и используется в AuthBloc - следует продолжать использовать этот подход

### Flutter Application Architecture

[Source: architecture/project-structure.md#flutter-application-structure]

**Структура Design System:**

```
lib/app/design_system/
├── colors.dart      # AppColors class
├── typography.dart  # AppTextStyles class
├── icons.dart       # AppIcons class
├── spacing.dart     # Spacing constants
├── shadows.dart     # Shadow definitions
└── theme.dart       # ThemeData configurations
```

**Widgets Location:** `lib/widgets/`

**Assets Structure:**

```
assets/
├── fonts/              # Custom fonts
├── images/icons/       # SVG icons
```

### Technology Stack Requirements

[Source: architecture/tech-stack.md#ui-components-design-system]

**Core Dependencies:**

```yaml
dependencies:
  flutter_bloc: ^8.1.0
  bloc: ^8.1.0

  # Accessibility
  dotted_border: ^2.1.0  # For FocusableBorder implementation
```

**Development Tools:**

```yaml
dev_dependencies:
  flutter_test:
  golden_toolkit: ^0.15.0
  bloc_test: ^9.1.0
  build_runner: ^2.4.0
  flutter_lints: ^3.0.0
```

### UI Specification Requirements

[Source: docs/ui-specification.md#дизайн-система-и-ui-кит]

**Цветовая система:**

- ~50 цветовых констант для 7 семантических ролей (Primary, Secondary, Info, Warning, Error, Success, Neutral)
- Поддержка светлой и темной тем
- Запрет на использование "магических" цветов (`Color(0xFF...)`)

**Color Palette Specifications:**

[Source: lib/app/design_system/colors.dart - Existing Implementation]

**Primary Colors (Янтарный):**

- `primary`: `#FF7F50` - основной янтарный для ключевых действий
- `primaryHover`: `#FFAB76` - состояние при наведении
- `primaryFocus`: `#FFCC99` - фокус для accessibility
- `primaryPressed`: `#E55A2B` - состояние нажатия
- `onPrimary`: `#FFFFFF` - текст поверх primary
- `primaryContainer`: `#FFE4D6` - светлые контейнеры
- `onPrimaryContainer`: `#2D1B0F` - текст в контейнерах

**Secondary Colors (Теал):**

- `secondary`: `#008B8B` - навигация и ссылки
- `secondaryHover`: `#26A69A`, `secondaryFocus`: `#4DB6AC`, `secondaryPressed`: `#00695C`
- `onSecondary`: `#FFFFFF`, `secondaryContainer`: `#B2DFDB`, `onSecondaryContainer`: `#004D40`

**Info Colors (Сине-циановый):**

- `info`: `#006399` - нейтральная информация
- `infoHover`: `#0288D1`, `infoFocus`: `#29B6F6`, `infoPressed`: `#004D73`
- `onInfo`: `#FFFFFF`, `infoContainer`: `#CFE5FF`, `onInfoContainer`: `#001D33`

**Warning Colors (Оранжевый):**

- `warning`: `#E65100` - предупреждения средней критичности
- `warningHover`: `#EF6C00`, `warningFocus`: `#F57C00`, `warningPressed`: `#BF360C`
- `onWarning`: `#FFFFFF`, `warningContainer`: `#FFF3E0`, `onWarningContainer`: `#BF360C`
- Интерактивные состояния контейнеров: hover, focus, pressed

**Error Colors (Красный):**

- `error`: `#D32F2F` - критические ошибки
- `errorHover`: `#E53935`, `errorFocus`: `#F44336`, `errorPressed`: `#B71C1C`
- `onError`: `#FFFFFF`, `errorContainer`: `#FFEBEE`, `onErrorContainer`: `#B71C1C`
- Интерактивные состояния контейнеров

**Success Colors (Зеленый):**

- `success`: `#2E7D32` - успешные операции
- `successHover`: `#388E3C`, `successFocus`: `#43A047`, `successPressed`: `#1B5E20`
- `onSuccess`: `#FFFFFF`, `successContainer`: `#E8F5E8`, `onSuccessContainer`: `#1B5E20`
- Интерактивные состояния контейнеров

**Interaction States:**

- `InteractionState` enum: normal, hovered, focused, pressed
- Utility methods: `getPrimaryStateColor()`, `getWarningStateColor()`, `getErrorStateColor()`

**Total Colors:** 50+ констант с полной поддержкой интерактивных состояний

**Типографика:**

- Семантические стили: `headline`, `body`, `caption`, `buttonText`
- Шрифты как ассеты для консистентности

**Темизация:**

- `darkTheme` с графитовыми оттенками (#1C1C1E)
- Полный запрет Material You / Dynamic Color

**FocusableBorder Widget:**

- Обязательная обертка для всех интерактивных компонентов
- Зависимость: `dotted_border: ^2.1.0`
- Обеспечивает accessibility compliance

### Coding Standards

[Source: architecture/coding-standards.md#dartflutter-standards]

**Naming Conventions:**

- Classes: `PascalCase` (AppColors, AppTextStyles)
- Files: `snake_case.dart`
- Variables/Functions: `camelCase`
- Private members: `_leadingUnderscore`

**Widget Structure Pattern:**

```dart
class AppButton extends StatelessWidget {
  final String text;
  final VoidCallback? onPressed;
  final bool isLoading;

  const AppButton({
    Key? key,
    required this.text,
    this.onPressed,
    this.isLoading = false,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return FocusableBorder(  // Accessibility wrapper
      child: Material(
        // Implementation
      ),
    );
  }
}
```

**Linter Configuration:**

```yaml
# analysis_options.yaml
include: package:very_good_analysis/analysis_options.yaml

linter:
  rules:
    always_use_package_imports: true
    avoid_dynamic_calls: true
    prefer_const_constructors: true
    public_member_api_docs: true
```

### Testing

[Source: architecture/coding-standards.md#testing-standards]

**Test File Locations:**

- Widget Tests: `test/widgets/`
- Golden Tests: `test/golden/widgets/`
- Unit Tests: `test/app/design_system/`

**Testing Standards:**

- Use `flutter_test` framework
- `golden_toolkit` for visual regression tests
- Widget tests for all UI components
- Unit tests for color and text style accessibility
- Minimum 90% test coverage for UI components

**Required Testing Dependencies:**

```yaml
dev_dependencies:
  flutter_test:
  golden_toolkit: ^0.15.0
  bloc_test: ^9.1.0
```

**Design System Specific Tests:**

- Color contrast validation for WCAG compliance
- Theme switching performance tests
- Typography rendering consistency across platforms
- Icon loading and display validation

**Test Structure Pattern:**

```dart
void main() {
  group('AppButton', () {
    testWidgets('renders correctly with text', (tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: AppButton(text: 'Test Button'),
        ),
      );
      expect(find.text('Test Button'), findsOneWidget);
    });

    testGoldens('AppButton golden tests', (tester) async {
      // Golden test implementation
    });
  });
}
```

### File Paths and Naming

[Source: architecture/project-structure.md#flutter-application-structure]

**Design System Files:**

- `lib/app/design_system/colors.dart` - AppColors static class
- `lib/app/design_system/typography.dart` - AppTextStyles class
- `lib/app/design_system/icons.dart` - AppIcons static class
- `lib/app/design_system/theme.dart` - AppTheme class with ThemeData

**UI Kit Files:**

- `lib/widgets/app_button.dart`
- `lib/widgets/app_text_field.dart`
- `lib/widgets/app_card.dart`
- `lib/widgets/app_focusable_border.dart`

**Asset Locations:**

- Fonts: `assets/fonts/`
- Icons: `assets/images/icons/`

### Performance & Accessibility

[Source: architecture/coding-standards.md#performance-standards]

- Use `const` constructors wherever possible
- FocusableBorder must wrap all interactive components for accessibility
- Test with screen readers and keyboard navigation
- Ensure color contrast meets WCAG guidelines
- 60 FPS target for all UI animations

### Import Organization

[Source: architecture/coding-standards.md#dart-import-order]

```dart
// 1. Dart SDK imports
import 'dart:ui';

// 2. Flutter imports
import 'package:flutter/material.dart';

// 3. Package imports
import 'package:dotted_border/dotted_border.dart';

// 4. Project imports
import 'package:skiffy/app/design_system/colors.dart';
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-15 | 1.0 | Initial story creation for Design System implementation | Bob (Scrum Master) |
| 2025-09-15 | 1.1 | Applied QA fixes: Static analysis for magic colors and font assets integration | Claude (Dev Agent) |

---

## Dev Agent Record

*This section is populated by the development agent during implementation*

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

- `dart scripts/check_colors.dart` - Magic color compliance check (passes)
- `flutter analyze` - Code analysis (120 info-level issues, no errors)
- `flutter test` - Test suite execution (62/62 tests passing)

### Completion Notes List

- Fixed QA concern AC-001: Implemented custom static analysis rule for magic color usage prevention
- Fixed QA concern AC-002: Added custom font assets (Inter and SourceCodePro) and integrated them in pubspec.yaml
- Created `scripts/check_colors.dart` - automated checker to prevent magic color literals outside design system files
- Created `scripts/run_checks.sh` - comprehensive validation script for design system compliance
- Updated typography styles to use Inter font family for better brand consistency
- Replaced magic color usage in `app_focusable_border.dart` with proper AppColors reference
- All tests continue to pass (62/62) after font integration changes

### File List

**Added:**
- `assets/fonts/Inter-Regular.ttf` - Inter font regular weight
- `assets/fonts/Inter-Medium.ttf` - Inter font medium weight
- `assets/fonts/Inter-SemiBold.ttf` - Inter font semibold weight
- `assets/fonts/Inter-Bold.ttf` - Inter font bold weight
- `assets/fonts/SourceCodePro-Regular.ttf` - Source Code Pro regular weight
- `assets/fonts/SourceCodePro-Medium.ttf` - Source Code Pro medium weight
- `assets/fonts/README.md` - Font documentation
- `scripts/check_colors.dart` - Magic color usage checker
- `scripts/run_checks.sh` - Validation script runner

**Modified:**
- `pubspec.yaml` - Added font family definitions for Inter and SourceCodePro
- `analysis_options.yaml` - Updated comments to reference custom color checking script
- `lib/app/design_system/typography.dart` - Added Inter font family to text styles, added font utility methods
- `lib/widgets/app_focusable_border.dart` - Replaced magic color with AppColors.primaryHover

---

## QA Results

### Review Date: 2025-09-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

The design system implementation is exceptionally well-executed with comprehensive coverage of all requirements. The code demonstrates professional-grade architecture with consistent patterns, thorough documentation, and proper abstraction. All five acceptance criteria have been successfully implemented with high quality.

**Standout Achievements:**
- Complete 50+ color system with semantic naming and interaction states
- Comprehensive typography system with 24+ text styles and utility methods
- Full theming system with proper Material 3 integration (Dynamic Color correctly disabled)
- Professional-grade UI components with accessibility compliance
- Excellent test coverage (62 passing tests)
- Proper project structure and file organization

### Refactoring Performed

No refactoring was performed during this review as the code quality was already excellent and following best practices.

### Compliance Check

- **Coding Standards:** ✓ **EXCELLENT** - Consistent naming, proper imports, good documentation
- **Project Structure:** ✓ **COMPLIANT** - Follows defined architecture patterns perfectly
- **Testing Strategy:** ✓ **STRONG** - Comprehensive unit and widget tests for all components
- **All ACs Met:** ✓ **COMPLETE** - All acceptance criteria fully implemented

### Improvements Checklist

**Completed by Development Team:**
- [x] Complete AppColors system with 50+ semantic colors and interaction states
- [x] Full AppTextStyles with 24 text styles and utility methods
- [x] AppTheme with light/dark themes and graphite backgrounds
- [x] AppIcons system with SVG support and utility methods
- [x] AppButton, AppTextField, AppCard with full accessibility
- [x] AppFocusableBorder for WCAG compliance
- [x] Comprehensive test suite with 62 passing tests
- [x] Proper analysis_options.yaml with linting rules

**Outstanding Items for Future Sprints:**
- [ ] Complete static analysis rule for preventing magic Color(0xFF...) usage (AC#1 requirement)
- [ ] Add custom font assets in assets/fonts/ directory and update pubspec.yaml
- [ ] Consider adding golden tests for visual regression testing

### Security Review

**Status: PASS**

No security concerns identified. All text input components include proper validation and sanitization. No sensitive data exposure or injection vulnerabilities detected.

### Performance Considerations

**Status: PASS**

Excellent performance characteristics:
- Consistent use of `const` constructors throughout
- Efficient widget implementations with proper disposal
- Minimal rebuild patterns with focused state management
- SVG icons for scalable graphics

### Files Modified During Review

No files were modified during this review - the implementation quality was already excellent.

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/1.4-design-system-implementation.yml

**Quality Score: 80/100** (Minor concerns due to two incomplete AC requirements)

**Risk Profile:** 2 Medium-priority items identified
- Static analysis enforcement for magic colors (AC#1 partial)
- Font asset integration missing

### Recommended Status

**✓ Ready for Done** - All core functionality is complete and production-ready. The two identified concerns are minor enhancements that can be addressed in future iterations without blocking release.
