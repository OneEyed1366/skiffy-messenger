# Story 1.2: Add Jest for Unit and Component Testing

## Status

Draft

## Story

**As a** developer,
**I want** to integrate Jest testing framework with React Native Testing Library into the apps/v2 project,
**so that** I can write comprehensive unit tests and component tests to ensure code quality and prevent regressions during the migration process.

## Acceptance Criteria

1. **Jest Installation and Configuration**: Jest is installed and configured in the apps/v2 project with jest-expo preset for proper Expo SDK mocking and React Native compatibility
2. **React Native Testing Library Integration**: @testing-library/react-native is installed and configured for component testing with proper utility functions and queries
3. **Expo Router Testing Integration**: expo-router/testing-library is configured for testing router-based components and navigation flows
4. **Test Script Configuration**: Package.json includes jest test scripts for running tests in watch mode and generating code coverage reports
5. **TypeScript Support**: Jest is configured to work with TypeScript files and @types/jest is installed for proper type definitions
6. **Transform Patterns**: transformIgnorePatterns is configured to properly transpile node_modules for Expo and React Native dependencies using pnpm
7. **Unistyles Testing Setup**: Jest is configured with react-native-unistyles/mocks and Unistyles configuration for proper theme system testing
8. **react-i18next Testing Configuration**: Real i18next instance configured for testing without stubbing, providing authentic translation behavior in tests
9. **Sample Tests**: At least one unit test, one component test, and one router test are created demonstrating proper testing patterns with Jest, React Native Testing Library, and Expo Router testing utilities
10. **Code Coverage Configuration**: Jest is configured to collect code coverage with appropriate file exclusions and HTML report generation

## Tasks / Subtasks

- [ ] Task 1: Install and configure Jest with jest-expo preset (AC: 1, 5)
  - [ ] Run `pnpm add -D jest-expo jest @types/jest` to install dependencies
  - [ ] Add jest configuration to package.json with jest-expo preset
  - [ ] Configure transformIgnorePatterns for pnpm and Expo dependencies
  - [ ] Add setupFiles for react-native-unistyles/mocks and theme configuration
  - [ ] Verify Jest can run without errors in the project

- [ ] Task 2: Install and configure React Native Testing Library and Expo Router testing (AC: 2, 3)
  - [ ] Run `pnpm add -D @testing-library/react-native` to install testing library
  - [ ] Verify testing library compatibility with React 19.1.0 and React Native 0.81.4
  - [ ] Test basic render functionality with a simple component
  - [ ] Verify expo-router/testing-library is available (included with Expo Router)
  - [ ] Test basic renderRouter functionality with a simple route mock

- [ ] Task 3: Configure test scripts and code coverage (AC: 5, 10)
  - [ ] Add "test" script to package.json with `jest --watchAll` for development
  - [ ] Add "test:ci" script for continuous integration without watch mode
  - [ ] Configure collectCoverage and collectCoverageFrom in Jest settings
  - [ ] Set up HTML coverage reports with proper exclusions for node_modules, expo files, and config files

- [ ] Task 4: Configure Unistyles for testing (AC: 7)
  - [ ] Add react-native-unistyles/mocks to Jest setupFiles configuration
  - [ ] Add path to Unistyles configuration file (src/theme.ts) to setupFiles after mocks
  - [ ] Verify Unistyles theme system works in Jest environment
  - [ ] Test that StyleSheet.create functions properly in test environment

- [ ] Task 5: Configure react-i18next for testing without stubbing (AC: 8)
  - [ ] Create test-specific i18next configuration file (e.g., src/i18nextForTests.ts)
  - [ ] Configure minimal i18next instance with English fallback and empty translation resources
  - [ ] Set up I18nextProvider wrapper for component tests requiring translations
  - [ ] Verify i18next testing configuration works correctly

- [ ] Task 6: Create sample unit test (AC: 9)
  - [ ] Create a simple utility function in src/utils/ (e.g., formatters.ts)
  - [ ] Create corresponding co-located unit test file (e.g., formatters.test.ts)
  - [ ] Demonstrate proper Jest test structure with describe blocks and assertions
  - [ ] Verify test passes and coverage is reported correctly

- [ ] Task 7: Create sample component test with theme and i18n (AC: 9)
  - [ ] Create a simple component using theme and translation systems (e.g., Button component)
  - [ ] Create co-located component test file using React Native Testing Library (e.g., Button.test.tsx)
  - [ ] Wrap component in I18nextProvider using test i18n configuration
  - [ ] Test component rendering, user interactions, and prop variations (avoid testing styles directly)
  - [ ] Demonstrate proper use of getByText, getByRole, and other queries
  - [ ] Verify component test integration with Unistyles and i18next

- [ ] Task 8: Create sample Expo Router test (AC: 9)
  - [ ] Create a simple route component in **tests** directory (separate from app/ directory)
  - [ ] Create router integration test using expo-router/testing-library renderRouter
  - [ ] Test navigation behavior, route parameters, and pathname assertions
  - [ ] Demonstrate proper use of toHavePathname, toHaveSegments, and other router matchers
  - [ ] Verify router test works with inline file system mocking

- [ ] Task 9: Verify configuration and run tests (AC: 5, 10)
  - [ ] Run `pnpm test` to verify all tests pass (unit, component, and router tests)
  - [ ] Run tests with coverage to generate HTML report
  - [ ] Add coverage directory to .gitignore to prevent committing coverage files
  - [ ] Document testing setup and usage in project README or docs

## Dev Notes

### Technology Stack Information

[Source: docs/architecture/tech-stack.md]

**Current Tech Stack (apps/v2)**:

- **Runtime**: Expo ~54.0.13 + Tauri 2.1.0
- **Frontend Framework**: React 19.1.0 with React Compiler
- **Cross-Platform**: React Native 0.81.4 + React Native Web ~0.21.2
- **Navigation**: Expo Router ~6.0.11 (file-based routing system)
- **Styling**: react-native-unistyles 3.0.15 with theme system
- **Build System**: Expo Metro (built-in)
- **Package Manager**: pnpm (standardized for performance)
- **TypeScript**: ~5.9.2 with strict mode enabled
- **Internationalization**: i18next 25.6.0 + react-i18next 16.1.0 + expo-localization ~17.0.7

**Testing Strategy Requirements**:

Based on the provided Expo documentation, the testing setup should use:

- **jest-expo**: Expo-specific Jest preset that mocks native Expo SDK parts
- **@testing-library/react-native**: Replaces deprecated react-test-renderer (React 19 compatibility)
- **expo-router/testing-library**: Specialized testing utilities for Expo Router navigation and routing
- **TypeScript Support**: @types/jest for proper type definitions
- **Transform Patterns**: Specific configuration for pnpm and Expo dependencies

### Project Structure Context

[Source: docs/architecture/source-tree.md]

**Apps/v2 Structure**:

```
apps/v2/
├── src/
│   ├── app/                 # Expo Router application structure
│   ├── components/          # React Native UI components (CREATE tests here)
│   ├── utils/               # Pure utility functions (CREATE unit tests here)
│   ├── services/            # Business logic (CREATE integration tests here)
│   ├── hooks/               # Custom React hooks (CREATE hook tests here)
│   ├── types/               # TypeScript type definitions
│   ├── theme.ts             # Unistyles theme system
│   ├── i18next.ts           # i18n configuration
│   └── i18nextForTests.ts   # CREATE: Test-specific i18n configuration
├── __tests__/               # CREATE: Global test directory
├── package.json             # MODIFY: Add Jest scripts and dependencies
├── jest.config.js           # CREATE: Jest configuration (optional, can use package.json)
└── ...
```

**Test File Locations** (using co-located pattern):

- Unit tests: Co-located `*.spec.ts` files (e.g., `src/utils/formatters.spec.ts`)
- Component tests: Co-located `*.spec.tsx` files (e.g., `src/components/Button.spec.tsx`)
- Router/Navigation tests: `__tests__/` directory at project root (REQUIRED: do not put router tests in app/ directory)
- Integration tests: `__tests__/` directory at project root for cross-cutting tests
- Coverage output: `coverage/` directory (add to .gitignore)

**Important**: Expo Router tests MUST be in `__tests__/` directory, not in `app/` directory, as all files in `app/` must be routes or layouts.

### Coding Standards Context

[Source: docs/architecture/coding-standards.md]

**TypeScript Standards**:

- Use strict mode TypeScript with proper interfaces
- Use `@/*` path aliases for clean imports
- Follow function component patterns with explicit types

**React Standards**:

- Use functional components with React 19 compatibility
- Follow hooks order: useState, useEffect, custom hooks, then callbacks
- Let React Compiler handle optimization (avoid manual memoization)

**Testing Standards**:

- **Test File Organization**: Co-located with source files using `.spec.ts/.spec.tsx` suffix
- **Naming**: `.spec.ts` for utilities, `.spec.tsx` for components
- **Structure**: Describe blocks for logical grouping

**Import Order** (ESLint enforced):

1. Built-in modules
2. External modules (React, React Native, etc.)
3. Internal modules with path aliases
4. Sibling modules
5. Parent modules

### Package Dependencies Context

[Source: apps/v2/package.json analysis]

**Current Dependencies for Testing Compatibility**:

- **React**: 19.1.0 (requires @testing-library/react-native for React 19 support)
- **React Native**: 0.81.4 (compatible with jest-expo preset)
- **TypeScript**: ~5.9.2 (requires @types/jest)
- **Expo**: ~54.0.13 (requires jest-expo preset)
- **Package Manager**: pnpm (requires specific transformIgnorePatterns syntax)

**Dependencies to Install**:

- `jest-expo`: Provides Jest preset with Expo SDK mocks
- `jest`: Core Jest testing framework
- `@types/jest`: TypeScript definitions for Jest
- `@testing-library/react-native`: React Native Testing Library for component tests

**Dependencies Already Available**:

- `expo-router/testing-library`: Included with expo-router (already in dependencies), provides renderRouter and router-specific matchers

### Jest Configuration Requirements

Based on Expo documentation and pnpm package manager:

**Package.json Jest Configuration**:

```json
{
  "scripts": {
    "test": "jest --watchAll",
    "test:ci": "jest"
  },
  "jest": {
    "preset": "jest-expo",
    "setupFiles": ["react-native-unistyles/mocks", "./src/theme.ts"],
    "transformIgnorePatterns": [
      "node_modules/(?!(?:.pnpm/)?((jest-)?react-native|@react-native(-community)?|expo(nent)?|@expo(nent)?/.*|@expo-google-fonts/.*|react-navigation|@react-navigation/.*|@sentry/react-native|native-base|react-native-svg))"
    ],
    "collectCoverage": true,
    "collectCoverageFrom": [
      "**/*.{ts,tsx,js,jsx}",
      "!**/coverage/**",
      "!**/node_modules/**",
      "!**/babel.config.js",
      "!**/expo-env.d.ts",
      "!**/.expo/**"
    ]
  }
}
```

**Key Configuration Notes**:

- **setupFiles order**: react-native-unistyles/mocks MUST come before theme configuration
- **Unistyles mocks**: Provides necessary stubs for StyleSheet.configure and UnistylesRuntime
- **Theme configuration**: Includes actual theme.ts file for authentic styling context
- **pnpm transformIgnorePatterns**: Uses `(?:.pnpm/)?` syntax for pnpm compatibility
- **jest-expo preset**: Handles Expo SDK mocking automatically
- **Coverage exclusions**: Excludes build artifacts, dependencies, and config files

### Theme System Integration for Tests (Unistyles)

[Source: apps/v2/src/theme.ts - referenced from architecture]

When creating component tests, components will use the Unistyles theme system:

```typescript
// Component using theme
const styles = StyleSheet.create((theme) => ({
  button: {
    backgroundColor: theme.colors.buttonBg,
    padding: theme.gap(2),
    borderRadius: theme.radius.m,
  },
}));
```

**Unistyles Testing Strategy**:

Based on Unistyles documentation, use provided mocks for proper testing:

- **Mocks Provided**: react-native-unistyles/mocks handles all core functionality
- **Configuration Required**: Include actual theme.ts file after mocks in setupFiles
- **Babel Plugin**: Automatically disabled in Jest environment (NODE_ENV === 'test')
- **Testing Focus**: Test component behavior and logic, not style parsing

**Testing Requirements for Themed Components**:

- Include react-native-unistyles/mocks in Jest setupFiles
- Include theme configuration file (src/theme.ts) in setupFiles after mocks
- Test component functionality and behavior, not specific style values
- Focus on accessibility, user interactions, and component logic
- Use E2E tests (Playwright/Maestro) for visual style verification

**Important Testing Guidelines**:

- ❌ **Don't test**: Style parsing, specific CSS values, visual appearance
- ✅ **Do test**: Component rendering, user interactions, accessibility, business logic
- **Rationale**: Jest environment lacks screen dimensions, pixel ratio, and runtime values

### Internationalization Integration for Tests

[Source: apps/v2/src/i18next.ts - referenced from architecture]

Components use i18next for translations:

```typescript
// Component using translations
import { useTranslation } from 'react-i18next';

function Component() {
  const { t } = useTranslation();
  return <Text>{t('common.save')}</Text>;
}
```

**Testing Strategy for i18n Components (Without Stubbing)**:

Based on react-i18next documentation, use real i18next configuration for authentic testing:

- Create dedicated test i18next configuration (src/i18nextForTests.ts)
- Wrap components in I18nextProvider with test configuration
- Use minimal translation resources for testing
- Test actual translation behavior rather than mocked responses

**Test i18next Configuration Example**:

```typescript
// src/i18nextForTests.ts
import i18n from "i18next";
import { initReactI18next } from "react-i18next";

i18n.use(initReactI18next).init({
  lng: "en",
  fallbackLng: "en",
  ns: ["common"],
  defaultNS: "common",
  debug: false,
  interpolation: {
    escapeValue: false, // not needed for react
  },
  resources: {
    en: {
      common: {
        save: "Save",
        cancel: "Cancel",
        loading: "Loading...",
      },
    },
  },
});

export default i18n;
```

**Testing Requirements for i18n Components**:

- Use I18nextProvider wrapper with test i18n configuration
- Test translation key usage with actual translations
- Verify proper text rendering with real i18next behavior
- Test language switching if applicable

### React 19 Compatibility Notes

[Source: docs/architecture/tech-stack.md]

**React 19 Testing Considerations**:

- **@testing-library/react-native**: Required for React 19 support (replaces react-test-renderer)
- **React Compiler**: Tests should work with React Compiler optimizations
- **Strict Mode**: Components tested in strict mode environment

### Sample Test Structure Examples

**Unit Test Example** (co-located):

```typescript
// src/utils/formatters.test.ts
import { formatDate } from "./formatters";

describe("formatters", () => {
  describe("formatDate", () => {
    it("should format date correctly", () => {
      const date = new Date("2023-10-20");
      const result = formatDate(date);
      expect(result).toBe("Oct 20, 2023");
    });
  });
});
```

**Component Test Example** (co-located with i18n and Unistyles):

```typescript
// src/components/Button.test.tsx
import { render, fireEvent } from '@testing-library/react-native';
import { I18nextProvider } from 'react-i18next';
import i18n from '../i18nextForTests';
import { Button } from './Button';

// Test wrapper for i18n (Unistyles handled by Jest setup)
function TestWrapper({ children }: { children: React.ReactNode }) {
  return <I18nextProvider i18n={i18n}>{children}</I18nextProvider>;
}

describe('<Button />', () => {
  it('should render translated button text correctly', () => {
    const { getByText } = render(
      <TestWrapper>
        <Button titleKey="common.save" onPress={() => {}} />
      </TestWrapper>
    );
    getByText('Save'); // Tests actual translation
  });

  it('should call onPress when pressed', () => {
    const onPressMock = jest.fn();
    const { getByText } = render(
      <TestWrapper>
        <Button titleKey="common.save" onPress={onPressMock} />
      </TestWrapper>
    );

    fireEvent.press(getByText('Save'));
    expect(onPressMock).toHaveBeenCalled();
  });

  it('should handle disabled state correctly', () => {
    const onPressMock = jest.fn();
    const { getByText } = render(
      <TestWrapper>
        <Button titleKey="common.save" onPress={onPressMock} disabled />
      </TestWrapper>
    );

    fireEvent.press(getByText('Save'));
    expect(onPressMock).not.toHaveBeenCalled(); // Test behavior, not styles
  });
});
```

**Expo Router Test Example** (in **tests** directory):

```typescript
// __tests__/navigation.test.tsx
import { renderRouter, screen } from 'expo-router/testing-library';
import { View, Text } from 'react-native';

// Mock components for testing
const MockIndexComponent = () => <Text>Home Screen</Text>;
const MockProfileComponent = () => <Text>Profile Screen</Text>;

describe('Expo Router Navigation', () => {
  it('should navigate to correct route', async () => {
    renderRouter(
      {
        index: MockIndexComponent,
        'profile': MockProfileComponent,
      },
      {
        initialUrl: '/profile',
      }
    );

    expect(screen).toHavePathname('/profile');
    expect(screen.getByText('Profile Screen')).toBeTruthy();
  });

  it('should handle route parameters', async () => {
    const MockUserComponent = () => {
      return <Text>User Details</Text>;
    };

    renderRouter(
      {
        'user/[id]': MockUserComponent,
      },
      {
        initialUrl: '/user/123',
      }
    );

    expect(screen).toHavePathname('/user/123');
    expect(screen).toHaveSegments(['user', '[id]']);
  });
});
```

## Testing

### Testing Standards

[Source: docs/architecture/coding-standards.md]

**Test File Organization**:

- **Location**: Co-located with source files or in `__tests__` directories
- **Naming**: `.spec.ts` suffix
- **Structure**: Describe blocks for logical grouping

**Testing Requirements for This Story**:

- Test that Jest configuration loads properly with jest-expo preset
- Verify React Native Testing Library can render components
- Test that expo-router/testing-library works with renderRouter functionality
- Verify router matchers (toHavePathname, toHaveSegments) work correctly
- Configure and test react-native-unistyles/mocks for theme system
- Verify Unistyles theme configuration loads properly in Jest environment
- Create and test i18nextForTests.ts configuration without stubbing
- Test I18nextProvider wrapper functionality in component tests
- Test that coverage reports generate correctly
- Validate TypeScript integration with Jest
- Ensure transform patterns work with pnpm dependencies
- Test theme and i18n system integration in component tests

**Testing Framework Requirements**:

- Use jest-expo preset for Expo SDK mocking
- Use @testing-library/react-native for component testing (React 19 compatible)
- Use expo-router/testing-library for navigation and routing tests
- Follow Jest testing patterns with describe/it blocks
- Test files should be co-located with source files using `.spec.ts/.spec.tsx` suffix
- Router tests MUST be in `__tests__/` directory (not in `app/` directory)

**Coverage Requirements**:

- Configure Jest to collect coverage from all TypeScript/JavaScript files
- Exclude node_modules, coverage, .expo, and config files
- Generate HTML coverage reports for easy viewing
- Add coverage directory to .gitignore

## Change Log

| Date       | Version | Description                                      | Author       |
| ---------- | ------- | ------------------------------------------------ | ------------ |
| 2025-10-20 | 1.0     | Initial story creation for Jest testing setup    | Scrum Master |
| 2025-10-20 | 1.1     | Updated to use co-located test pattern           | Scrum Master |
| 2025-10-20 | 1.2     | Added Expo Router testing configuration          | Scrum Master |
| 2025-10-20 | 1.3     | Added react-i18next testing without stubbing     | Scrum Master |
| 2025-10-20 | 1.4     | Added Unistyles testing configuration with mocks | Scrum Master |

## Dev Agent Record

### Agent Model Used

<!-- To be filled by dev agent -->

### Debug Log References

<!-- To be filled by dev agent -->

### Completion Notes List

<!-- To be filled by dev agent -->

### File List

<!-- To be filled by dev agent -->

## QA Results

<!-- To be filled by QA agent -->
