# T5.12: useClickOutside Hook

## Metadata

| Field        | Value      |
| ------------ | ---------- |
| **ID**       | T5.12      |
| **Layer**    | L5 - Hooks |
| **Status**   | pending    |
| **Priority** | medium     |
| **Estimate** | 1h         |
| **Parallel** | true       |
| **Assignee** | -          |
| **Created**  | 2026-01-06 |
| **Updated**  | 2026-01-06 |

## Dependencies

| Task ID | Name |
| ------- | ---- |
| None    | -    |

## Blocks

| Task ID | Name                |
| ------- | ------------------- |
| T6.\*   | Dropdown components |
| T10.\*  | Popover components  |

## Description

Detect clicks outside an element. Useful for closing dropdowns, popovers, and menus when clicking outside.

**Platform Note:** Web/Desktop uses `mousedown` event. React Native version uses `Pressable` wrapper with `onPress` passthrough.

## Source Files

- `vendor/desktop/webapp/platform/components/src/common/hooks/useClickOutsideRef.ts`
- `vendor/desktop/webapp/channels/src/components/global_header/hooks.tsx` (duplicate)

**Note:** Vendor has 2 implementations - we consolidate to one.

## Migration Target

- **Target File**: `apps/v2/src/hooks/useClickOutside/useClickOutside.ts`
- **Target File (RN)**: `apps/v2/src/hooks/useClickOutside/useClickOutside.native.ts`
- **Index Export**: `apps/v2/src/hooks/useClickOutside/index.ts`

## Implementation (Web)

```typescript
// apps/v2/src/hooks/useClickOutside/useClickOutside.ts

/**
 * Click outside detection hook
 * Migrated from: vendor/desktop/webapp/platform/components/src/common/hooks/useClickOutsideRef.ts
 *
 * @platform web
 */

import { useEffect, type RefObject } from "react";

//#region Types

type IClickOutsideOptions = {
  /** Event type to listen for (default: 'mousedown') */
  eventType?: "mousedown" | "mouseup" | "click";
  /** Only trigger when hook is active (default: true) */
  enabled?: boolean;
};

//#endregion Types

//#region Hook

/**
 * Detect clicks outside a referenced element
 *
 * @param ref - Ref to the element to detect clicks outside of
 * @param handler - Callback when click outside is detected
 * @param options - Configuration options
 *
 * @example
 * function Dropdown({ onClose }) {
 *   const ref = useRef<HTMLDivElement>(null);
 *   useClickOutside(ref, onClose);
 *
 *   return <div ref={ref}>Dropdown content</div>;
 * }
 */
export function useClickOutside<T extends HTMLElement>(
  ref: RefObject<T>,
  handler: (event: MouseEvent) => void,
  options: IClickOutsideOptions = {},
): void {
  const { eventType = "mousedown", enabled = true } = options;

  useEffect(() => {
    if (!enabled) return;

    const handleClick = (event: MouseEvent) => {
      const target = event.target as Node;

      if (ref.current && !ref.current.contains(target)) {
        handler(event);
      }
    };

    document.addEventListener(eventType, handleClick);

    return () => {
      document.removeEventListener(eventType, handleClick);
    };
  }, [ref, handler, eventType, enabled]);
}

//#endregion Hook
```

## Implementation (React Native)

```typescript
// apps/v2/src/hooks/useClickOutside/useClickOutside.native.ts

/**
 * Click outside detection for React Native
 * Uses a backdrop Pressable approach since RN doesn't have document events
 *
 * @platform native
 */

import { useCallback } from "react";

//#region Types

type IClickOutsideResult = {
  /** Spread these props on a backdrop Pressable that covers the screen */
  backdropProps: {
    onPress: () => void;
  };
};

//#endregion Types

//#region Hook

/**
 * Returns props for a backdrop that detects outside presses
 *
 * In React Native, there's no document-level click detection.
 * Instead, render a full-screen backdrop Pressable behind your dropdown.
 *
 * @param handler - Callback when backdrop is pressed
 * @param enabled - Only active when true (default: true)
 *
 * @example
 * function Dropdown({ isOpen, onClose, children }) {
 *   const { backdropProps } = useClickOutside(onClose);
 *
 *   if (!isOpen) return null;
 *
 *   return (
 *     <>
 *       <Pressable
 *         style={StyleSheet.absoluteFillObject}
 *         {...backdropProps}
 *       />
 *       <View style={styles.dropdown}>{children}</View>
 *     </>
 *   );
 * }
 */
export function useClickOutside(
  handler: () => void,
  enabled: boolean = true,
): IClickOutsideResult {
  const onPress = useCallback(() => {
    if (enabled) {
      handler();
    }
  }, [handler, enabled]);

  return {
    backdropProps: { onPress },
  };
}

//#endregion Hook
```

## Index Export

```typescript
// apps/v2/src/hooks/useClickOutside/index.ts

export { useClickOutside } from "./useClickOutside";
```

## Acceptance Criteria

- [ ] Web version uses document event listener
- [ ] RN version provides backdrop props pattern
- [ ] `enabled` option controls activation
- [ ] Web version supports configurable event type
- [ ] Properly cleans up listener on unmount
- [ ] All types use `I` prefix naming convention
- [ ] TypeScript strict mode passes
- [ ] No `any` types

## Testing (Web)

```typescript
// apps/v2/src/hooks/useClickOutside/useClickOutside.spec.tsx

/**
 * @jest-environment jsdom
 */

import { renderHook } from "@testing-library/react-native";

import { useClickOutside } from "./useClickOutside";

describe("useClickOutside (web)", () => {
  let container: HTMLDivElement;
  let outsideElement: HTMLDivElement;

  beforeEach(() => {
    container = document.createElement("div");
    container.id = "container";
    document.body.appendChild(container);

    outsideElement = document.createElement("div");
    outsideElement.id = "outside";
    document.body.appendChild(outsideElement);
  });

  afterEach(() => {
    document.body.removeChild(container);
    document.body.removeChild(outsideElement);
  });

  it("calls handler when clicking outside", () => {
    const handler = jest.fn();
    const ref = { current: container };

    renderHook(() => useClickOutside(ref, handler));

    // Click outside
    const event = new MouseEvent("mousedown", { bubbles: true });
    outsideElement.dispatchEvent(event);

    expect(handler).toHaveBeenCalledTimes(1);
  });

  it("does not call handler when clicking inside", () => {
    const handler = jest.fn();
    const ref = { current: container };

    renderHook(() => useClickOutside(ref, handler));

    // Click inside
    const event = new MouseEvent("mousedown", { bubbles: true });
    container.dispatchEvent(event);

    expect(handler).not.toHaveBeenCalled();
  });

  it("respects enabled option", () => {
    const handler = jest.fn();
    const ref = { current: container };

    renderHook(() => useClickOutside(ref, handler, { enabled: false }));

    // Click outside
    const event = new MouseEvent("mousedown", { bubbles: true });
    outsideElement.dispatchEvent(event);

    expect(handler).not.toHaveBeenCalled();
  });

  it("supports different event types", () => {
    const handler = jest.fn();
    const ref = { current: container };

    renderHook(() => useClickOutside(ref, handler, { eventType: "click" }));

    // mousedown should not trigger
    const mousedownEvent = new MouseEvent("mousedown", { bubbles: true });
    outsideElement.dispatchEvent(mousedownEvent);
    expect(handler).not.toHaveBeenCalled();

    // click should trigger
    const clickEvent = new MouseEvent("click", { bubbles: true });
    outsideElement.dispatchEvent(clickEvent);
    expect(handler).toHaveBeenCalledTimes(1);
  });

  it("cleans up on unmount", () => {
    const handler = jest.fn();
    const ref = { current: container };

    const { unmount } = renderHook(() => useClickOutside(ref, handler));

    unmount();

    // Click outside after unmount
    const event = new MouseEvent("mousedown", { bubbles: true });
    outsideElement.dispatchEvent(event);

    expect(handler).not.toHaveBeenCalled();
  });
});
```

## Testing (React Native)

```typescript
// apps/v2/src/hooks/useClickOutside/useClickOutside.native.spec.ts

import { renderHook, act } from "@testing-library/react-native";

import { useClickOutside } from "./useClickOutside.native";

describe("useClickOutside (native)", () => {
  it("returns backdropProps with onPress handler", () => {
    const handler = jest.fn();
    const { result } = renderHook(() => useClickOutside(handler));

    expect(result.current.backdropProps.onPress).toBeDefined();
  });

  it("calls handler when backdrop pressed", () => {
    const handler = jest.fn();
    const { result } = renderHook(() => useClickOutside(handler));

    act(() => {
      result.current.backdropProps.onPress();
    });

    expect(handler).toHaveBeenCalledTimes(1);
  });

  it("respects enabled parameter", () => {
    const handler = jest.fn();
    const { result } = renderHook(() => useClickOutside(handler, false));

    act(() => {
      result.current.backdropProps.onPress();
    });

    expect(handler).not.toHaveBeenCalled();
  });
});
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- useClickOutside
```
