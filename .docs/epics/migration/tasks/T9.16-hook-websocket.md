# T9.16: useWebSocketStatus Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.16            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | high             |
| **Estimate** | 1h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-06       |
| **Updated**  | 2026-01-07       |

## Dependencies

| Task ID | Name               |
| ------- | ------------------ |
| T7.30   | useConnectionStore |

## Description

Hook to access WebSocket connection status. Components use this to show connection
indicators and handle offline states.

**Architecture Note:** WebSocket logic is handled by the RxJS service (L8). This hook
only reads connection state from Zustand. Components should NOT subscribe to WebSocket
events directly - use the RxJS stream subscriptions that update TQ cache and Zustand stores.

## Source Analysis

- **WebSocket Manager**: `vendor/desktop/webapp/platform/client/src/client/websocket_client.ts`

## Migration Target

- **Target File**: `apps/v2/src/hooks/useWebSocketStatus/useWebSocketStatus.ts`
- **Index Export**: `apps/v2/src/hooks/useWebSocketStatus/index.ts`

## Implementation

````typescript
// apps/v2/src/hooks/useWebSocketStatus/useWebSocketStatus.ts

import { useConnectionStore } from "@/stores/connection";

//#region Types

type IConnectionStatus =
  | "connected"
  | "connecting"
  | "disconnected"
  | "reconnecting";

type IUseWebSocketStatusReturn = {
  /** Whether WebSocket is connected */
  isConnected: boolean;
  /** Whether WebSocket is attempting to reconnect */
  isReconnecting: boolean;
  /** Whether WebSocket is disconnected */
  isDisconnected: boolean;
  /** Current connection status */
  status: IConnectionStatus;
  /** Number of connection errors */
  errorCount: number;
  /** Timestamp of last successful connection */
  lastConnectedAt: number | null;
};

//#endregion Types

//#region Hook

/**
 * Returns WebSocket connection status.
 *
 * @returns Connection status and metadata
 *
 * @example
 * ```tsx
 * function ConnectionIndicator() {
 *   const { isConnected, isReconnecting } = useWebSocketStatus();
 *
 *   if (isReconnecting) return <Text>Reconnecting...</Text>;
 *   if (!isConnected) return <Text>Offline</Text>;
 *   return null;
 * }
 * ```
 */
export function useWebSocketStatus(): IUseWebSocketStatusReturn {
  const status = useConnectionStore((state) => state.status);
  const errorCount = useConnectionStore((state) => state.errorCount);
  const lastConnectedAt = useConnectionStore((state) => state.lastConnectedAt);

  return {
    isConnected: status === "connected",
    isReconnecting: status === "reconnecting",
    isDisconnected: status === "disconnected",
    status,
    errorCount,
    lastConnectedAt,
  };
}

//#endregion Hook

//#region Convenience Selectors

/**
 * Returns only whether connected (minimal re-renders).
 */
export function useIsConnected(): boolean {
  return useConnectionStore((state) => state.status === "connected");
}

/**
 * Returns only whether reconnecting.
 */
export function useIsReconnecting(): boolean {
  return useConnectionStore((state) => state.status === "reconnecting");
}

//#endregion Convenience Selectors
````

## Index Export

```typescript
// apps/v2/src/hooks/useWebSocketStatus/index.ts

export {
  useWebSocketStatus,
  useIsConnected,
  useIsReconnecting,
} from "./useWebSocketStatus";
```

## Acceptance Criteria

- [ ] Returns `isConnected`, `isReconnecting`, `isDisconnected` booleans
- [ ] Returns full `status` string
- [ ] Returns `errorCount` for retry UI
- [ ] Returns `lastConnectedAt` timestamp
- [ ] Provides `useIsConnected` convenience hook
- [ ] Provides `useIsReconnecting` convenience hook
- [ ] Does NOT subscribe to WebSocket events (read-only from store)
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/hooks/useWebSocketStatus/useWebSocketStatus.spec.ts

import { renderHook } from "@testing-library/react-native";
import { useWebSocketStatus, useIsConnected } from "./useWebSocketStatus";
import { useConnectionStore } from "@/stores/connection";

jest.mock("@/stores/connection");

describe("useWebSocketStatus", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it("returns connected state", () => {
    (useConnectionStore as unknown as jest.Mock).mockImplementation(
      (selector) =>
        selector({
          status: "connected",
          errorCount: 0,
          lastConnectedAt: 1704067200000,
        }),
    );

    const { result } = renderHook(() => useWebSocketStatus());

    expect(result.current.isConnected).toBe(true);
    expect(result.current.isReconnecting).toBe(false);
    expect(result.current.status).toBe("connected");
  });

  it("returns reconnecting state", () => {
    (useConnectionStore as unknown as jest.Mock).mockImplementation(
      (selector) =>
        selector({
          status: "reconnecting",
          errorCount: 2,
          lastConnectedAt: 1704067200000,
        }),
    );

    const { result } = renderHook(() => useWebSocketStatus());

    expect(result.current.isConnected).toBe(false);
    expect(result.current.isReconnecting).toBe(true);
    expect(result.current.errorCount).toBe(2);
  });
});

describe("useIsConnected", () => {
  it("returns true when connected", () => {
    (useConnectionStore as unknown as jest.Mock).mockImplementation(
      (selector) => selector({ status: "connected" }),
    );

    const { result } = renderHook(() => useIsConnected());

    expect(result.current).toBe(true);
  });
});
```

## Notes

- **Read-only** — This hook only reads state, doesn't trigger connections
- **Connection control** — Use `websocketService.connect()` / `.disconnect()` in app layout
- **Event handling** — Components don't subscribe to events; RxJS streams update stores automatically
