# T2.03: String Utilities

## Metadata

| Field        | Value           |
| ------------ | --------------- |
| **ID**       | T2.03           |
| **Layer**    | L2 - Pure Utils |
| **Status**   | pending         |
| **Priority** | medium          |
| **Estimate** | 0.5h            |
| **Parallel** | true            |
| **Assignee** | -               |
| **Created**  | 2026-01-04      |
| **Updated**  | 2026-01-04      |

## Dependencies

None

## Blocks

| Task ID | Name       |
| ------- | ---------- |
| T4.04   | Text utils |

## Description

Extend the string utilities module with additional text transformation functions from Mattermost.

## Source Files

- `vendor/desktop/webapp/channels/src/utils/utils.tsx` (lines 92-102, 193-205, 340-345)

## Target File

`apps/v2/src/utils/string.ts` (extend existing file from T2.02)

## Implementation

```typescript
// apps/v2/src/utils/string.ts (append to existing file)

//#region HTML Entity Handling

/**
 * Map of HTML entities to their decoded characters
 */
const HTML_ENTITY_MAP: Record<string, string> = {
  "&amp;": "&",
  "&lt;": "<",
  "&gt;": ">",
  "&quot;": '"',
  "&#39;": "'",
  "&nbsp;": " ",
};

/**
 * Replaces common HTML entities with their decoded characters
 * @param text - String containing HTML entities
 * @returns Decoded string
 *
 * @example
 * replaceHtmlEntities("&lt;div&gt;") // "<div>"
 * replaceHtmlEntities("Tom &amp; Jerry") // "Tom & Jerry"
 */
export function replaceHtmlEntities(text: string): string {
  if (!text) {
    return text;
  }

  let result = text;
  for (const [entity, char] of Object.entries(HTML_ENTITY_MAP)) {
    result = result.replace(new RegExp(entity, "g"), char);
  }
  return result;
}

//#endregion

//#region Case Transformation

/**
 * Converts a string to title case (capitalizes first letter of each word)
 * @param str - String to convert
 * @returns Title-cased string
 *
 * @example
 * toTitleCase("hello world") // "Hello World"
 * toTitleCase("THE QUICK BROWN FOX") // "The Quick Brown Fox"
 */
export function toTitleCase(str: string): string {
  if (!str) {
    return str;
  }

  return str.replace(/\w\S*/g, (txt) => {
    return txt.charAt(0).toUpperCase() + txt.substring(1).toLowerCase();
  });
}

//#endregion

//#region Validation

/**
 * Email validation regex pattern.
 * Matches most common email formats.
 */
const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

/**
 * Checks if a string is a valid email address.
 *
 * @param text - String to validate
 * @returns true if the string is a valid email format
 *
 * @example
 * isEmail("user@example.com")  // true
 * isEmail("invalid-email")     // false
 * isEmail("")                  // false
 */
export function isEmail(text: string): boolean {
  if (!text) {
    return false;
  }
  return EMAIL_REGEX.test(text);
}

//#endregion

//#region Safe ID Generation

/**
 * Creates a safe ID by replacing spaces with underscores
 * Useful for generating DOM-safe identifiers from display text
 * @param input - String or object with props.defaultMessage
 * @returns Safe ID string or undefined
 *
 * @example
 * createSafeId("Hello World") // "Hello_World"
 * createSafeId({ props: { defaultMessage: "My Label" } }) // "My_Label"
 */
export function createSafeId(
  input: string | { props: { defaultMessage: string } },
): string | undefined {
  let str = "";

  if (typeof input === "string") {
    str = input;
  } else if (input?.props?.defaultMessage) {
    str = input.props.defaultMessage;
  } else {
    return undefined;
  }

  return str.replace(/ /g, "_");
}

//#endregion
```

## Index Export

```typescript
// apps/v2/src/utils/index.ts (append to existing exports)

export {
  replaceHtmlEntities,
  toTitleCase,
  isEmail,
  createSafeId,
} from "./string";
```

## Acceptance Criteria

- [ ] `replaceHtmlEntities` handles all common HTML entities
- [ ] `toTitleCase` correctly transforms all-caps and mixed-case strings
- [ ] `createSafeId` handles both string and object inputs
- [ ] `isEmail` correctly validates email format
- [ ] All functions handle null/undefined/empty string inputs gracefully
- [ ] No external dependencies required
- [ ] Exported from `utils/index.ts`
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/utils/__tests__/string.spec.ts

import {
  replaceHtmlEntities,
  toTitleCase,
  isEmail,
  createSafeId,
} from "../string";

describe("replaceHtmlEntities", () => {
  it("replaces &amp; with &", () => {
    expect(replaceHtmlEntities("Tom &amp; Jerry")).toBe("Tom & Jerry");
  });

  it("replaces &lt; and &gt; with angle brackets", () => {
    expect(replaceHtmlEntities("&lt;div&gt;")).toBe("<div>");
  });

  it("handles multiple entities", () => {
    expect(replaceHtmlEntities("&lt;a&gt; &amp; &lt;b&gt;")).toBe("<a> & <b>");
  });

  it("returns empty string for empty input", () => {
    expect(replaceHtmlEntities("")).toBe("");
  });

  it("returns null/undefined as-is", () => {
    expect(replaceHtmlEntities(null as unknown as string)).toBe(null);
    expect(replaceHtmlEntities(undefined as unknown as string)).toBe(undefined);
  });
});

describe("toTitleCase", () => {
  it("capitalizes first letter of each word", () => {
    expect(toTitleCase("hello world")).toBe("Hello World");
  });

  it("lowercases rest of each word", () => {
    expect(toTitleCase("THE QUICK BROWN FOX")).toBe("The Quick Brown Fox");
  });

  it("handles mixed case", () => {
    expect(toTitleCase("hELLo WoRLD")).toBe("Hello World");
  });

  it("handles single word", () => {
    expect(toTitleCase("hello")).toBe("Hello");
  });

  it("returns empty string for empty input", () => {
    expect(toTitleCase("")).toBe("");
  });

  it("returns null/undefined as-is", () => {
    expect(toTitleCase(null as unknown as string)).toBe(null);
    expect(toTitleCase(undefined as unknown as string)).toBe(undefined);
  });
});

describe("isEmail", () => {
  it("returns true for valid email", () => {
    expect(isEmail("user@example.com")).toBe(true);
    expect(isEmail("test.user@domain.co.uk")).toBe(true);
    expect(isEmail("user+tag@example.org")).toBe(true);
  });

  it("returns false for invalid email", () => {
    expect(isEmail("invalid-email")).toBe(false);
    expect(isEmail("@example.com")).toBe(false);
    expect(isEmail("user@")).toBe(false);
    expect(isEmail("user@.com")).toBe(false);
  });

  it("returns false for empty/null input", () => {
    expect(isEmail("")).toBe(false);
    expect(isEmail(null as unknown as string)).toBe(false);
    expect(isEmail(undefined as unknown as string)).toBe(false);
  });
});

describe("createSafeId", () => {
  it("replaces spaces with underscores for string input", () => {
    expect(createSafeId("Hello World")).toBe("Hello_World");
  });

  it("handles object with defaultMessage", () => {
    expect(createSafeId({ props: { defaultMessage: "My Label" } })).toBe(
      "My_Label",
    );
  });

  it("returns undefined for invalid object", () => {
    expect(createSafeId({} as { props: { defaultMessage: string } })).toBe(
      undefined,
    );
  });

  it("handles multiple spaces", () => {
    expect(createSafeId("One Two Three")).toBe("One_Two_Three");
  });
});
```

Run tests:

```bash
pnpm --filter @retrievly/app test:unit -- --testPathPattern=string.spec
```
