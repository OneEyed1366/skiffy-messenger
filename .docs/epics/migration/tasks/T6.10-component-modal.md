# T6.10: Modal Base Component

## Metadata

| Field        | Value              |
| ------------ | ------------------ |
| **ID**       | T6.10              |
| **Layer**    | L6 - UI Components |
| **Status**   | pending            |
| **Priority** | high               |
| **Estimate** | 4h                 |
| **Parallel** | true               |
| **Assignee** | -                  |
| **Created**  | 2026-01-04         |
| **Updated**  | 2026-01-04         |

## Dependencies

| Task ID | Name             |
| ------- | ---------------- |
| T0.01   | types-core       |
| T6.01   | component-button |
| T6.05   | component-icon   |

## Blocks

| Task ID | Name                   |
| ------- | ---------------------- |
| T6.11   | component-dialog       |
| T6.12   | component-bottom-sheet |
| T10b.\* | Feature modals         |

## Description

Migrate modal base component from Mattermost. The original uses `react-bootstrap` Modal with CSS transitions. Replace with React Native `Modal` component with Reanimated animations for cross-platform support (mobile + Tauri desktop).

## Source Files

- `vendor/desktop/webapp/platform/components/src/generic_modal/generic_modal.tsx` (lines 1-382)
- `vendor/desktop/webapp/channels/src/components/widgets/modals/full_screen_modal.tsx` (lines 1-123)
- `vendor/desktop/webapp/channels/src/components/widgets/modals/full_screen_modal.scss` (lines 1-88)

### Source Analysis

The original implementations use:

- **react-bootstrap Modal**: Core modal dialog with backdrop, keyboard handling
- **CSSTransition**: Fade/slide animations with 100ms duration
- **Focus trap**: Keep focus within modal for accessibility
- **Escape key handling**: Close on Escape press
- **aria-modal**: Accessibility attributes

Key patterns migrated:
| Original Pattern | Purpose |
|------------------|---------|
| `GenericModal` | Standard dialog with header/body/footer slots |
| `FullScreenModal` | Full-screen overlay with back/close buttons |
| `show` prop | Controls visibility |
| `onClose`/`onExited` | Close callbacks |
| `backdrop` | Dismiss on backdrop tap |
| `modalLocation` | Vertical positioning (top/center/bottom) |
| `preventClose` | Disable backdrop/escape close |

## Migration Target

- **Target Folder**: `apps/v2/src/components/Modal/`
- **Main File**: `apps/v2/src/components/Modal/Modal.tsx`
- **Index Export**: `apps/v2/src/components/Modal/index.ts`

## Implementation

```typescript
// apps/v2/src/components/Modal/Modal.tsx

/**
 * Modal base component
 * Migrated from: vendor/desktop/webapp/platform/components/src/generic_modal/generic_modal.tsx
 *
 * Uses RN Modal + Reanimated for cross-platform animations
 */

import { useEffect } from "react";
import {
  Modal as RNModal,
  Pressable,
  View,
  AccessibilityInfo,
  Platform,
} from "react-native";
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  withSpring,
  runOnJS,
  Easing,
} from "react-native-reanimated";
import { StyleSheet, UnistylesVariants } from "react-native-unistyles";

import { IconButton } from "@/components/IconButton";

//#region Types

type IModalSize = "sm" | "md" | "lg" | "fullscreen";

type IAnimationType = "fade" | "slide" | "none";

type IProps = {
  /**
   * Controls modal visibility
   */
  visible: boolean;

  /**
   * Called when modal requests close (backdrop tap, escape key, close button)
   */
  onClose: () => void;

  /**
   * Called after modal exit animation completes
   */
  onExited?: () => void;

  /**
   * Called after modal enter animation completes
   */
  onEntered?: () => void;

  /**
   * Modal content
   */
  children: React.ReactNode;

  /**
   * Header content (string or custom element)
   */
  header?: React.ReactNode;

  /**
   * Footer content (typically action buttons)
   */
  footer?: React.ReactNode;

  /**
   * Show close button in header
   * @default true
   */
  showCloseButton?: boolean;

  /**
   * Enable backdrop tap to close
   * @default true
   */
  dismissOnBackdrop?: boolean;

  /**
   * Enable escape key to close (desktop)
   * @default true
   */
  dismissOnEscape?: boolean;

  /**
   * Animation type
   * @default "slide"
   */
  animationType?: IAnimationType;

  /**
   * Animation duration in ms
   * @default 200
   */
  animationDuration?: number;

  /**
   * Accessibility label for modal
   */
  accessibilityLabel?: string;

  /**
   * Test ID for testing
   */
  testID?: string;

  /**
   * Ref for modal container
   */
  ref?: React.Ref<View>;
} & UnistylesVariants<typeof styles>;

//#endregion Types

//#region Constants

const ANIMATION_DURATION = 200;
const SPRING_CONFIG = {
  damping: 20,
  stiffness: 300,
  mass: 0.5,
};

//#endregion Constants

//#region Component

export function Modal({
  visible,
  onClose,
  onExited,
  onEntered,
  children,
  header,
  footer,
  showCloseButton = true,
  dismissOnBackdrop = true,
  dismissOnEscape = true,
  animationType = "slide",
  animationDuration = ANIMATION_DURATION,
  size = "md",
  accessibilityLabel,
  testID,
  ref,
}: IProps) {
  styles.useVariants({ size });

  // Animation values
  const backdropOpacity = useSharedValue(0);
  const contentOpacity = useSharedValue(0);
  const contentTranslateY = useSharedValue(100);
  const contentScale = useSharedValue(0.95);

  // Handle visibility changes
  useEffect(() => {
    if (visible) {
      // Enter animation
      backdropOpacity.value = withTiming(1, {
        duration: animationDuration,
        easing: Easing.out(Easing.ease),
      });

      if (animationType === "slide") {
        contentOpacity.value = withTiming(1, { duration: animationDuration });
        contentTranslateY.value = withSpring(0, SPRING_CONFIG, (finished) => {
          if (finished && onEntered) {
            runOnJS(onEntered)();
          }
        });
        contentScale.value = withSpring(1, SPRING_CONFIG);
      } else if (animationType === "fade") {
        contentTranslateY.value = 0;
        contentScale.value = 1;
        contentOpacity.value = withTiming(
          1,
          { duration: animationDuration },
          (finished) => {
            if (finished && onEntered) {
              runOnJS(onEntered)();
            }
          },
        );
      } else {
        // none
        backdropOpacity.value = 1;
        contentOpacity.value = 1;
        contentTranslateY.value = 0;
        contentScale.value = 1;
        onEntered?.();
      }

      // Announce for accessibility
      AccessibilityInfo.announceForAccessibility(
        accessibilityLabel ?? "Modal opened",
      );
    } else {
      // Exit animation
      backdropOpacity.value = withTiming(0, {
        duration: animationDuration,
        easing: Easing.in(Easing.ease),
      });

      if (animationType === "slide") {
        contentOpacity.value = withTiming(0, { duration: animationDuration });
        contentTranslateY.value = withTiming(
          100,
          { duration: animationDuration },
          (finished) => {
            if (finished && onExited) {
              runOnJS(onExited)();
            }
          },
        );
        contentScale.value = withTiming(0.95, { duration: animationDuration });
      } else if (animationType === "fade") {
        contentOpacity.value = withTiming(
          0,
          { duration: animationDuration },
          (finished) => {
            if (finished && onExited) {
              runOnJS(onExited)();
            }
          },
        );
      } else {
        // none
        backdropOpacity.value = 0;
        contentOpacity.value = 0;
        onExited?.();
      }
    }
  }, [visible, animationType, animationDuration]);

  // Handle escape key (desktop)
  useEffect(() => {
    if (!dismissOnEscape || Platform.OS !== "web") {
      return;
    }

    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === "Escape" && visible) {
        onClose();
      }
    };

    document.addEventListener("keydown", handleKeyDown);
    return () => document.removeEventListener("keydown", handleKeyDown);
  }, [visible, dismissOnEscape, onClose]);

  // Animated styles
  const backdropAnimatedStyle = useAnimatedStyle(() => ({
    opacity: backdropOpacity.value,
  }));

  const contentAnimatedStyle = useAnimatedStyle(() => ({
    opacity: contentOpacity.value,
    transform: [
      { translateY: contentTranslateY.value },
      { scale: contentScale.value },
    ],
  }));

  const handleBackdropPress = () => {
    if (dismissOnBackdrop) {
      onClose();
    }
  };

  // Don't render if not visible and animations are done
  // RN Modal handles this internally but we need state for animations

  return (
    <RNModal
      visible={visible}
      transparent={true}
      animationType="none"
      onRequestClose={onClose}
      statusBarTranslucent={true}
      accessibilityViewIsModal={true}
      accessibilityLabel={accessibilityLabel}
      testID={testID}
    >
      <View style={styles.container} ref={ref}>
        {/* Backdrop */}
        <Animated.View style={[styles.backdrop, backdropAnimatedStyle]}>
          <Pressable
            style={styles.backdropPressable}
            onPress={handleBackdropPress}
            accessibilityRole="button"
            accessibilityLabel="Close modal"
          />
        </Animated.View>

        {/* Content */}
        <Animated.View style={[styles.content, contentAnimatedStyle]}>
          {/* Header */}
          {(header || showCloseButton) && (
            <View style={styles.header}>
              <View style={styles.headerText}>{header}</View>
              {showCloseButton && (
                <IconButton
                  icon="close"
                  onPress={onClose}
                  accessibilityLabel="Close"
                  size="sm"
                />
              )}
            </View>
          )}

          {/* Body */}
          <View style={styles.body}>{children}</View>

          {/* Footer */}
          {footer && <View style={styles.footer}>{footer}</View>}
        </Animated.View>
      </View>
    </RNModal>
  );
}

//#endregion Component

//#region Styles

const styles = StyleSheet.create((theme) => ({
  container: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
  },
  backdrop: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: theme.colors.backdropBg,
  },
  backdropPressable: {
    flex: 1,
  },
  content: {
    backgroundColor: theme.colors.centerChannelBg,
    borderRadius: theme.radius.l,
    maxHeight: "90%",
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.25,
    shadowRadius: 16,
    elevation: 8,
    overflow: "hidden",
    variants: {
      size: {
        sm: {
          width: 320,
          maxWidth: "85%",
        },
        md: {
          width: 480,
          maxWidth: "90%",
        },
        lg: {
          width: 640,
          maxWidth: "95%",
        },
        fullscreen: {
          width: "100%",
          height: "100%",
          maxWidth: "100%",
          maxHeight: "100%",
          borderRadius: 0,
        },
      },
    },
  },
  header: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    paddingHorizontal: theme.gap(2),
    paddingVertical: theme.gap(1.5),
    borderBottomWidth: 1,
    borderBottomColor: theme.colors.centerChannelDivider,
  },
  headerText: {
    flex: 1,
  },
  body: {
    padding: theme.gap(2),
  },
  footer: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "flex-end",
    gap: theme.gap(1),
    paddingHorizontal: theme.gap(2),
    paddingVertical: theme.gap(1.5),
    borderTopWidth: 1,
    borderTopColor: theme.colors.centerChannelDivider,
  },
}));

//#endregion Styles
```

## Index Export

```typescript
// apps/v2/src/components/Modal/index.ts

export { Modal } from "./Modal";
```

## Acceptance Criteria

- [ ] Uses RN `Modal` component (not Portal for better native behavior)
- [ ] Backdrop with configurable dismiss on tap
- [ ] Slide up animation with spring physics (default)
- [ ] Fade animation option
- [ ] Close button in header (optional)
- [ ] Header/body/footer slots
- [ ] Size variants: `sm` (320px), `md` (480px), `lg` (640px), `fullscreen`
- [ ] Escape key closes modal on desktop (web/Tauri)
- [ ] Accessibility: `accessibilityViewIsModal`, announcements
- [ ] Animation callbacks: `onEntered`, `onExited`
- [ ] All types use `I` prefix naming convention
- [ ] No `any` types
- [ ] No `useCallback`/`useMemo` (React Compiler)
- [ ] Exported from `components/Modal/index.ts`

## Testing

```typescript
// apps/v2/src/components/Modal/Modal.spec.tsx

import { render, fireEvent, waitFor } from "@testing-library/react-native";

import { Modal } from "./Modal";

//#region Visibility Tests

describe("Modal visibility", () => {
  it("renders when visible is true", () => {
    const { getByTestId } = render(
      <Modal visible={true} onClose={jest.fn()} testID="modal">
        <></>
      </Modal>,
    );

    expect(getByTestId("modal")).toBeTruthy();
  });

  it("calls onClose when backdrop is pressed", () => {
    const onClose = jest.fn();
    const { getByLabelText } = render(
      <Modal visible={true} onClose={onClose}>
        <></>
      </Modal>,
    );

    fireEvent.press(getByLabelText("Close modal"));
    expect(onClose).toHaveBeenCalled();
  });

  it("does not call onClose when dismissOnBackdrop is false", () => {
    const onClose = jest.fn();
    const { getByLabelText } = render(
      <Modal visible={true} onClose={onClose} dismissOnBackdrop={false}>
        <></>
      </Modal>,
    );

    fireEvent.press(getByLabelText("Close modal"));
    expect(onClose).not.toHaveBeenCalled();
  });
});

//#endregion Visibility Tests

//#region Close Button Tests

describe("Modal close button", () => {
  it("renders close button by default", () => {
    const { getByLabelText } = render(
      <Modal visible={true} onClose={jest.fn()}>
        <></>
      </Modal>,
    );

    expect(getByLabelText("Close")).toBeTruthy();
  });

  it("hides close button when showCloseButton is false", () => {
    const { queryByLabelText } = render(
      <Modal visible={true} onClose={jest.fn()} showCloseButton={false}>
        <></>
      </Modal>,
    );

    expect(queryByLabelText("Close")).toBeNull();
  });

  it("calls onClose when close button is pressed", () => {
    const onClose = jest.fn();
    const { getByLabelText } = render(
      <Modal visible={true} onClose={onClose}>
        <></>
      </Modal>,
    );

    fireEvent.press(getByLabelText("Close"));
    expect(onClose).toHaveBeenCalled();
  });
});

//#endregion Close Button Tests

//#region Slots Tests

describe("Modal slots", () => {
  it("renders header content", () => {
    const { getByText } = render(
      <Modal visible={true} onClose={jest.fn()} header={<>Header Title</>}>
        <></>
      </Modal>,
    );

    expect(getByText("Header Title")).toBeTruthy();
  });

  it("renders body content", () => {
    const { getByText } = render(
      <Modal visible={true} onClose={jest.fn()}>
        <>Body Content</>
      </Modal>,
    );

    expect(getByText("Body Content")).toBeTruthy();
  });

  it("renders footer content", () => {
    const { getByText } = render(
      <Modal visible={true} onClose={jest.fn()} footer={<>Footer Actions</>}>
        <></>
      </Modal>,
    );

    expect(getByText("Footer Actions")).toBeTruthy();
  });
});

//#endregion Slots Tests

//#region Animation Callback Tests

describe("Modal animation callbacks", () => {
  it("calls onEntered after enter animation", async () => {
    const onEntered = jest.fn();
    render(
      <Modal
        visible={true}
        onClose={jest.fn()}
        onEntered={onEntered}
        animationType="none"
      >
        <></>
      </Modal>,
    );

    await waitFor(() => {
      expect(onEntered).toHaveBeenCalled();
    });
  });

  it("calls onExited after exit animation", async () => {
    const onExited = jest.fn();
    const { rerender } = render(
      <Modal
        visible={true}
        onClose={jest.fn()}
        onExited={onExited}
        animationType="none"
      >
        <></>
      </Modal>,
    );

    rerender(
      <Modal
        visible={false}
        onClose={jest.fn()}
        onExited={onExited}
        animationType="none"
      >
        <></>
      </Modal>,
    );

    await waitFor(() => {
      expect(onExited).toHaveBeenCalled();
    });
  });
});

//#endregion Animation Callback Tests

//#region Size Variant Tests

describe("Modal size variants", () => {
  it("applies sm size variant", () => {
    const { getByTestId } = render(
      <Modal visible={true} onClose={jest.fn()} size="sm" testID="modal">
        <></>
      </Modal>,
    );

    expect(getByTestId("modal")).toBeTruthy();
  });

  it("applies fullscreen size variant", () => {
    const { getByTestId } = render(
      <Modal
        visible={true}
        onClose={jest.fn()}
        size="fullscreen"
        testID="modal"
      >
        <></>
      </Modal>,
    );

    expect(getByTestId("modal")).toBeTruthy();
  });
});

//#endregion Size Variant Tests
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- Modal
```
