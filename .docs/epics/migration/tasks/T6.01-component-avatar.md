# T6.01: Avatar Component

## Metadata

| Field        | Value              |
| ------------ | ------------------ |
| **ID**       | T6.01              |
| **Layer**    | L6 - UI Components |
| **Status**   | pending            |
| **Priority** | high               |
| **Estimate** | 4h                 |
| **Parallel** | true               |
| **Assignee** | -                  |
| **Created**  | 2026-01-04         |
| **Updated**  | 2026-01-04         |

## Dependencies

| Task ID | Name       |
| ------- | ---------- |
| T0.01   | types-core |

## Blocks

| Task ID | Name                         |
| ------- | ---------------------------- |
| T6.02   | component-user-profile       |
| T6.03   | component-channel-header     |
| T10b.\* | Components with user avatars |

## Description

Migrate Avatar component from Mattermost desktop. The original uses CSS classes for sizing and supports image URLs with initials fallback. This migration converts to React Native with Unistyles variants.

Features:

- Image source with lazy loading
- Initials fallback when no image available
- Status indicator overlay (online/away/offline/dnd)
- Size variants (xs, sm, md, lg, xl, xxl)
- Shape variants (circle, rounded square)
- Bot/webhook indicator

## Source Files

- `vendor/desktop/webapp/channels/src/components/widgets/users/avatar/avatar.tsx`
- `vendor/desktop/webapp/channels/src/components/widgets/users/avatar/avatar.scss`
- `vendor/desktop/webapp/channels/src/components/profile_popover/profile_popover_avatar.tsx`
- `vendor/desktop/webapp/channels/src/components/status_icon.tsx`

### Source Analysis

The original implementation:

| Original Pattern            | Migration Target              |
| --------------------------- | ----------------------------- |
| `forwardRef`                | Regular `ref` prop (React 19) |
| CSS classes for sizes       | Unistyles variants            |
| `classNames()` utility      | Unistyles variants            |
| `data-content` for initials | React Native `<Text>`         |
| `<img>` element             | React Native `<Image>`        |
| CSS border-radius: 50%      | Unistyles `borderRadius`      |

Size mapping from original:
| Size Token | Dimensions | Font Size |
|------------|------------|-----------|
| xxs | 16px | 8px |
| xs | 20px | 9.5px |
| sm | 24px | 10px |
| md | 32px | 12px |
| lg | 36px | 14px |
| xl | 50px | 18px |
| xxl | 128px | 44px |

## Migration Target

- **Target File**: `apps/v2/src/components/Avatar/Avatar.tsx`
- **Index Export**: `apps/v2/src/components/Avatar/index.ts`
- **Test File**: `apps/v2/src/components/Avatar/Avatar.spec.tsx`
- **Stories File**: `apps/v2/src/components/Avatar/Avatar.stories.tsx`

## Implementation

```typescript
// apps/v2/src/components/Avatar/Avatar.tsx

import React from "react";
import {
  Image,
  Text,
  View,
  type ImageSourcePropType,
  type ImageErrorEventData,
  type NativeSyntheticEvent,
} from "react-native";
import { StyleSheet, UnistylesVariants } from "react-native-unistyles";

//#region Types

type IAvatarStatus = "online" | "away" | "offline" | "dnd";

type IAvatarSize = "xs" | "sm" | "md" | "lg" | "xl" | "xxl";

type IAvatarShape = "circle" | "rounded";

type IProps = {
  /**
   * Image source URL or require() for local images
   */
  source?: ImageSourcePropType | string;

  /**
   * Initials to display when no image is available (1-2 characters)
   */
  initials?: string;

  /**
   * Username for accessibility
   */
  username?: string;

  /**
   * User status indicator
   */
  status?: IAvatarStatus;

  /**
   * Whether to hide the status indicator
   */
  hideStatus?: boolean;

  /**
   * Whether this avatar represents a bot/webhook
   */
  isBot?: boolean;

  /**
   * Custom accessibility label
   */
  accessibilityLabel?: string;

  /**
   * Ref to the container View
   */
  ref?: React.Ref<React.ComponentRef<typeof View>>;

  /**
   * Callback when image fails to load
   */
  onImageError?: () => void;
} & UnistylesVariants<typeof styles>;

//#endregion Types

//#region Constants

const BOT_BADGE_SIZE_RATIO = 0.35;

const SIZE_MAP: Record<IAvatarSize, number> = {
  xs: 20,
  sm: 24,
  md: 32,
  lg: 36,
  xl: 50,
  xxl: 128,
};

const FONT_SIZE_MAP: Record<IAvatarSize, number> = {
  xs: 9,
  sm: 10,
  md: 12,
  lg: 14,
  xl: 18,
  xxl: 44,
};

const STATUS_SIZE_MAP: Record<IAvatarSize, number> = {
  xs: 6,
  sm: 8,
  md: 10,
  lg: 12,
  xl: 14,
  xxl: 32,
};

//#endregion Constants

//#region Component

export function Avatar({
  source,
  initials,
  username,
  status,
  hideStatus = false,
  isBot = false,
  size = "md",
  shape = "circle",
  accessibilityLabel,
  ref,
  onImageError,
}: IProps) {
  styles.useVariants({ size, shape });

  const [imageError, setImageError] = React.useState(false);

  const showInitials = !source || imageError;
  const showStatus = !hideStatus && status;
  const displayInitials = initials?.slice(0, 2).toUpperCase() ?? "";

  const handleImageError = (
    _event: NativeSyntheticEvent<ImageErrorEventData>,
  ) => {
    setImageError(true);
    onImageError?.();
  };

  const imageSource: ImageSourcePropType | undefined =
    typeof source === "string" ? { uri: source } : source;

  const label =
    accessibilityLabel ?? `${username ?? "User"} profile image`;

  return (
    <View
      ref={ref}
      style={styles.container}
      accessibilityRole="image"
      accessibilityLabel={label}
    >
      {showInitials ? (
        <View style={styles.initialsContainer}>
          <Text style={styles.initialsText}>{displayInitials}</Text>
        </View>
      ) : (
        <Image
          source={imageSource!}
          style={styles.image}
          onError={handleImageError}
          accessibilityLabel={label}
        />
      )}

      {showStatus && (
        <View style={styles.statusContainer}>
          <StatusIndicator status={status} size={size} />
        </View>
      )}

      {isBot && (
        <View style={styles.botBadge}>
          <Text style={styles.botBadgeText}>BOT</Text>
        </View>
      )}
    </View>
  );
}

//#endregion Component

//#region StatusIndicator

type IStatusIndicatorProps = {
  status: IAvatarStatus;
  size: IAvatarSize;
};

function StatusIndicator({ status, size }: IStatusIndicatorProps) {
  const indicatorSize = STATUS_SIZE_MAP[size];

  return (
    <View
      style={[
        statusStyles.indicator,
        statusStyles[status],
        { width: indicatorSize, height: indicatorSize, borderRadius: indicatorSize / 2 },
      ]}
      accessibilityLabel={`Status: ${status}`}
    />
  );
}

const statusStyles = StyleSheet.create((theme) => ({
  indicator: {
    borderWidth: 2,
    borderColor: theme.colors.centerChannelBg,
  },
  online: {
    backgroundColor: theme.colors.onlineIndicator,
  },
  away: {
    backgroundColor: theme.colors.awayIndicator,
  },
  offline: {
    backgroundColor: theme.colors.centerChannelColor,
    opacity: 0.4,
  },
  dnd: {
    backgroundColor: theme.colors.dndIndicator,
  },
}));

//#endregion StatusIndicator

//#region Styles

const styles = StyleSheet.create((theme) => ({
  container: {
    position: "relative",
    alignItems: "center",
    justifyContent: "center",
    variants: {
      size: {
        xs: { width: SIZE_MAP.xs, height: SIZE_MAP.xs },
        sm: { width: SIZE_MAP.sm, height: SIZE_MAP.sm },
        md: { width: SIZE_MAP.md, height: SIZE_MAP.md },
        lg: { width: SIZE_MAP.lg, height: SIZE_MAP.lg },
        xl: { width: SIZE_MAP.xl, height: SIZE_MAP.xl },
        xxl: { width: SIZE_MAP.xxl, height: SIZE_MAP.xxl },
      },
      shape: {
        circle: { borderRadius: 9999 },
        rounded: { borderRadius: theme.radius.m },
      },
    },
  },
  image: {
    width: "100%",
    height: "100%",
    variants: {
      size: {
        xs: {},
        sm: {},
        md: {},
        lg: {},
        xl: {},
        xxl: {},
      },
      shape: {
        circle: { borderRadius: 9999 },
        rounded: { borderRadius: theme.radius.m },
      },
    },
  },
  initialsContainer: {
    width: "100%",
    height: "100%",
    alignItems: "center",
    justifyContent: "center",
    backgroundColor: theme.colors.sidebarBg,
    variants: {
      size: {
        xs: {},
        sm: {},
        md: {},
        lg: {},
        xl: {},
        xxl: {},
      },
      shape: {
        circle: { borderRadius: 9999 },
        rounded: { borderRadius: theme.radius.m },
      },
    },
  },
  initialsText: {
    color: theme.colors.sidebarText,
    fontWeight: theme.fontWeights.semiBold,
    variants: {
      size: {
        xs: { fontSize: FONT_SIZE_MAP.xs },
        sm: { fontSize: FONT_SIZE_MAP.sm },
        md: { fontSize: FONT_SIZE_MAP.md },
        lg: { fontSize: FONT_SIZE_MAP.lg },
        xl: { fontSize: FONT_SIZE_MAP.xl },
        xxl: { fontSize: FONT_SIZE_MAP.xxl },
      },
      shape: {
        circle: {},
        rounded: {},
      },
    },
  },
  statusContainer: {
    position: "absolute",
    bottom: -2,
    right: -2,
  },
  botBadge: {
    position: "absolute",
    bottom: -4,
    right: -4,
    backgroundColor: theme.colors.primary,
    paddingHorizontal: 4,
    paddingVertical: 2,
    borderRadius: theme.radius.xs,
    borderWidth: 1,
    borderColor: theme.colors.centerChannelBg,
  },
  botBadgeText: {
    color: theme.colors.buttonColor,
    fontSize: 6,
    fontWeight: theme.fontWeights.semiBold,
  },
}));

//#endregion Styles
```

## Index Export

```typescript
// apps/v2/src/components/Avatar/index.ts

export { Avatar } from "./Avatar";
```

## Acceptance Criteria

- [ ] Displays image from URL or local source
- [ ] Falls back to initials when image fails to load or is not provided
- [ ] Status indicator appears in bottom-right corner
- [ ] All 6 size variants work correctly (xs, sm, md, lg, xl, xxl)
- [ ] Both circle and rounded shape variants work
- [ ] Bot badge displays for bot/webhook accounts
- [ ] Image error handling with fallback to initials
- [ ] Accessibility labels for screen readers
- [ ] Uses React 19 ref pattern (no forwardRef)
- [ ] Uses Unistyles variants (no conditional styles)
- [ ] No useMemo/useCallback (React Compiler)
- [ ] TypeScript strict mode passes
- [ ] No `any` types
- [ ] All types use `I` prefix

## Testing

```typescript
// apps/v2/src/components/Avatar/Avatar.spec.tsx

import React from "react";
import { render, fireEvent } from "@testing-library/react-native";

import { Avatar } from "./Avatar";

//#region Rendering Tests

describe("<Avatar />", () => {
  describe("rendering", () => {
    it("renders image when source is provided", () => {
      const { getByRole } = render(
        <Avatar source="https://example.com/avatar.png" username="testuser" />,
      );

      expect(getByRole("image")).toBeTruthy();
    });

    it("renders initials when no source provided", () => {
      const { getByText } = render(<Avatar initials="JD" />);

      expect(getByText("JD")).toBeTruthy();
    });

    it("truncates initials to 2 characters", () => {
      const { getByText } = render(<Avatar initials="JOHN" />);

      expect(getByText("JO")).toBeTruthy();
    });

    it("uppercases initials", () => {
      const { getByText } = render(<Avatar initials="ab" />);

      expect(getByText("AB")).toBeTruthy();
    });
  });

  //#endregion Rendering Tests

  //#region Size Variants Tests

  describe("size variants", () => {
    it("renders xs size", () => {
      const { getByRole } = render(<Avatar initials="JD" size="xs" />);

      expect(getByRole("image")).toBeTruthy();
    });

    it("renders sm size", () => {
      const { getByRole } = render(<Avatar initials="JD" size="sm" />);

      expect(getByRole("image")).toBeTruthy();
    });

    it("renders md size (default)", () => {
      const { getByRole } = render(<Avatar initials="JD" />);

      expect(getByRole("image")).toBeTruthy();
    });

    it("renders lg size", () => {
      const { getByRole } = render(<Avatar initials="JD" size="lg" />);

      expect(getByRole("image")).toBeTruthy();
    });

    it("renders xl size", () => {
      const { getByRole } = render(<Avatar initials="JD" size="xl" />);

      expect(getByRole("image")).toBeTruthy();
    });

    it("renders xxl size", () => {
      const { getByRole } = render(<Avatar initials="JD" size="xxl" />);

      expect(getByRole("image")).toBeTruthy();
    });
  });

  //#endregion Size Variants Tests

  //#region Shape Variants Tests

  describe("shape variants", () => {
    it("renders circle shape (default)", () => {
      const { getByRole } = render(<Avatar initials="JD" />);

      expect(getByRole("image")).toBeTruthy();
    });

    it("renders rounded shape", () => {
      const { getByRole } = render(<Avatar initials="JD" shape="rounded" />);

      expect(getByRole("image")).toBeTruthy();
    });
  });

  //#endregion Shape Variants Tests

  //#region Status Indicator Tests

  describe("status indicator", () => {
    it("shows online status", () => {
      const { getByLabelText } = render(
        <Avatar initials="JD" status="online" />,
      );

      expect(getByLabelText("Status: online")).toBeTruthy();
    });

    it("shows away status", () => {
      const { getByLabelText } = render(
        <Avatar initials="JD" status="away" />,
      );

      expect(getByLabelText("Status: away")).toBeTruthy();
    });

    it("shows offline status", () => {
      const { getByLabelText } = render(
        <Avatar initials="JD" status="offline" />,
      );

      expect(getByLabelText("Status: offline")).toBeTruthy();
    });

    it("shows dnd status", () => {
      const { getByLabelText } = render(
        <Avatar initials="JD" status="dnd" />,
      );

      expect(getByLabelText("Status: dnd")).toBeTruthy();
    });

    it("hides status when hideStatus is true", () => {
      const { queryByLabelText } = render(
        <Avatar initials="JD" status="online" hideStatus />,
      );

      expect(queryByLabelText("Status: online")).toBeNull();
    });

    it("does not show status when not provided", () => {
      const { queryByLabelText } = render(<Avatar initials="JD" />);

      expect(queryByLabelText(/Status:/)).toBeNull();
    });
  });

  //#endregion Status Indicator Tests

  //#region Bot Badge Tests

  describe("bot badge", () => {
    it("shows bot badge when isBot is true", () => {
      const { getByText } = render(<Avatar initials="BT" isBot />);

      expect(getByText("BOT")).toBeTruthy();
    });

    it("hides bot badge when isBot is false", () => {
      const { queryByText } = render(<Avatar initials="JD" />);

      expect(queryByText("BOT")).toBeNull();
    });
  });

  //#endregion Bot Badge Tests

  //#region Accessibility Tests

  describe("accessibility", () => {
    it("uses username for accessibility label", () => {
      const { getByLabelText } = render(
        <Avatar initials="JD" username="johndoe" />,
      );

      expect(getByLabelText("johndoe profile image")).toBeTruthy();
    });

    it("uses custom accessibility label when provided", () => {
      const { getByLabelText } = render(
        <Avatar
          initials="JD"
          username="johndoe"
          accessibilityLabel="Custom label"
        />,
      );

      expect(getByLabelText("Custom label")).toBeTruthy();
    });

    it("uses default label when no username", () => {
      const { getByLabelText } = render(<Avatar initials="JD" />);

      expect(getByLabelText("User profile image")).toBeTruthy();
    });
  });

  //#endregion Accessibility Tests

  //#region Error Handling Tests

  describe("error handling", () => {
    it("calls onImageError when image fails to load", () => {
      const onImageError = jest.fn();
      const { getByRole } = render(
        <Avatar
          source="https://example.com/broken.png"
          onImageError={onImageError}
        />,
      );

      const image = getByRole("image");
      fireEvent(image, "error");

      expect(onImageError).toHaveBeenCalled();
    });

    it("falls back to initials when image fails", () => {
      const { getByRole, getByText, rerender } = render(
        <Avatar source="https://example.com/broken.png" initials="JD" />,
      );

      const image = getByRole("image");
      fireEvent(image, "error");

      // After error, should show initials
      rerender(
        <Avatar source="https://example.com/broken.png" initials="JD" />,
      );

      // Component should now show initials fallback
      expect(getByText("JD")).toBeTruthy();
    });
  });

  //#endregion Error Handling Tests
});
```

## Storybook Stories

```typescript
// apps/v2/src/components/Avatar/Avatar.stories.tsx

import type { Meta, StoryObj } from "@storybook/react";
import { View } from "react-native";

import { Avatar } from "./Avatar";

const meta: Meta<typeof Avatar> = {
  title: "Components/Avatar",
  component: Avatar,
  argTypes: {
    size: {
      control: "select",
      options: ["xs", "sm", "md", "lg", "xl", "xxl"],
    },
    shape: {
      control: "select",
      options: ["circle", "rounded"],
    },
    status: {
      control: "select",
      options: [undefined, "online", "away", "offline", "dnd"],
    },
    isBot: {
      control: "boolean",
    },
    hideStatus: {
      control: "boolean",
    },
  },
  decorators: [
    (Story) => (
      <View style={{ padding: 20, alignItems: "center" }}>
        <Story />
      </View>
    ),
  ],
};

export default meta;
type IStory = StoryObj<typeof Avatar>;

//#region Basic Stories

export const Default: IStory = {
  args: {
    source: "https://randomuser.me/api/portraits/men/1.jpg",
    username: "johndoe",
  },
};

export const WithInitials: IStory = {
  args: {
    initials: "JD",
    username: "johndoe",
  },
};

export const WithStatus: IStory = {
  args: {
    source: "https://randomuser.me/api/portraits/women/1.jpg",
    username: "janedoe",
    status: "online",
  },
};

//#endregion Basic Stories

//#region Size Variants

export const SizeXs: IStory = {
  args: {
    initials: "XS",
    size: "xs",
  },
};

export const SizeSm: IStory = {
  args: {
    initials: "SM",
    size: "sm",
  },
};

export const SizeMd: IStory = {
  args: {
    initials: "MD",
    size: "md",
  },
};

export const SizeLg: IStory = {
  args: {
    initials: "LG",
    size: "lg",
  },
};

export const SizeXl: IStory = {
  args: {
    initials: "XL",
    size: "xl",
  },
};

export const SizeXxl: IStory = {
  args: {
    initials: "XXL",
    size: "xxl",
  },
};

export const AllSizes: IStory = {
  render: () => (
    <View style={{ flexDirection: "row", gap: 16, alignItems: "center" }}>
      <Avatar initials="XS" size="xs" />
      <Avatar initials="SM" size="sm" />
      <Avatar initials="MD" size="md" />
      <Avatar initials="LG" size="lg" />
      <Avatar initials="XL" size="xl" />
      <Avatar initials="XXL" size="xxl" />
    </View>
  ),
};

//#endregion Size Variants

//#region Status Variants

export const StatusOnline: IStory = {
  args: {
    initials: "ON",
    status: "online",
  },
};

export const StatusAway: IStory = {
  args: {
    initials: "AW",
    status: "away",
  },
};

export const StatusOffline: IStory = {
  args: {
    initials: "OF",
    status: "offline",
  },
};

export const StatusDnd: IStory = {
  args: {
    initials: "DN",
    status: "dnd",
  },
};

export const AllStatuses: IStory = {
  render: () => (
    <View style={{ flexDirection: "row", gap: 16, alignItems: "center" }}>
      <Avatar initials="ON" status="online" size="lg" />
      <Avatar initials="AW" status="away" size="lg" />
      <Avatar initials="OF" status="offline" size="lg" />
      <Avatar initials="DN" status="dnd" size="lg" />
    </View>
  ),
};

//#endregion Status Variants

//#region Shape Variants

export const ShapeCircle: IStory = {
  args: {
    initials: "CI",
    shape: "circle",
    size: "xl",
  },
};

export const ShapeRounded: IStory = {
  args: {
    initials: "RO",
    shape: "rounded",
    size: "xl",
  },
};

export const AllShapes: IStory = {
  render: () => (
    <View style={{ flexDirection: "row", gap: 16, alignItems: "center" }}>
      <Avatar initials="CI" shape="circle" size="xl" />
      <Avatar initials="RO" shape="rounded" size="xl" />
    </View>
  ),
};

//#endregion Shape Variants

//#region Special Cases

export const BotAvatar: IStory = {
  args: {
    initials: "BT",
    isBot: true,
    size: "lg",
  },
};

export const HiddenStatus: IStory = {
  args: {
    initials: "HS",
    status: "online",
    hideStatus: true,
  },
};

export const WithImageAndStatus: IStory = {
  args: {
    source: "https://randomuser.me/api/portraits/men/32.jpg",
    username: "mike",
    status: "online",
    size: "xl",
  },
};

export const RoundedWithStatus: IStory = {
  args: {
    initials: "RS",
    shape: "rounded",
    status: "away",
    size: "xl",
  },
};

//#endregion Special Cases
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- Avatar
```

### Run Storybook

```bash
pnpm --filter @retrievly/app sb:web
```
