# T7.11: Posts Mutations

## Metadata

| Field        | Value                 |
| ------------ | --------------------- |
| **ID**       | T7.11                 |
| **Layer**    | L7 - State Management |
| **Status**   | pending               |
| **Priority** | high                  |
| **Estimate** | 4h                    |
| **Parallel** | true                  |
| **Assignee** | -                     |
| **Created**  | 2026-01-06            |
| **Updated**  | 2026-01-06            |

## Dependencies

| Task ID | Name          |
| ------- | ------------- |
| T7.01   | api-client    |
| T7.03   | query-keys    |
| T7.10   | posts-queries |

## Description

Create TanStack Query mutation hooks for creating, updating, and deleting posts with optimistic updates.

**Reference:** See [State Management Architecture](../../../architecture/state-management.md#mutation-hook-template) for patterns.

## Target Files

- `apps/v2/src/mutations/posts/useCreatePostMutation.ts`
- `apps/v2/src/mutations/posts/useUpdatePostMutation.ts`
- `apps/v2/src/mutations/posts/useDeletePostMutation.ts`
- `apps/v2/src/mutations/posts/useReactToPostMutation.ts`
- `apps/v2/src/mutations/posts/usePinPostMutation.ts`
- `apps/v2/src/mutations/posts/index.ts`

## Mutations to Implement

| Mutation                 | Optimistic Update | Invalidates           |
| ------------------------ | ----------------- | --------------------- |
| `useCreatePostMutation`  | Add to list       | posts.list(channelId) |
| `useUpdatePostMutation`  | Update in cache   | posts.detail(postId)  |
| `useDeletePostMutation`  | Remove from list  | posts.list(channelId) |
| `useReactToPostMutation` | Update reactions  | posts.detail(postId)  |
| `usePinPostMutation`     | Toggle pin flag   | posts.detail(postId)  |

## Key Pattern (Optimistic Update)

```typescript
export function useCreatePostMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (payload: ICreatePostPayload) => postsApi.createPost(payload),

    onMutate: async (newPost) => {
      await queryClient.cancelQueries({
        queryKey: queryKeys.posts.list(newPost.channel_id),
      });
      const previous = queryClient.getQueryData(
        queryKeys.posts.list(newPost.channel_id),
      );

      // Optimistic update
      queryClient.setQueryData(
        queryKeys.posts.list(newPost.channel_id),
        (old) =>
          old
            ? [{ ...newPost, id: `temp-${Date.now()}`, pending: true }, ...old]
            : [],
      );

      return { previous };
    },

    onError: (err, newPost, context) => {
      queryClient.setQueryData(
        queryKeys.posts.list(newPost.channel_id),
        context?.previous,
      );
    },

    onSettled: (data, err, variables) => {
      queryClient.invalidateQueries({
        queryKey: queryKeys.posts.list(variables.channel_id),
      });
    },
  });
}
```

## Acceptance Criteria

- [ ] All 5 mutations implemented with optimistic updates
- [ ] Proper error rollback on mutation failure
- [ ] Cache invalidation on settlement
- [ ] TypeScript strict mode passes
