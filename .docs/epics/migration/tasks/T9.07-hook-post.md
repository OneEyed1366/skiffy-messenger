# T9.07: usePostQuery Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.07            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | high             |
| **Estimate** | 2h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-06       |
| **Updated**  | 2026-01-07       |

## Dependencies

| Task ID | Name        |
| ------- | ----------- |
| T7.01   | API Client  |
| T7.02   | QueryClient |
| T7.03   | Query Keys  |

## Blocks

| Task ID | Name           |
| ------- | -------------- |
| T10c.xx | Post component |
| T10c.xx | Thread view    |

## Description

Create a TanStack Query hook to fetch and cache a single post by ID.

**Architecture Note:** Post data is server state (from REST API), so it uses TanStack Query,
not Zustand. See `.docs/architecture/state-management.md`.

## Source Analysis

- **API Endpoint**: `GET /api/v4/posts/{post_id}`

## Migration Target

- **Target File**: `apps/v2/src/hooks/usePostQuery/usePostQuery.ts`
- **Index Export**: `apps/v2/src/hooks/usePostQuery/index.ts`

## Implementation

````typescript
// apps/v2/src/hooks/usePostQuery/usePostQuery.ts

import { useQuery, UseQueryOptions } from "@tanstack/react-query";
import { postsApi } from "@/api/posts";
import { queryKeys } from "@/queries/keys";
import type { IPost } from "@/types";

//#region Types

type IUsePostQueryOptions = Omit<
  UseQueryOptions<IPost, Error>,
  "queryKey" | "queryFn"
>;

//#endregion Types

//#region Hook

/**
 * Fetches and caches a single post by ID using TanStack Query.
 *
 * @param postId - Post ID to fetch (null/undefined skips query)
 * @param options - TanStack Query options
 * @returns Query result with data, isLoading, error, etc.
 *
 * @example
 * ```tsx
 * function PostPreview({ postId }: { postId: string }) {
 *   const { data: post, isLoading } = usePostQuery(postId);
 *
 *   if (isLoading) return <Spinner />;
 *   return <Text>{post.message}</Text>;
 * }
 * ```
 */
export function usePostQuery(
  postId: string | null | undefined,
  options?: IUsePostQueryOptions,
) {
  return useQuery({
    queryKey: queryKeys.posts.detail(postId!),
    queryFn: () => postsApi.getPost(postId!),
    enabled: !!postId && (options?.enabled ?? true),
    staleTime: 1000 * 60, // 1 minute
    ...options,
  });
}

//#endregion Hook
````

## Index Export

```typescript
// apps/v2/src/hooks/usePostQuery/index.ts

export { usePostQuery } from "./usePostQuery";
```

## Acceptance Criteria

- [ ] Uses TanStack Query `useQuery` hook
- [ ] Query key uses `queryKeys.posts.detail(postId)`
- [ ] Disabled when postId is null/undefined
- [ ] Returns standard TQ result
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/hooks/usePostQuery/usePostQuery.spec.ts

import { renderHook, waitFor } from "@testing-library/react-native";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { usePostQuery } from "./usePostQuery";
import { postsApi } from "@/api/posts";

jest.mock("@/api/posts");

const mockPost = {
  id: "post-1",
  channel_id: "ch-1",
  message: "Hello world",
  create_at: 1704067200000,
};

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}

describe("usePostQuery", () => {
  it("fetches post by ID", async () => {
    (postsApi.getPost as jest.Mock).mockResolvedValue(mockPost);

    const { result } = renderHook(() => usePostQuery("post-1"), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data).toEqual(mockPost);
  });

  it("does not fetch when postId is null", () => {
    const { result } = renderHook(() => usePostQuery(null), {
      wrapper: createWrapper(),
    });

    expect(result.current.fetchStatus).toBe("idle");
  });
});
```

## Notes

- **WebSocket updates** — Real-time post updates flow through `posts$` stream → TQ cache (T7.50)
- **Related hooks** — See `usePostsQuery` (channel post list), `usePostThreadQuery` (thread replies)
