# T4.09: Username Utilities

## Metadata

| Field        | Value                 |
| ------------ | --------------------- |
| **ID**       | T4.09                 |
| **Layer**    | L4 - Formatting Utils |
| **Status**   | pending               |
| **Priority** | medium                |
| **Estimate** | 1h                    |
| **Parallel** | true                  |
| **Assignee** | -                     |
| **Created**  | 2026-01-06            |
| **Updated**  | 2026-01-06            |

## Dependencies

| Task ID | Name       |
| ------- | ---------- |
| T0.02   | types-user |

## Blocks

| Task ID | Name                    |
| ------- | ----------------------- |
| T6.\*   | User display components |
| T11.\*  | Profile components      |

## Description

Username formatting and validation utilities. Handles display name resolution (nickname → full name → username fallback), username validation against Mattermost rules, and sanitization.

## Source Files

- `vendor/desktop/webapp/channels/src/utils/utils.tsx` (getDisplayName, getFullName)
- `vendor/desktop/webapp/channels/src/utils/user_utils.tsx`

## Migration Target

- **Target File**: `apps/v2/src/utils/username/username.ts`
- **Index Export**: `apps/v2/src/utils/username/index.ts`

## Implementation

```typescript
// apps/v2/src/utils/username/username.ts

import type { IUserProfile } from "@/types/user";

//#region Constants

const USERNAME_MIN_LENGTH = 3;
const USERNAME_MAX_LENGTH = 22;
const USERNAME_REGEX = /^[a-z][a-z0-9._-]*$/;

//#endregion Constants

//#region Types

type IUsernameStatus =
  | "valid"
  | "too_short"
  | "too_long"
  | "invalid_chars"
  | "invalid_start";

//#endregion Types

//#region Display Name Resolution

/**
 * Get display name for a user with fallback chain:
 * nickname → full name → username
 */
export function getDisplayName(user: IUserProfile): string {
  if (user.nickname && user.nickname.trim()) {
    return user.nickname.trim();
  }

  const fullName = getFullName(user);
  if (fullName) {
    return fullName;
  }

  return user.username || "";
}

/**
 * Get full name from first_name and last_name
 */
export function getFullName(user: IUserProfile): string {
  const parts: string[] = [];

  if (user.first_name?.trim()) {
    parts.push(user.first_name.trim());
  }

  if (user.last_name?.trim()) {
    parts.push(user.last_name.trim());
  }

  return parts.join(" ");
}

//#endregion Display Name Resolution

//#region Validation

/**
 * Check if username is valid according to Mattermost rules:
 * - 3-22 characters
 * - Starts with a letter
 * - Contains only lowercase letters, numbers, dots, underscores, hyphens
 */
export function isValidUsername(name: string): boolean {
  return getUsernameStatus(name) === "valid";
}

/**
 * Get detailed validation status for a username
 */
export function getUsernameStatus(name: string): IUsernameStatus {
  if (name.length < USERNAME_MIN_LENGTH) {
    return "too_short";
  }

  if (name.length > USERNAME_MAX_LENGTH) {
    return "too_long";
  }

  const lowercase = name.toLowerCase();

  if (!/^[a-z]/.test(lowercase)) {
    return "invalid_start";
  }

  if (!USERNAME_REGEX.test(lowercase)) {
    return "invalid_chars";
  }

  return "valid";
}

//#endregion Validation

//#region Sanitization

/**
 * Sanitize input string to valid username format:
 * - Lowercase
 * - Replace spaces and invalid chars with underscore
 * - Ensure starts with letter
 * - Truncate to max length
 */
export function sanitizeUsername(input: string): string {
  let sanitized = input
    .toLowerCase()
    .replace(/\s+/g, "_")
    .replace(/[^a-z0-9._-]/g, "_")
    .replace(/_+/g, "_");

  // Ensure starts with letter
  if (sanitized && !/^[a-z]/.test(sanitized)) {
    sanitized = "u" + sanitized;
  }

  // Truncate
  return sanitized.slice(0, USERNAME_MAX_LENGTH);
}

//#endregion Sanitization
```

## Index Export

```typescript
// apps/v2/src/utils/username/index.ts

export {
  getDisplayName,
  getFullName,
  isValidUsername,
  getUsernameStatus,
  sanitizeUsername,
} from "./username";
```

## Acceptance Criteria

- [ ] `getDisplayName()` follows nickname → fullName → username fallback
- [ ] `getFullName()` concatenates first_name and last_name
- [ ] `isValidUsername()` validates against Mattermost rules
- [ ] `getUsernameStatus()` returns specific validation error
- [ ] `sanitizeUsername()` produces valid username from arbitrary input
- [ ] All types use `I` prefix naming convention
- [ ] TypeScript strict mode passes
- [ ] No `any` types

## Testing

```typescript
// apps/v2/src/utils/username/username.spec.ts

import {
  getDisplayName,
  getFullName,
  isValidUsername,
  getUsernameStatus,
  sanitizeUsername,
} from "./username";

//#region getDisplayName Tests

describe("getDisplayName", () => {
  it("returns nickname when available", () => {
    const user = {
      nickname: "Nick",
      first_name: "John",
      last_name: "Doe",
      username: "johnd",
    };
    expect(getDisplayName(user)).toBe("Nick");
  });

  it("falls back to full name when no nickname", () => {
    const user = {
      nickname: "",
      first_name: "John",
      last_name: "Doe",
      username: "johnd",
    };
    expect(getDisplayName(user)).toBe("John Doe");
  });

  it("falls back to username when no nickname or full name", () => {
    const user = {
      nickname: "",
      first_name: "",
      last_name: "",
      username: "johnd",
    };
    expect(getDisplayName(user)).toBe("johnd");
  });

  it("trims whitespace from nickname", () => {
    const user = {
      nickname: "  Nick  ",
      first_name: "John",
      last_name: "Doe",
      username: "johnd",
    };
    expect(getDisplayName(user)).toBe("Nick");
  });
});

//#endregion getDisplayName Tests

//#region getFullName Tests

describe("getFullName", () => {
  it("returns full name from first and last", () => {
    const user = { first_name: "John", last_name: "Doe" };
    expect(getFullName(user)).toBe("John Doe");
  });

  it("returns first name only when no last name", () => {
    const user = { first_name: "John", last_name: "" };
    expect(getFullName(user)).toBe("John");
  });

  it("returns last name only when no first name", () => {
    const user = { first_name: "", last_name: "Doe" };
    expect(getFullName(user)).toBe("Doe");
  });

  it("returns empty string when neither name exists", () => {
    const user = { first_name: "", last_name: "" };
    expect(getFullName(user)).toBe("");
  });
});

//#endregion getFullName Tests

//#region isValidUsername Tests

describe("isValidUsername", () => {
  it("accepts valid usernames", () => {
    expect(isValidUsername("john")).toBe(true);
    expect(isValidUsername("john_doe")).toBe(true);
    expect(isValidUsername("john.doe")).toBe(true);
    expect(isValidUsername("john-doe123")).toBe(true);
    expect(isValidUsername("abc")).toBe(true);
  });

  it("rejects too short usernames", () => {
    expect(isValidUsername("ab")).toBe(false);
    expect(isValidUsername("a")).toBe(false);
  });

  it("rejects too long usernames", () => {
    expect(isValidUsername("a".repeat(23))).toBe(false);
  });

  it("rejects usernames starting with non-letter", () => {
    expect(isValidUsername("1john")).toBe(false);
    expect(isValidUsername("_john")).toBe(false);
    expect(isValidUsername(".john")).toBe(false);
  });

  it("rejects usernames with invalid characters", () => {
    expect(isValidUsername("john@doe")).toBe(false);
    expect(isValidUsername("john doe")).toBe(false);
    expect(isValidUsername("john!")).toBe(false);
  });
});

//#endregion isValidUsername Tests

//#region getUsernameStatus Tests

describe("getUsernameStatus", () => {
  it("returns specific error codes", () => {
    expect(getUsernameStatus("ab")).toBe("too_short");
    expect(getUsernameStatus("a".repeat(30))).toBe("too_long");
    expect(getUsernameStatus("1abc")).toBe("invalid_start");
    expect(getUsernameStatus("abc@def")).toBe("invalid_chars");
    expect(getUsernameStatus("valid_user")).toBe("valid");
  });
});

//#endregion getUsernameStatus Tests

//#region sanitizeUsername Tests

describe("sanitizeUsername", () => {
  it("converts to lowercase", () => {
    expect(sanitizeUsername("JohnDoe")).toBe("johndoe");
  });

  it("replaces spaces with underscores", () => {
    expect(sanitizeUsername("john doe")).toBe("john_doe");
  });

  it("replaces invalid chars with underscores", () => {
    expect(sanitizeUsername("john@doe!")).toBe("john_doe_");
  });

  it("collapses multiple underscores", () => {
    expect(sanitizeUsername("john  doe")).toBe("john_doe");
  });

  it("prepends u if starts with non-letter", () => {
    expect(sanitizeUsername("123abc")).toBe("u123abc");
  });

  it("truncates to max length", () => {
    const result = sanitizeUsername("a".repeat(30));
    expect(result.length).toBe(22);
  });
});

//#endregion sanitizeUsername Tests
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- username
```
