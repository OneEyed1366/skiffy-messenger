# T3.03: Device Utilities

## Metadata

| Field        | Value      |
| ------------ | ---------- |
| **ID**       | T3.03      |
| **Layer**    | L3 - Utils |
| **Status**   | pending    |
| **Priority** | medium     |
| **Estimate** | 1h         |
| **Parallel** | true       |
| **Assignee** | -          |
| **Created**  | 2026-01-04 |
| **Updated**  | 2026-01-04 |

## Dependencies

| Task ID | Name               |
| ------- | ------------------ |
| T3.01   | Platform Detection |

## Blocks

| Task ID | Name                  |
| ------- | --------------------- |
| T10a.\* | Layout components     |
| T10b.\* | Navigation components |
| T10c.\* | Screen containers     |

## Description

Create device capability utilities for screen dimensions, pixel ratio, device type detection, and safe area insets using expo-device and React Native APIs.

## Source Files

- React Native `Dimensions` API
- React Native `PixelRatio` API
- React Native `Platform` API
- `expo-device` package
- `react-native-safe-area-context` package

## Target File

`apps/v2/src/utils/device.ts`

## Implementation

```typescript
// apps/v2/src/utils/device.ts

/**
 * Device capability utilities
 * Provides screen dimensions, pixel ratio, device type, and safe area insets
 */

import { Dimensions, PixelRatio, Platform } from "react-native";
import * as Device from "expo-device";

//#region Types

export type IScreenDimensions = {
  width: number;
  height: number;
  scale: number;
  fontScale: number;
};

export type IDeviceInfo = {
  brand: string | null;
  manufacturer: string | null;
  modelName: string | null;
  modelId: string | null;
  osName: string | null;
  osVersion: string | null;
  osBuildId: string | null;
  platformApiLevel: number | null;
  deviceName: string | null;
  deviceYearClass: number | null;
  isDevice: boolean;
  supportedCpuArchitectures: string[] | null;
  totalMemory: number | null;
};

export type ISafeAreaInsets = {
  top: number;
  right: number;
  bottom: number;
  left: number;
};

export type IDeviceType = "unknown" | "phone" | "tablet" | "tv" | "desktop";

//#endregion

//#region Screen Dimensions

/**
 * Get current screen dimensions with scale factors
 * @returns Screen width, height, scale, and font scale
 */
export function getScreenDimensions(): IScreenDimensions {
  const { width, height, scale, fontScale } = Dimensions.get("window");
  return {
    width,
    height,
    scale,
    fontScale,
  };
}

/**
 * Get screen width
 * @returns Screen width in density-independent pixels
 */
export function getScreenWidth(): number {
  return Dimensions.get("window").width;
}

/**
 * Get screen height
 * @returns Screen height in density-independent pixels
 */
export function getScreenHeight(): number {
  return Dimensions.get("window").height;
}

//#endregion

//#region Pixel Ratio

/**
 * Get device pixel ratio (density)
 * @returns Pixel ratio (e.g., 2 for @2x, 3 for @3x)
 */
export function getPixelRatio(): number {
  return PixelRatio.get();
}

/**
 * Get font scale factor
 * @returns Font scale based on user accessibility settings
 */
export function getFontScale(): number {
  return PixelRatio.getFontScale();
}

/**
 * Convert layout size to pixel size
 * @param layoutSize - Size in density-independent pixels
 * @returns Size in physical pixels
 */
export function getPixelSizeForLayoutSize(layoutSize: number): number {
  return PixelRatio.getPixelSizeForLayoutSize(layoutSize);
}

/**
 * Round to nearest pixel boundary
 * @param layoutSize - Size in density-independent pixels
 * @returns Rounded size for crisp rendering
 */
export function roundToNearestPixel(layoutSize: number): number {
  return PixelRatio.roundToNearestPixel(layoutSize);
}

//#endregion

//#region Device Type

/**
 * Map expo-device DeviceType to string enum
 */
function mapDeviceType(deviceType: Device.DeviceType | null): IDeviceType {
  switch (deviceType) {
    case Device.DeviceType.PHONE:
      return "phone";
    case Device.DeviceType.TABLET:
      return "tablet";
    case Device.DeviceType.TV:
      return "tv";
    case Device.DeviceType.DESKTOP:
      return "desktop";
    default:
      return "unknown";
  }
}

/**
 * Check if device is a tablet
 * @returns True if device is a tablet
 */
export function isTablet(): boolean {
  return Device.deviceType === Device.DeviceType.TABLET;
}

/**
 * Check if device is a phone
 * @returns True if device is a phone
 */
export function isPhone(): boolean {
  return Device.deviceType === Device.DeviceType.PHONE;
}

/**
 * Check if running on a physical device (not simulator/emulator)
 * @returns True if running on physical device
 */
export function isPhysicalDevice(): boolean {
  return Device.isDevice;
}

/**
 * Get device type asynchronously (more accurate on Android)
 * @returns Promise resolving to device type
 */
export async function getDeviceTypeAsync(): Promise<IDeviceType> {
  const deviceType = await Device.getDeviceTypeAsync();
  return mapDeviceType(deviceType);
}

/**
 * Get device type synchronously
 * @returns Device type (may be less accurate on Android)
 */
export function getDeviceType(): IDeviceType {
  return mapDeviceType(Device.deviceType);
}

//#endregion

//#region Device Info

/**
 * Get comprehensive device information
 * @returns Device info object with hardware and OS details
 */
export function getDeviceInfo(): IDeviceInfo {
  return {
    brand: Device.brand,
    manufacturer: Device.manufacturer,
    modelName: Device.modelName,
    modelId: Device.modelId,
    osName: Device.osName,
    osVersion: Device.osVersion,
    osBuildId: Device.osBuildId,
    platformApiLevel: Device.platformApiLevel,
    deviceName: Device.deviceName,
    deviceYearClass: Device.deviceYearClass,
    isDevice: Device.isDevice,
    supportedCpuArchitectures: Device.supportedCpuArchitectures,
    totalMemory: Device.totalMemory,
  };
}

/**
 * Get current platform
 * @returns "ios" | "android" | "web" | "windows" | "macos"
 */
export function getPlatform(): typeof Platform.OS {
  return Platform.OS;
}

// NOTE: isIos, isAndroid, isWeb are imported from @/utils/platform (T3.01)
// to avoid duplication. Re-export for convenience:
export { isIos, isAndroid, isWeb } from "@/utils/platform";

//#endregion

//#region Safe Area

/**
 * Default safe area insets (zero values)
 * Use useSafeAreaInsets hook for actual values in components
 */
export const DEFAULT_SAFE_AREA_INSETS: ISafeAreaInsets = {
  top: 0,
  right: 0,
  bottom: 0,
  left: 0,
};

/**
 * Get estimated safe area insets based on platform
 * Note: For accurate values, use useSafeAreaInsets hook from react-native-safe-area-context
 * @returns Estimated safe area insets
 */
export function getEstimatedSafeAreaInsets(): ISafeAreaInsets {
  if (Platform.OS === "ios") {
    // Rough estimates for iOS devices with notch
    // Actual values should come from useSafeAreaInsets hook
    return {
      top: 47,
      right: 0,
      bottom: 34,
      left: 0,
    };
  }

  if (Platform.OS === "android") {
    // Android status bar height estimate
    return {
      top: 24,
      right: 0,
      bottom: 0,
      left: 0,
    };
  }

  return DEFAULT_SAFE_AREA_INSETS;
}

//#endregion
```

## Index Export

```typescript
// apps/v2/src/utils/index.ts

export {
  // Types
  type IScreenDimensions,
  type IDeviceInfo,
  type ISafeAreaInsets,
  type IDeviceType,
  // Screen Dimensions
  getScreenDimensions,
  getScreenWidth,
  getScreenHeight,
  // Pixel Ratio
  getPixelRatio,
  getFontScale,
  getPixelSizeForLayoutSize,
  roundToNearestPixel,
  // Device Type
  isTablet,
  isPhone,
  isPhysicalDevice,
  getDeviceTypeAsync,
  getDeviceType,
  // Device Info
  getDeviceInfo,
  getPlatform,
  // Re-exported from @/utils/platform (T3.01) - avoid duplication
  isIos,
  isAndroid,
  isWeb,
  // Safe Area
  DEFAULT_SAFE_AREA_INSETS,
  getEstimatedSafeAreaInsets,
} from "./device";
```

## Acceptance Criteria

- [ ] All types defined with `type` keyword
- [ ] All types prefixed with `I`
- [ ] Uses `#region` comments for organization
- [ ] Exported from `utils/index.ts`
- [ ] No `any` types
- [ ] TypeScript strict mode passes
- [ ] `getScreenDimensions` returns width, height, scale, fontScale
- [ ] `getPixelRatio` returns device pixel density
- [ ] `isTablet` correctly detects tablet devices
- [ ] `getDeviceInfo` returns comprehensive device details
- [ ] `getEstimatedSafeAreaInsets` provides platform-aware defaults

## Testing

```typescript
// apps/v2/src/utils/device.spec.ts

import {
  getScreenDimensions,
  getScreenWidth,
  getScreenHeight,
  getPixelRatio,
  getFontScale,
  getPixelSizeForLayoutSize,
  roundToNearestPixel,
  isTablet,
  isPhone,
  isPhysicalDevice,
  getDeviceType,
  getDeviceTypeAsync,
  getDeviceInfo,
  getPlatform,
  isIOS,
  isAndroid,
  isWeb,
  DEFAULT_SAFE_AREA_INSETS,
  getEstimatedSafeAreaInsets,
} from "./device";

describe("device utilities", () => {
  //#region Screen Dimensions

  describe("getScreenDimensions", () => {
    it("returns object with width, height, scale, fontScale", () => {
      const dims = getScreenDimensions();

      expect(dims).toHaveProperty("width");
      expect(dims).toHaveProperty("height");
      expect(dims).toHaveProperty("scale");
      expect(dims).toHaveProperty("fontScale");
      expect(typeof dims.width).toBe("number");
      expect(typeof dims.height).toBe("number");
    });
  });

  describe("getScreenWidth", () => {
    it("returns a positive number", () => {
      const width = getScreenWidth();

      expect(typeof width).toBe("number");
      expect(width).toBeGreaterThan(0);
    });
  });

  describe("getScreenHeight", () => {
    it("returns a positive number", () => {
      const height = getScreenHeight();

      expect(typeof height).toBe("number");
      expect(height).toBeGreaterThan(0);
    });
  });

  //#endregion

  //#region Pixel Ratio

  describe("getPixelRatio", () => {
    it("returns a positive number", () => {
      const ratio = getPixelRatio();

      expect(typeof ratio).toBe("number");
      expect(ratio).toBeGreaterThan(0);
    });
  });

  describe("getFontScale", () => {
    it("returns a positive number", () => {
      const scale = getFontScale();

      expect(typeof scale).toBe("number");
      expect(scale).toBeGreaterThan(0);
    });
  });

  describe("getPixelSizeForLayoutSize", () => {
    it("converts layout size to pixel size", () => {
      const layoutSize = 10;
      const pixelSize = getPixelSizeForLayoutSize(layoutSize);

      expect(typeof pixelSize).toBe("number");
      expect(pixelSize).toBeGreaterThanOrEqual(layoutSize);
    });
  });

  describe("roundToNearestPixel", () => {
    it("returns a number", () => {
      const result = roundToNearestPixel(10.3);

      expect(typeof result).toBe("number");
    });
  });

  //#endregion

  //#region Device Type

  describe("isTablet", () => {
    it("returns a boolean", () => {
      expect(typeof isTablet()).toBe("boolean");
    });
  });

  describe("isPhone", () => {
    it("returns a boolean", () => {
      expect(typeof isPhone()).toBe("boolean");
    });
  });

  describe("isPhysicalDevice", () => {
    it("returns a boolean", () => {
      expect(typeof isPhysicalDevice()).toBe("boolean");
    });
  });

  describe("getDeviceType", () => {
    it("returns a valid device type string", () => {
      const deviceType = getDeviceType();
      const validTypes = ["unknown", "phone", "tablet", "tv", "desktop"];

      expect(validTypes).toContain(deviceType);
    });
  });

  describe("getDeviceTypeAsync", () => {
    it("resolves to a valid device type string", async () => {
      const deviceType = await getDeviceTypeAsync();
      const validTypes = ["unknown", "phone", "tablet", "tv", "desktop"];

      expect(validTypes).toContain(deviceType);
    });
  });

  //#endregion

  //#region Device Info

  describe("getDeviceInfo", () => {
    it("returns object with device properties", () => {
      const info = getDeviceInfo();

      expect(info).toHaveProperty("brand");
      expect(info).toHaveProperty("manufacturer");
      expect(info).toHaveProperty("modelName");
      expect(info).toHaveProperty("osName");
      expect(info).toHaveProperty("osVersion");
      expect(info).toHaveProperty("isDevice");
    });
  });

  describe("getPlatform", () => {
    it("returns a valid platform string", () => {
      const platform = getPlatform();
      const validPlatforms = ["ios", "android", "web", "windows", "macos"];

      expect(validPlatforms).toContain(platform);
    });
  });

  describe("platform checks", () => {
    it("isIOS returns a boolean", () => {
      expect(typeof isIOS()).toBe("boolean");
    });

    it("isAndroid returns a boolean", () => {
      expect(typeof isAndroid()).toBe("boolean");
    });

    it("isWeb returns a boolean", () => {
      expect(typeof isWeb()).toBe("boolean");
    });
  });

  //#endregion

  //#region Safe Area

  describe("DEFAULT_SAFE_AREA_INSETS", () => {
    it("has all inset properties set to zero", () => {
      expect(DEFAULT_SAFE_AREA_INSETS).toEqual({
        top: 0,
        right: 0,
        bottom: 0,
        left: 0,
      });
    });
  });

  describe("getEstimatedSafeAreaInsets", () => {
    it("returns object with top, right, bottom, left", () => {
      const insets = getEstimatedSafeAreaInsets();

      expect(insets).toHaveProperty("top");
      expect(insets).toHaveProperty("right");
      expect(insets).toHaveProperty("bottom");
      expect(insets).toHaveProperty("left");
      expect(typeof insets.top).toBe("number");
      expect(typeof insets.bottom).toBe("number");
    });
  });

  //#endregion
});
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- device
```

### Type Check

```bash
pnpm --filter @retrievly/app tsc --noEmit
```

## Consolidation Notes

### Platform Detection Functions

`isIos()`, `isAndroid()`, `isWeb()` are **NOT redefined** in this file.
They are imported from `@/utils/platform` (T3.01) and re-exported for convenience.

This avoids:

- Duplicate function definitions
- Inconsistent implementations
- Multiple exports of the same functionality

```typescript
// DO NOT redefine:
// export function isIOS() { return Platform.OS === 'ios'; }

// DO re-export from canonical location:
export { isIos, isAndroid, isWeb } from "@/utils/platform";
```
