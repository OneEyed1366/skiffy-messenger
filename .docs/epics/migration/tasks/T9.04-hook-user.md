# T9.04: useUserQuery Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.04            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | high             |
| **Estimate** | 2h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-04       |
| **Updated**  | 2026-01-07       |

## Dependencies

| Task ID | Name        |
| ------- | ----------- |
| T7.01   | API Client  |
| T7.02   | QueryClient |
| T7.03   | Query Keys  |

## Blocks

| Task ID | Name                    |
| ------- | ----------------------- |
| T10c.xx | User avatar components  |
| T10c.xx | User mention components |

## Description

Create a TanStack Query hook to fetch and cache a user by ID. Uses automatic caching,
background refetch, and deduplication provided by TanStack Query.

**Architecture Note:** User data is server state (from REST API), so it uses TanStack Query,
not Zustand. See `.docs/architecture/state-management.md`.

## Source Analysis

- **Redux Selector**: `vendor/desktop/webapp/platform/client/src/selectors/entities/users.ts` - `getUser`
- **API Endpoint**: `GET /api/v4/users/{user_id}`

## Migration Target

- **Target File**: `apps/v2/src/hooks/useUserQuery/useUserQuery.ts`
- **Index Export**: `apps/v2/src/hooks/useUserQuery/index.ts`
- **Test File**: `apps/v2/src/hooks/useUserQuery/useUserQuery.spec.ts`

## Implementation

````typescript
// apps/v2/src/hooks/useUserQuery/useUserQuery.ts

import { useQuery, UseQueryOptions } from "@tanstack/react-query";
import { usersApi } from "@/api/users";
import { queryKeys } from "@/queries/keys";
import type { IUser } from "@/types";

//#region Types

type IUseUserQueryOptions = Omit<
  UseQueryOptions<IUser, Error>,
  "queryKey" | "queryFn"
> & {
  /** Skip the query (useful when userId is optional) */
  enabled?: boolean;
};

//#endregion Types

//#region Hook

/**
 * Fetches and caches a user by ID using TanStack Query.
 *
 * Benefits over Zustand + useEffect pattern:
 * - Automatic caching and deduplication
 * - Background refetch on focus/reconnect
 * - Loading/error states built-in
 * - No manual cache management
 *
 * @param userId - User ID to fetch (null/undefined skips query)
 * @param options - TanStack Query options
 * @returns Query result with data, isLoading, error, etc.
 *
 * @example
 * ```tsx
 * function UserProfile({ userId }: { userId: string }) {
 *   const { data: user, isLoading, error } = useUserQuery(userId);
 *
 *   if (isLoading) return <Spinner />;
 *   if (error) return <Error message={error.message} />;
 *   return <Text>{user.username}</Text>;
 * }
 * ```
 */
export function useUserQuery(
  userId: string | null | undefined,
  options?: IUseUserQueryOptions,
) {
  return useQuery({
    queryKey: queryKeys.users.detail(userId!),
    queryFn: () => usersApi.getUser(userId!),
    enabled: !!userId && (options?.enabled ?? true),
    staleTime: 1000 * 60, // 1 minute
    ...options,
  });
}

//#endregion Hook
````

## Index Export

```typescript
// apps/v2/src/hooks/useUserQuery/index.ts

export { useUserQuery } from "./useUserQuery";
```

## Acceptance Criteria

- [ ] Uses TanStack Query `useQuery` hook
- [ ] Query key uses `queryKeys.users.detail(userId)`
- [ ] Calls `usersApi.getUser(userId)` as queryFn
- [ ] Disabled when userId is null/undefined
- [ ] Returns standard TQ result: `{ data, isLoading, error, isError, isSuccess, ... }`
- [ ] 1 minute staleTime (matches other entity queries)
- [ ] TypeScript strict mode passes
- [ ] No `any` types
- [ ] Unit tests pass

## Testing

```typescript
// apps/v2/src/hooks/useUserQuery/useUserQuery.spec.ts

import { renderHook, waitFor } from "@testing-library/react-native";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useUserQuery } from "./useUserQuery";
import { usersApi } from "@/api/users";

//#region Mocks

jest.mock("@/api/users");

const mockUser = {
  id: "user-1",
  username: "testuser",
  email: "test@example.com",
  first_name: "Test",
  last_name: "User",
};

//#endregion Mocks

//#region Test Setup

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
    },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}

//#endregion Test Setup

//#region Tests

describe("useUserQuery", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it("fetches user by ID", async () => {
    (usersApi.getUser as jest.Mock).mockResolvedValue(mockUser);

    const { result } = renderHook(() => useUserQuery("user-1"), {
      wrapper: createWrapper(),
    });

    expect(result.current.isLoading).toBe(true);

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data).toEqual(mockUser);
    expect(usersApi.getUser).toHaveBeenCalledWith("user-1");
  });

  it("does not fetch when userId is null", () => {
    const { result } = renderHook(() => useUserQuery(null), {
      wrapper: createWrapper(),
    });

    expect(result.current.isLoading).toBe(false);
    expect(result.current.fetchStatus).toBe("idle");
    expect(usersApi.getUser).not.toHaveBeenCalled();
  });

  it("does not fetch when userId is undefined", () => {
    const { result } = renderHook(() => useUserQuery(undefined), {
      wrapper: createWrapper(),
    });

    expect(result.current.isLoading).toBe(false);
    expect(usersApi.getUser).not.toHaveBeenCalled();
  });

  it("handles API errors", async () => {
    const error = new Error("User not found");
    (usersApi.getUser as jest.Mock).mockRejectedValue(error);

    const { result } = renderHook(() => useUserQuery("user-1"), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isError).toBe(true);
    });

    expect(result.current.error).toBe(error);
  });

  it("respects enabled option", () => {
    const { result } = renderHook(
      () => useUserQuery("user-1", { enabled: false }),
      { wrapper: createWrapper() },
    );

    expect(result.current.fetchStatus).toBe("idle");
    expect(usersApi.getUser).not.toHaveBeenCalled();
  });
});

//#endregion Tests
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- useUserQuery
```

## Notes

- **No useEffect for data fetching** — TanStack Query handles this internally
- **Automatic deduplication** — Multiple components using same userId share one request
- **Background refetch** — Stale data refreshes on window focus/reconnect
- **Cache persistence** — User data cached for 5 min (gcTime) after last subscriber unmounts
- **WebSocket updates** — Real-time user updates flow through `users$` stream → TQ cache (T7.50)
