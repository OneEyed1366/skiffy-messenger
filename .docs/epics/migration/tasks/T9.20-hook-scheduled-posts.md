# T9.20: useScheduledPostsQuery Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.20            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | low              |
| **Estimate** | 2h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-06       |
| **Updated**  | 2026-01-07       |

## Dependencies

| Task ID | Name        |
| ------- | ----------- |
| T7.01   | API Client  |
| T7.02   | QueryClient |
| T7.03   | Query Keys  |

## Description

Create TanStack Query hooks to fetch and manage scheduled posts. Includes query hook
for listing and mutation hooks for create/update/delete operations.

**Architecture Note:** Scheduled posts are server state (from REST API), so this uses
TanStack Query. See `.docs/architecture/state-management.md`.

## Source Analysis

- **API**: `vendor/desktop/webapp/platform/client/src/client/scheduled_posts.ts`
- **API Endpoints**:
  - `GET /api/v4/users/{user_id}/scheduled_posts`
  - `POST /api/v4/scheduled_posts`
  - `PUT /api/v4/scheduled_posts/{post_id}`
  - `DELETE /api/v4/scheduled_posts/{post_id}`

## Migration Target

- **Target File**: `apps/v2/src/hooks/useScheduledPostsQuery/useScheduledPostsQuery.ts`
- **Index Export**: `apps/v2/src/hooks/useScheduledPostsQuery/index.ts`

## Implementation

```typescript
// apps/v2/src/hooks/useScheduledPostsQuery/useScheduledPostsQuery.ts

import {
  useQuery,
  useMutation,
  useQueryClient,
  UseQueryOptions,
} from "@tanstack/react-query";
import { scheduledPostsApi } from "@/api/scheduledPosts";
import { queryKeys } from "@/queries/keys";
import type {
  IScheduledPost,
  ICreateScheduledPostPayload,
  IUpdateScheduledPostPayload,
} from "@/types";

//#region Types

type IUseScheduledPostsQueryOptions = Omit<
  UseQueryOptions<IScheduledPost[], Error>,
  "queryKey" | "queryFn"
>;

//#endregion Types

//#region Query Hook

/**
 * Fetches and caches scheduled posts for the current user.
 *
 * @param channelId - Optional channel ID to filter by
 * @param options - TanStack Query options
 * @returns Query result with scheduled posts
 */
export function useScheduledPostsQuery(
  channelId?: string | null,
  options?: IUseScheduledPostsQueryOptions,
) {
  return useQuery({
    queryKey: queryKeys.posts.scheduled(channelId),
    queryFn: () =>
      scheduledPostsApi.getScheduledPosts({ channel_id: channelId }),
    select: (data) =>
      channelId ? data.filter((p) => p.channel_id === channelId) : data,
    staleTime: 1000 * 60, // 1 minute
    ...options,
  });
}

//#endregion Query Hook

//#region Mutation Hooks

/**
 * Mutation hook to create a scheduled post.
 */
export function useCreateScheduledPostMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (payload: ICreateScheduledPostPayload) =>
      scheduledPostsApi.createScheduledPost(payload),

    onSuccess: (newPost) => {
      queryClient.setQueryData<IScheduledPost[]>(
        queryKeys.posts.scheduled(null),
        (old) => (old ? [...old, newPost] : [newPost]),
      );
      // Also update channel-specific query if applicable
      if (newPost.channel_id) {
        queryClient.setQueryData<IScheduledPost[]>(
          queryKeys.posts.scheduled(newPost.channel_id),
          (old) => (old ? [...old, newPost] : [newPost]),
        );
      }
    },
  });
}

/**
 * Mutation hook to update a scheduled post.
 */
export function useUpdateScheduledPostMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      postId,
      updates,
    }: {
      postId: string;
      updates: IUpdateScheduledPostPayload;
    }) => scheduledPostsApi.updateScheduledPost(postId, updates),

    onSuccess: (updatedPost) => {
      // Update in all relevant queries
      queryClient.setQueryData<IScheduledPost[]>(
        queryKeys.posts.scheduled(null),
        (old) => old?.map((p) => (p.id === updatedPost.id ? updatedPost : p)),
      );
    },
  });
}

/**
 * Mutation hook to delete a scheduled post.
 */
export function useDeleteScheduledPostMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (postId: string) =>
      scheduledPostsApi.deleteScheduledPost(postId),

    onSuccess: (_, postId) => {
      queryClient.setQueryData<IScheduledPost[]>(
        queryKeys.posts.scheduled(null),
        (old) => old?.filter((p) => p.id !== postId),
      );
    },
  });
}

/**
 * Mutation hook to send a scheduled post immediately.
 */
export function useSendScheduledPostNowMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (postId: string) =>
      scheduledPostsApi.sendScheduledPostNow(postId),

    onSuccess: (_, postId) => {
      // Remove from scheduled posts list
      queryClient.setQueryData<IScheduledPost[]>(
        queryKeys.posts.scheduled(null),
        (old) => old?.filter((p) => p.id !== postId),
      );
      // Invalidate posts queries to show the newly sent post
      queryClient.invalidateQueries({ queryKey: queryKeys.posts.all });
    },
  });
}

//#endregion Mutation Hooks
```

## Index Export

```typescript
// apps/v2/src/hooks/useScheduledPostsQuery/index.ts

export {
  useScheduledPostsQuery,
  useCreateScheduledPostMutation,
  useUpdateScheduledPostMutation,
  useDeleteScheduledPostMutation,
  useSendScheduledPostNowMutation,
} from "./useScheduledPostsQuery";
```

## Acceptance Criteria

- [ ] Uses TanStack Query `useQuery` hook
- [ ] Query key uses `queryKeys.posts.scheduled(channelId)`
- [ ] Optionally filters by channelId using `select`
- [ ] Provides `useCreateScheduledPostMutation`
- [ ] Provides `useUpdateScheduledPostMutation`
- [ ] Provides `useDeleteScheduledPostMutation`
- [ ] Provides `useSendScheduledPostNowMutation`
- [ ] Mutations update cache optimistically
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/hooks/useScheduledPostsQuery/useScheduledPostsQuery.spec.ts

import { renderHook, waitFor } from "@testing-library/react-native";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useScheduledPostsQuery } from "./useScheduledPostsQuery";
import { scheduledPostsApi } from "@/api/scheduledPosts";

jest.mock("@/api/scheduledPosts");

const mockScheduledPosts = [
  {
    id: "sp-1",
    channel_id: "ch-1",
    message: "Scheduled message",
    scheduled_at: "2026-01-08T10:00:00Z",
  },
];

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}

describe("useScheduledPostsQuery", () => {
  it("fetches scheduled posts", async () => {
    (scheduledPostsApi.getScheduledPosts as jest.Mock).mockResolvedValue(
      mockScheduledPosts,
    );

    const { result } = renderHook(() => useScheduledPostsQuery(), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data).toEqual(mockScheduledPosts);
  });

  it("filters by channelId when provided", async () => {
    (scheduledPostsApi.getScheduledPosts as jest.Mock).mockResolvedValue([
      ...mockScheduledPosts,
      { id: "sp-2", channel_id: "ch-2", message: "Other channel" },
    ]);

    const { result } = renderHook(() => useScheduledPostsQuery("ch-1"), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data).toHaveLength(1);
    expect(result.current.data?.[0].channel_id).toBe("ch-1");
  });
});
```

## Notes

- **Optimistic updates** — Mutations update cache immediately for responsive UI
- **Cross-query updates** — Creating a scheduled post updates both filtered and unfiltered queries
