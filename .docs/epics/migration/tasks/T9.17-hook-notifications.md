# T9.17: useNotifications Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.17            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | high             |
| **Estimate** | 3h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-06       |
| **Updated**  | 2026-01-06       |

## Dependencies

| Task ID | Name             |
| ------- | ---------------- |
| T7.06   | preferencesStore |
| T9.16   | useWebSocket     |

## Description

Hook to manage push notification permissions, preferences, and local notifications display.

## Migration Target

- **Target File**: `apps/v2/src/hooks/useNotifications/useNotifications.ts`

## Implementation

```typescript
// apps/v2/src/hooks/useNotifications/useNotifications.ts

import { useEffect } from "react";
import { Platform } from "react-native";
import * as Notifications from "expo-notifications";
import { usePreferencesStore } from "@/stores";

//#region Types

type INotificationSettings = {
  enabled: boolean;
  mentions: boolean;
  directMessages: boolean;
  sound: boolean;
};

type IUseNotificationsReturn = {
  settings: INotificationSettings;
  permissionStatus: "granted" | "denied" | "undetermined";
  requestPermission: () => Promise<boolean>;
  updateSettings: (settings: Partial<INotificationSettings>) => Promise<void>;
  showLocalNotification: (title: string, body: string) => Promise<void>;
};

//#endregion

//#region Hook

export function useNotifications(): IUseNotificationsReturn {
  const settings = usePreferencesStore((state) => ({
    enabled: state.preferences["notifications--enabled"]?.value === "true",
    mentions: state.preferences["notifications--mentions"]?.value !== "false",
    directMessages: state.preferences["notifications--dm"]?.value !== "false",
    sound: state.preferences["notifications--sound"]?.value !== "false",
  }));

  const savePreference = usePreferencesStore((state) => state.savePreference);

  useEffect(() => {
    // Configure notification handler
    Notifications.setNotificationHandler({
      handleNotification: async () => ({
        shouldShowAlert: true,
        shouldPlaySound: settings.sound,
        shouldSetBadge: true,
      }),
    });
  }, [settings.sound]);

  const requestPermission = async (): Promise<boolean> => {
    if (Platform.OS === "web") return true;

    const { status } = await Notifications.requestPermissionsAsync();
    return status === "granted";
  };

  const updateSettings = async (
    newSettings: Partial<INotificationSettings>,
  ): Promise<void> => {
    if (newSettings.enabled !== undefined) {
      await savePreference({
        category: "notifications",
        name: "enabled",
        value: String(newSettings.enabled),
      });
    }
    if (newSettings.mentions !== undefined) {
      await savePreference({
        category: "notifications",
        name: "mentions",
        value: String(newSettings.mentions),
      });
    }
    // ... other settings
  };

  const showLocalNotification = async (
    title: string,
    body: string,
  ): Promise<void> => {
    if (!settings.enabled) return;

    await Notifications.scheduleNotificationAsync({
      content: { title, body },
      trigger: null, // Immediate
    });
  };

  return {
    settings,
    permissionStatus: "undetermined", // Would need async check
    requestPermission,
    updateSettings,
    showLocalNotification,
  };
}

//#endregion
```

## Acceptance Criteria

- [ ] Returns notification settings from preferences
- [ ] Provides permission request function
- [ ] Provides settings update function
- [ ] Provides local notification display
- [ ] Configures notification handler
- [ ] TypeScript strict mode passes
