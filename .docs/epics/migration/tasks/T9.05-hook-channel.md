# T9.05: useChannelQuery Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.05            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | high             |
| **Estimate** | 2h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-06       |
| **Updated**  | 2026-01-07       |

## Dependencies

| Task ID | Name        |
| ------- | ----------- |
| T7.01   | API Client  |
| T7.02   | QueryClient |
| T7.03   | Query Keys  |

## Blocks

| Task ID | Name                  |
| ------- | --------------------- |
| T10c.xx | Channel list, sidebar |

## Description

Create a TanStack Query hook to fetch and cache a channel by ID.

**Architecture Note:** Channel data is server state (from REST API), so it uses TanStack Query,
not Zustand. See `.docs/architecture/state-management.md`.

## Source Analysis

- **Redux Selector**: `vendor/desktop/webapp/platform/client/src/selectors/entities/channels.ts` - `getChannel`
- **API Endpoint**: `GET /api/v4/channels/{channel_id}`

## Migration Target

- **Target File**: `apps/v2/src/hooks/useChannelQuery/useChannelQuery.ts`
- **Index Export**: `apps/v2/src/hooks/useChannelQuery/index.ts`

## Implementation

````typescript
// apps/v2/src/hooks/useChannelQuery/useChannelQuery.ts

import { useQuery, UseQueryOptions } from "@tanstack/react-query";
import { channelsApi } from "@/api/channels";
import { queryKeys } from "@/queries/keys";
import type { IChannel } from "@/types";

//#region Types

type IUseChannelQueryOptions = Omit<
  UseQueryOptions<IChannel, Error>,
  "queryKey" | "queryFn"
>;

//#endregion Types

//#region Hook

/**
 * Fetches and caches a channel by ID using TanStack Query.
 *
 * @param channelId - Channel ID to fetch (null/undefined skips query)
 * @param options - TanStack Query options
 * @returns Query result with data, isLoading, error, etc.
 *
 * @example
 * ```tsx
 * function ChannelHeader({ channelId }: { channelId: string }) {
 *   const { data: channel, isLoading } = useChannelQuery(channelId);
 *
 *   if (isLoading) return <Spinner />;
 *   return <Text>{channel.display_name}</Text>;
 * }
 * ```
 */
export function useChannelQuery(
  channelId: string | null | undefined,
  options?: IUseChannelQueryOptions,
) {
  return useQuery({
    queryKey: queryKeys.channels.detail(channelId!),
    queryFn: () => channelsApi.getChannel(channelId!),
    enabled: !!channelId && (options?.enabled ?? true),
    staleTime: 1000 * 60, // 1 minute
    ...options,
  });
}

//#endregion Hook
````

## Index Export

```typescript
// apps/v2/src/hooks/useChannelQuery/index.ts

export { useChannelQuery } from "./useChannelQuery";
```

## Acceptance Criteria

- [ ] Uses TanStack Query `useQuery` hook
- [ ] Query key uses `queryKeys.channels.detail(channelId)`
- [ ] Calls `channelsApi.getChannel(channelId)` as queryFn
- [ ] Disabled when channelId is null/undefined
- [ ] Returns standard TQ result: `{ data, isLoading, error, ... }`
- [ ] TypeScript strict mode passes
- [ ] No `any` types

## Testing

```typescript
// apps/v2/src/hooks/useChannelQuery/useChannelQuery.spec.ts

import { renderHook, waitFor } from "@testing-library/react-native";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useChannelQuery } from "./useChannelQuery";
import { channelsApi } from "@/api/channels";

jest.mock("@/api/channels");

const mockChannel = {
  id: "ch-1",
  name: "general",
  display_name: "General",
  type: "O",
  team_id: "team-1",
};

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}

describe("useChannelQuery", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it("fetches channel by ID", async () => {
    (channelsApi.getChannel as jest.Mock).mockResolvedValue(mockChannel);

    const { result } = renderHook(() => useChannelQuery("ch-1"), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data).toEqual(mockChannel);
  });

  it("does not fetch when channelId is null", () => {
    const { result } = renderHook(() => useChannelQuery(null), {
      wrapper: createWrapper(),
    });

    expect(result.current.fetchStatus).toBe("idle");
    expect(channelsApi.getChannel).not.toHaveBeenCalled();
  });
});
```

## Notes

- **WebSocket updates** — Real-time channel updates flow through `channels$` stream → TQ cache (T7.50)
- **Related hooks** — See `useChannelMembersQuery`, `useChannelStatsQuery` for channel sub-resources
