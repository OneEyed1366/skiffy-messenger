# T6.19: TextArea Component

## Metadata

| Field        | Value              |
| ------------ | ------------------ |
| **ID**       | T6.19              |
| **Layer**    | L6 - UI Components |
| **Status**   | pending            |
| **Priority** | medium             |
| **Estimate** | 2.5h               |
| **Parallel** | true               |
| **Assignee** | -                  |
| **Created**  | 2026-01-06         |
| **Updated**  | 2026-01-06         |

## Dependencies

| Task ID | Name      |
| ------- | --------- |
| T6.07   | TextInput |

## Blocks

| Task ID | Name                       |
| ------- | -------------------------- |
| T10b.\* | Post composer, edit modals |

## Description

Create a TextArea component for multi-line text input. Extends the TextInput patterns with auto-grow capability, character count display, and configurable min/max heights. Primary use case is the message composer.

Features:

- Multi-line input with auto-grow
- Min/max height constraints
- Character count with limit warning
- Placeholder text with i18n support
- Error state styling
- Disabled state
- onSubmit handler for keyboard submit

## Source Files

- `vendor/desktop/webapp/channels/src/components/textbox/textbox.tsx`
- `vendor/desktop/webapp/channels/src/components/advanced_text_editor/advanced_text_editor.tsx`
- `vendor/desktop/webapp/channels/src/sass/components/_textbox.scss`

### Source Analysis

The original implementation uses:

- **textarea element**: With auto-resize on input
- **Height calculation**: Based on scrollHeight
- **Character limit**: Visual warning at threshold
- **Submit on Enter**: Ctrl/Cmd+Enter for submit

## Migration Target

- **Target File**: `apps/v2/src/components/TextArea/TextArea.tsx`
- **Index Export**: `apps/v2/src/components/TextArea/index.ts`

## Implementation

```typescript
// apps/v2/src/components/TextArea/TextArea.tsx

import { useState } from "react";
import {
  TextInput,
  View,
  Text,
  NativeSyntheticEvent,
  TextInputContentSizeChangeEventData,
  TextInputKeyPressEventData,
  Platform,
} from "react-native";
import { StyleSheet, UnistylesVariants } from "react-native-unistyles";
import { useTranslation } from "react-i18next";

//#region Types

type IProps = {
  /**
   * Current value
   */
  value: string;
  /**
   * Change handler
   */
  onChangeText: (text: string) => void;
  /**
   * Submit handler (Ctrl/Cmd+Enter on desktop, or button on mobile)
   */
  onSubmit?: () => void;
  /**
   * Placeholder i18n key
   */
  placeholderKey?: string;
  /**
   * Direct placeholder text
   */
  placeholder?: string;
  /**
   * Maximum character limit
   */
  maxLength?: number;
  /**
   * Show character count
   * @default false
   */
  showCharacterCount?: boolean;
  /**
   * Warning threshold percentage for character count (0-1)
   * @default 0.9
   */
  warningThreshold?: number;
  /**
   * Minimum height in pixels
   * @default 80
   */
  minHeight?: number;
  /**
   * Maximum height in pixels (auto-grow stops here)
   * @default 200
   */
  maxHeight?: number;
  /**
   * Error state
   * @default false
   */
  error?: boolean;
  /**
   * Error message to display
   */
  errorMessage?: string;
  /**
   * Disabled state
   * @default false
   */
  disabled?: boolean;
  /**
   * Auto focus on mount
   * @default false
   */
  autoFocus?: boolean;
  /**
   * Ref to underlying TextInput
   */
  ref?: React.Ref<React.ComponentRef<typeof TextInput>>;
  /**
   * Test ID
   */
  testID?: string;
} & UnistylesVariants<typeof styles>;

//#endregion Types

//#region Component

export function TextArea({
  value,
  onChangeText,
  onSubmit,
  placeholderKey,
  placeholder,
  maxLength,
  showCharacterCount = false,
  warningThreshold = 0.9,
  minHeight = 80,
  maxHeight = 200,
  error = false,
  errorMessage,
  disabled = false,
  autoFocus = false,
  ref,
  testID,
}: IProps) {
  const { t } = useTranslation();
  const [height, setHeight] = useState(minHeight);

  styles.useVariants({ error, disabled });

  const placeholderText = placeholderKey ? t(placeholderKey) : placeholder;
  const characterCount = value.length;
  const isNearLimit = maxLength
    ? characterCount >= maxLength * warningThreshold
    : false;
  const isAtLimit = maxLength ? characterCount >= maxLength : false;

  const handleContentSizeChange = (
    e: NativeSyntheticEvent<TextInputContentSizeChangeEventData>
  ) => {
    const contentHeight = e.nativeEvent.contentSize.height;
    const newHeight = Math.min(Math.max(contentHeight, minHeight), maxHeight);
    setHeight(newHeight);
  };

  const handleKeyPress = (
    e: NativeSyntheticEvent<TextInputKeyPressEventData>
  ) => {
    // Desktop: Ctrl/Cmd+Enter to submit
    if (Platform.OS === "web" || Platform.OS === "macos" || Platform.OS === "windows") {
      const nativeEvent = e.nativeEvent as TextInputKeyPressEventData & {
        ctrlKey?: boolean;
        metaKey?: boolean;
      };

      if (
        nativeEvent.key === "Enter" &&
        (nativeEvent.ctrlKey || nativeEvent.metaKey)
      ) {
        e.preventDefault?.();
        onSubmit?.();
      }
    }
  };

  return (
    <View style={styles.container} testID={testID}>
      <TextInput
        ref={ref}
        style={[styles.input, { height }]}
        value={value}
        onChangeText={onChangeText}
        onContentSizeChange={handleContentSizeChange}
        onKeyPress={handleKeyPress}
        placeholder={placeholderText}
        placeholderTextColor={styles.placeholder.color}
        maxLength={maxLength}
        multiline
        editable={!disabled}
        autoFocus={autoFocus}
        textAlignVertical="top"
        accessibilityLabel={placeholderText}
        accessibilityState={{ disabled }}
        testID={testID ? `${testID}-input` : undefined}
      />

      {(showCharacterCount || errorMessage) && (
        <View style={styles.footer}>
          {errorMessage && <Text style={styles.errorText}>{errorMessage}</Text>}

          {showCharacterCount && maxLength && (
            <Text
              style={[
                styles.characterCount,
                isNearLimit && styles.characterCountWarning,
                isAtLimit && styles.characterCountError,
              ]}
            >
              {characterCount}/{maxLength}
            </Text>
          )}
        </View>
      )}
    </View>
  );
}

//#endregion Component

//#region Styles

const styles = StyleSheet.create((theme) => ({
  container: {
    width: "100%",
  },

  input: {
    fontFamily: theme.fonts.primary,
    fontSize: 14,
    lineHeight: 20,
    color: theme.colors.centerChannelColor,
    backgroundColor: theme.colors.centerChannelBg,
    borderWidth: 1,
    borderColor: `${theme.colors.centerChannelColor}24`, // 14% opacity
    borderRadius: theme.radius.m,
    paddingHorizontal: theme.gap(1.5), // 12px
    paddingVertical: theme.gap(1), // 8px
    variants: {
      error: {
        true: {
          borderColor: theme.colors.errorText,
        },
        false: {},
      },
      disabled: {
        true: {
          opacity: 0.56,
          backgroundColor: `${theme.colors.centerChannelColor}08`, // 3% opacity
        },
        false: {},
      },
    },
  },

  placeholder: {
    color: `${theme.colors.centerChannelColor}56`, // 34% opacity
  },

  footer: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    marginTop: theme.gap(0.5), // 4px
    paddingHorizontal: theme.gap(0.5), // 4px
  },

  errorText: {
    fontFamily: theme.fonts.primary,
    fontSize: 12,
    color: theme.colors.errorText,
    flex: 1,
  },

  characterCount: {
    fontFamily: theme.fonts.primary,
    fontSize: 12,
    color: `${theme.colors.centerChannelColor}56`, // 34% opacity
    marginLeft: "auto",
  },

  characterCountWarning: {
    color: theme.colors.awayIndicator, // Yellow/orange
  },

  characterCountError: {
    color: theme.colors.errorText,
  },
}));

//#endregion Styles
```

## Index Export

```typescript
// apps/v2/src/components/TextArea/index.ts

export { TextArea } from "./TextArea";
```

## Acceptance Criteria

- [ ] Multi-line text input with controlled value
- [ ] Auto-grow between minHeight and maxHeight
- [ ] Character count display with optional limit
- [ ] Warning color at configurable threshold
- [ ] Error state with message display
- [ ] Disabled state with visual feedback
- [ ] Ctrl/Cmd+Enter submit on desktop platforms
- [ ] i18n support for placeholder
- [ ] Uses Unistyles variants (not conditional styles)
- [ ] All types use `I` prefix naming convention
- [ ] No `forwardRef` (React 19 ref prop)
- [ ] TypeScript strict mode passes
- [ ] No `any` types

## Testing

```typescript
// apps/v2/src/components/TextArea/TextArea.spec.tsx

import { render, fireEvent } from "@testing-library/react-native";
import { TextArea } from "./TextArea";

//#region Rendering Tests

describe("<TextArea />", () => {
  describe("rendering", () => {
    it("renders with value", () => {
      const { getByDisplayValue } = render(
        <TextArea value="Hello" onChangeText={jest.fn()} />
      );
      expect(getByDisplayValue("Hello")).toBeTruthy();
    });

    it("renders with placeholder", () => {
      const { getByPlaceholderText } = render(
        <TextArea value="" onChangeText={jest.fn()} placeholder="Type here" />
      );
      expect(getByPlaceholderText("Type here")).toBeTruthy();
    });

    it("renders with placeholderKey (i18n)", () => {
      const { getByPlaceholderText } = render(
        <TextArea value="" onChangeText={jest.fn()} placeholderKey="input.placeholder" />
      );
      // Assumes i18n mock returns "Enter text"
      expect(getByPlaceholderText("Enter text")).toBeTruthy();
    });

    it("renders with testID", () => {
      const { getByTestId } = render(
        <TextArea value="" onChangeText={jest.fn()} testID="textarea" />
      );
      expect(getByTestId("textarea")).toBeTruthy();
    });
  });

  //#endregion Rendering Tests

  //#region Interaction Tests

  describe("interactions", () => {
    it("calls onChangeText when text changes", () => {
      const onChangeText = jest.fn();
      const { getByDisplayValue } = render(
        <TextArea value="Hello" onChangeText={onChangeText} />
      );

      fireEvent.changeText(getByDisplayValue("Hello"), "Hello World");
      expect(onChangeText).toHaveBeenCalledWith("Hello World");
    });

    it("does not allow input when disabled", () => {
      const onChangeText = jest.fn();
      const { getByDisplayValue } = render(
        <TextArea value="Hello" onChangeText={onChangeText} disabled />
      );

      const input = getByDisplayValue("Hello");
      expect(input.props.editable).toBe(false);
    });
  });

  //#endregion Interaction Tests

  //#region Character Count Tests

  describe("character count", () => {
    it("shows character count when enabled", () => {
      const { getByText } = render(
        <TextArea
          value="Hello"
          onChangeText={jest.fn()}
          showCharacterCount
          maxLength={100}
        />
      );
      expect(getByText("5/100")).toBeTruthy();
    });

    it("does not show character count when disabled", () => {
      const { queryByText } = render(
        <TextArea
          value="Hello"
          onChangeText={jest.fn()}
          showCharacterCount={false}
          maxLength={100}
        />
      );
      expect(queryByText(/\/100/)).toBeNull();
    });

    it("enforces maxLength", () => {
      const { getByDisplayValue } = render(
        <TextArea value="Hello" onChangeText={jest.fn()} maxLength={10} />
      );
      expect(getByDisplayValue("Hello").props.maxLength).toBe(10);
    });
  });

  //#endregion Character Count Tests

  //#region Error State Tests

  describe("error state", () => {
    it("displays error message", () => {
      const { getByText } = render(
        <TextArea
          value=""
          onChangeText={jest.fn()}
          error
          errorMessage="This field is required"
        />
      );
      expect(getByText("This field is required")).toBeTruthy();
    });
  });

  //#endregion Error State Tests

  //#region Accessibility Tests

  describe("accessibility", () => {
    it("uses placeholder as accessibility label", () => {
      const { getByLabelText } = render(
        <TextArea value="" onChangeText={jest.fn()} placeholder="Message" />
      );
      expect(getByLabelText("Message")).toBeTruthy();
    });

    it("has disabled accessibility state when disabled", () => {
      const { getByDisplayValue } = render(
        <TextArea value="Test" onChangeText={jest.fn()} disabled />
      );
      expect(getByDisplayValue("Test").props.accessibilityState.disabled).toBe(
        true
      );
    });
  });

  //#endregion Accessibility Tests
});
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- TextArea
```

## Storybook

```typescript
// apps/v2/src/components/TextArea/TextArea.stories.tsx

import type { Meta, StoryObj } from "@storybook/react";
import { useState } from "react";
import { View } from "react-native";
import { TextArea } from "./TextArea";

const meta: Meta<typeof TextArea> = {
  title: "Components/TextArea",
  component: TextArea,
  argTypes: {
    showCharacterCount: { control: "boolean" },
    error: { control: "boolean" },
    disabled: { control: "boolean" },
    maxLength: { control: { type: "number", min: 10, max: 1000 } },
    minHeight: { control: { type: "number", min: 40, max: 200 } },
    maxHeight: { control: { type: "number", min: 100, max: 500 } },
  },
  decorators: [
    (Story) => (
      <View style={{ padding: 16, maxWidth: 400 }}>
        <Story />
      </View>
    ),
  ],
};

export default meta;
type Story = StoryObj<typeof TextArea>;

//#region Controlled Component Wrapper

const ControlledTextArea = (props: Omit<React.ComponentProps<typeof TextArea>, "value" | "onChangeText">) => {
  const [value, setValue] = useState("");
  return <TextArea {...props} value={value} onChangeText={setValue} />;
};

//#endregion Controlled Component Wrapper

//#region Basic Stories

export const Default: Story = {
  render: () => <ControlledTextArea placeholder="Type your message..." />,
};

export const WithCharacterCount: Story = {
  render: () => (
    <ControlledTextArea
      placeholder="Type your message..."
      showCharacterCount
      maxLength={280}
    />
  ),
};

export const WithError: Story = {
  render: () => (
    <ControlledTextArea
      placeholder="Type your message..."
      error
      errorMessage="Message cannot be empty"
    />
  ),
};

export const Disabled: Story = {
  render: () => (
    <TextArea
      value="This textarea is disabled"
      onChangeText={() => {}}
      disabled
    />
  ),
};

//#endregion Basic Stories

//#region Configuration Stories

export const CustomHeight: Story = {
  render: () => (
    <ControlledTextArea
      placeholder="This has custom min/max height..."
      minHeight={120}
      maxHeight={300}
    />
  ),
};

export const NearLimit: Story = {
  render: () => (
    <TextArea
      value={"A".repeat(250)}
      onChangeText={() => {}}
      showCharacterCount
      maxLength={280}
    />
  ),
};

export const AtLimit: Story = {
  render: () => (
    <TextArea
      value={"A".repeat(280)}
      onChangeText={() => {}}
      showCharacterCount
      maxLength={280}
    />
  ),
};

//#endregion Configuration Stories
```
