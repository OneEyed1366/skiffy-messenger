# T7.50: WebSocket Subscriptions

## Metadata

| Field        | Value                 |
| ------------ | --------------------- |
| **ID**       | T7.50                 |
| **Layer**    | L7 - State Management |
| **Status**   | pending               |
| **Priority** | high                  |
| **Estimate** | 4h                    |
| **Parallel** | false                 |
| **Assignee** | -                     |
| **Created**  | 2026-01-06            |
| **Updated**  | 2026-01-06            |

## Dependencies

| Task ID | Name              |
| ------- | ----------------- |
| T7.02   | query-client      |
| T7.03   | query-keys        |
| T7.30   | connection-store  |
| T7.31   | typing-store      |
| T8.01   | websocket-service |
| T8.02   | websocket-events  |

## Blocks

| Task ID | Name           |
| ------- | -------------- |
| T7.51   | State Provider |

## Description

Connect RxJS WebSocket event streams to TanStack Query cache and Zustand stores for real-time updates.

**Reference:** See [State Management Architecture](../../../architecture/state-management.md#websocket-to-cache-sync) for full implementation.

## Target Files

- `apps/v2/src/services/websocket/subscriptions.ts`

## Event → Target Mapping

| RxJS Stream  | Target         | Update Type             |
| ------------ | -------------- | ----------------------- |
| `posts$`     | TanStack Query | setQueryData            |
| `typing$`    | Zustand store  | getState().setTyping    |
| `presence$`  | Zustand store  | getState().setStatus    |
| `reactions$` | TanStack Query | setQueryData            |
| `channels$`  | TanStack Query | setQueryData/invalidate |
| `users$`     | TanStack Query | setQueryData            |
| `threads$`   | TanStack Query | setQueryData            |

## Key Function

```typescript
export function initWebSocketSubscriptions(queryClient: QueryClient): () => void {
  const subscriptions: Array<{ unsubscribe: () => void }> = [];

  // Posts → TanStack Query cache
  subscriptions.push(posts$.subscribe((events) => {
    events.forEach((event) => {
      switch (event.event) {
        case "posted":
          queryClient.setQueryData(queryKeys.posts.list(event.data.channel_id), ...);
          break;
        case "post_edited":
          queryClient.setQueryData(queryKeys.posts.detail(event.data.post.id), ...);
          break;
        case "post_deleted":
          queryClient.setQueryData(queryKeys.posts.list(event.data.channel_id), ...);
          break;
      }
    });
  }));

  // Typing → Zustand store
  subscriptions.push(typing$.subscribe((event) => {
    useTypingStore.getState().setTyping(event.channelId, { ... }, event.isTyping);
  }));

  // Return cleanup function
  return () => subscriptions.forEach(s => s.unsubscribe());
}
```

## Acceptance Criteria

- [ ] Posts events update TanStack Query cache
- [ ] Typing events update Zustand store
- [ ] Presence events update Zustand store
- [ ] Reaction events update post cache
- [ ] Channel events invalidate channel queries
- [ ] Returns cleanup function for unmount
- [ ] No memory leaks (proper unsubscribe)
