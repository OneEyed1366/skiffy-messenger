# T6.18: AvatarGroup Component

## Metadata

| Field        | Value              |
| ------------ | ------------------ |
| **ID**       | T6.18              |
| **Layer**    | L6 - UI Components |
| **Status**   | pending            |
| **Priority** | medium             |
| **Estimate** | 2h                 |
| **Parallel** | true               |
| **Assignee** | -                  |
| **Created**  | 2026-01-06         |
| **Updated**  | 2026-01-06         |

## Dependencies

| Task ID | Name   |
| ------- | ------ |
| T6.01   | Avatar |

## Blocks

| Task ID | Name                                 |
| ------- | ------------------------------------ |
| T10b.\* | Thread participants, channel members |

## Description

Create an AvatarGroup component that displays multiple Avatar components in an overlapping stack. Used to show participants in threads, channels, or any context where multiple users need to be displayed compactly.

Features:

- Configurable max visible avatars (overflow shows "+N" indicator)
- Stacking direction (left-to-right or right-to-left)
- Size variants matching Avatar sizes
- Overlap amount configuration
- Accessible announcement of total count

## Source Files

- `vendor/desktop/webapp/channels/src/components/threading/global_threads/thread_item/avatars/avatars.tsx`
- `vendor/desktop/webapp/channels/src/components/post_view/reaction/reaction.tsx` (avatar stacking pattern)

### Source Analysis

The original implementation uses:

- **Inline styles**: For negative margins to create overlap
- **z-index stacking**: Later avatars on top or bottom based on direction
- **Overflow badge**: Simple div with count when exceeding max

## Migration Target

- **Target File**: `apps/v2/src/components/AvatarGroup/AvatarGroup.tsx`
- **Index Export**: `apps/v2/src/components/AvatarGroup/index.ts`

## Implementation

```typescript
// apps/v2/src/components/AvatarGroup/AvatarGroup.tsx

import { View, Text } from "react-native";
import { StyleSheet, UnistylesVariants } from "react-native-unistyles";
import { Avatar } from "@/components/Avatar";

//#region Types

type IAvatarGroupSize = "xs" | "sm" | "md" | "lg";

type IAvatarData = {
  id: string;
  imageUrl?: string;
  name: string;
  status?: "online" | "away" | "offline" | "dnd";
};

type IProps = {
  /**
   * Array of avatar data objects
   */
  avatars: IAvatarData[];
  /**
   * Maximum avatars to show before overflow
   * @default 3
   */
  max?: number;
  /**
   * Avatar size
   * @default "md"
   */
  size?: IAvatarGroupSize;
  /**
   * Stacking direction
   * @default "left"
   */
  stackDirection?: "left" | "right";
  /**
   * Show status indicators on avatars
   * @default false
   */
  showStatus?: boolean;
  /**
   * Overlap amount as percentage of avatar size
   * @default 0.25
   */
  overlapRatio?: number;
  /**
   * Test ID
   */
  testID?: string;
} & UnistylesVariants<typeof styles>;

//#endregion Types

//#region Constants

const SIZE_MAP: Record<IAvatarGroupSize, number> = {
  xs: 20,
  sm: 24,
  md: 32,
  lg: 40,
};

//#endregion Constants

//#region Component

export function AvatarGroup({
  avatars,
  max = 3,
  size = "md",
  stackDirection = "left",
  showStatus = false,
  overlapRatio = 0.25,
  testID,
}: IProps) {
  styles.useVariants({ size });

  const visibleAvatars = avatars.slice(0, max);
  const overflowCount = avatars.length - max;
  const avatarSize = SIZE_MAP[size];
  const overlapOffset = -avatarSize * overlapRatio;

  const accessibilityLabel = `${avatars.length} participant${avatars.length !== 1 ? "s" : ""}${
    overflowCount > 0 ? `, showing ${max}` : ""
  }`;

  return (
    <View
      style={styles.container}
      testID={testID}
      accessibilityLabel={accessibilityLabel}
      accessibilityRole="text"
    >
      {visibleAvatars.map((avatar, index) => {
        const isFirst = index === 0;
        const zIndex =
          stackDirection === "left"
            ? visibleAvatars.length - index
            : index + 1;

        return (
          <View
            key={avatar.id}
            style={[
              styles.avatarWrapper,
              { zIndex },
              !isFirst && { marginLeft: overlapOffset },
            ]}
          >
            <Avatar
              imageUrl={avatar.imageUrl}
              name={avatar.name}
              size={size}
              status={showStatus ? avatar.status : undefined}
              showBorder
            />
          </View>
        );
      })}

      {overflowCount > 0 && (
        <View
          style={[
            styles.overflowBadge,
            { marginLeft: overlapOffset, zIndex: max + 1 },
          ]}
        >
          <Text style={styles.overflowText}>+{overflowCount}</Text>
        </View>
      )}
    </View>
  );
}

//#endregion Component

//#region Styles

const styles = StyleSheet.create((theme) => ({
  container: {
    flexDirection: "row",
    alignItems: "center",
  },

  avatarWrapper: {
    borderRadius: 999,
    borderWidth: 2,
    borderColor: theme.colors.centerChannelBg,
  },

  overflowBadge: {
    alignItems: "center",
    justifyContent: "center",
    borderRadius: 999,
    backgroundColor: theme.colors.centerChannelColor,
    opacity: 0.16,
    borderWidth: 2,
    borderColor: theme.colors.centerChannelBg,
    variants: {
      size: {
        xs: { width: 20, height: 20 },
        sm: { width: 24, height: 24 },
        md: { width: 32, height: 32 },
        lg: { width: 40, height: 40 },
      },
    },
  },

  overflowText: {
    fontFamily: theme.fonts.primary,
    fontWeight: theme.fontWeights.semiBold,
    color: theme.colors.centerChannelColor,
    variants: {
      size: {
        xs: { fontSize: 8 },
        sm: { fontSize: 10 },
        md: { fontSize: 12 },
        lg: { fontSize: 14 },
      },
    },
  },
}));

//#endregion Styles
```

## Index Export

```typescript
// apps/v2/src/components/AvatarGroup/index.ts

export { AvatarGroup } from "./AvatarGroup";
```

## Acceptance Criteria

- [ ] Renders multiple avatars in overlapping stack
- [ ] Respects max prop and shows overflow indicator
- [ ] Supports 4 sizes: xs, sm, md, lg
- [ ] Supports left and right stacking direction
- [ ] Configurable overlap amount
- [ ] Optional status indicators on avatars
- [ ] Accessible announcement of total participant count
- [ ] Uses Unistyles variants (not conditional styles)
- [ ] All types use `I` prefix naming convention
- [ ] TypeScript strict mode passes
- [ ] No `any` types

## Testing

```typescript
// apps/v2/src/components/AvatarGroup/AvatarGroup.spec.tsx

import { render } from "@testing-library/react-native";
import { AvatarGroup } from "./AvatarGroup";

const mockAvatars = [
  { id: "1", name: "Alice", imageUrl: "https://example.com/alice.jpg" },
  { id: "2", name: "Bob", imageUrl: "https://example.com/bob.jpg" },
  { id: "3", name: "Charlie", imageUrl: "https://example.com/charlie.jpg" },
  { id: "4", name: "Diana", imageUrl: "https://example.com/diana.jpg" },
  { id: "5", name: "Eve", imageUrl: "https://example.com/eve.jpg" },
];

//#region Rendering Tests

describe("<AvatarGroup />", () => {
  describe("rendering", () => {
    it("renders avatars up to max", () => {
      const { getAllByRole } = render(
        <AvatarGroup avatars={mockAvatars} max={3} />
      );
      // Should show 3 avatars + overflow badge
      expect(getAllByRole("image").length).toBe(3);
    });

    it("renders overflow count when exceeding max", () => {
      const { getByText } = render(
        <AvatarGroup avatars={mockAvatars} max={3} />
      );
      expect(getByText("+2")).toBeTruthy();
    });

    it("does not show overflow when avatars <= max", () => {
      const { queryByText } = render(
        <AvatarGroup avatars={mockAvatars.slice(0, 2)} max={3} />
      );
      expect(queryByText(/\+/)).toBeNull();
    });

    it("renders with testID", () => {
      const { getByTestId } = render(
        <AvatarGroup
          avatars={mockAvatars}
          testID="avatar-group"
        />
      );
      expect(getByTestId("avatar-group")).toBeTruthy();
    });
  });

  //#endregion Rendering Tests

  //#region Size Tests

  describe("sizes", () => {
    const sizes = ["xs", "sm", "md", "lg"] as const;

    sizes.forEach((size) => {
      it(`renders ${size} size`, () => {
        const { getAllByRole } = render(
          <AvatarGroup avatars={mockAvatars.slice(0, 2)} size={size} />
        );
        expect(getAllByRole("image").length).toBe(2);
      });
    });
  });

  //#endregion Size Tests

  //#region Configuration Tests

  describe("configuration", () => {
    it("respects max prop", () => {
      const { getAllByRole, getByText } = render(
        <AvatarGroup avatars={mockAvatars} max={2} />
      );
      expect(getAllByRole("image").length).toBe(2);
      expect(getByText("+3")).toBeTruthy();
    });

    it("renders all avatars when max >= avatars.length", () => {
      const { getAllByRole, queryByText } = render(
        <AvatarGroup avatars={mockAvatars} max={10} />
      );
      expect(getAllByRole("image").length).toBe(5);
      expect(queryByText(/\+/)).toBeNull();
    });
  });

  //#endregion Configuration Tests

  //#region Accessibility Tests

  describe("accessibility", () => {
    it("announces total participant count", () => {
      const { getByLabelText } = render(
        <AvatarGroup avatars={mockAvatars} max={3} />
      );
      expect(getByLabelText(/5 participants/)).toBeTruthy();
    });

    it("handles singular participant", () => {
      const { getByLabelText } = render(
        <AvatarGroup avatars={[mockAvatars[0]]} />
      );
      expect(getByLabelText(/1 participant[^s]/)).toBeTruthy();
    });
  });

  //#endregion Accessibility Tests

  //#region Empty State Tests

  describe("empty state", () => {
    it("renders nothing when avatars array is empty", () => {
      const { queryAllByRole } = render(<AvatarGroup avatars={[]} />);
      expect(queryAllByRole("image").length).toBe(0);
    });
  });

  //#endregion Empty State Tests
});
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- AvatarGroup
```

## Storybook

```typescript
// apps/v2/src/components/AvatarGroup/AvatarGroup.stories.tsx

import type { Meta, StoryObj } from "@storybook/react";
import { View } from "react-native";
import { AvatarGroup } from "./AvatarGroup";

const mockAvatars = [
  { id: "1", name: "Alice Johnson", status: "online" as const },
  { id: "2", name: "Bob Smith", status: "away" as const },
  { id: "3", name: "Charlie Brown", status: "offline" as const },
  { id: "4", name: "Diana Prince", status: "dnd" as const },
  { id: "5", name: "Eve Wilson", status: "online" as const },
  { id: "6", name: "Frank Miller" },
  { id: "7", name: "Grace Lee" },
];

const meta: Meta<typeof AvatarGroup> = {
  title: "Components/AvatarGroup",
  component: AvatarGroup,
  argTypes: {
    size: {
      control: "select",
      options: ["xs", "sm", "md", "lg"],
    },
    max: {
      control: { type: "number", min: 1, max: 10 },
    },
    stackDirection: {
      control: "select",
      options: ["left", "right"],
    },
    showStatus: { control: "boolean" },
    overlapRatio: {
      control: { type: "range", min: 0, max: 0.5, step: 0.05 },
    },
  },
  decorators: [
    (Story) => (
      <View style={{ padding: 16 }}>
        <Story />
      </View>
    ),
  ],
};

export default meta;
type Story = StoryObj<typeof AvatarGroup>;

//#region Basic Stories

export const Default: Story = {
  args: {
    avatars: mockAvatars.slice(0, 5),
    max: 3,
  },
};

export const NoOverflow: Story = {
  args: {
    avatars: mockAvatars.slice(0, 3),
    max: 5,
  },
};

export const WithStatus: Story = {
  args: {
    avatars: mockAvatars.slice(0, 4),
    max: 4,
    showStatus: true,
  },
};

//#endregion Basic Stories

//#region Size Stories

export const AllSizes: Story = {
  render: () => (
    <View style={{ gap: 16 }}>
      <AvatarGroup avatars={mockAvatars.slice(0, 4)} max={3} size="xs" />
      <AvatarGroup avatars={mockAvatars.slice(0, 4)} max={3} size="sm" />
      <AvatarGroup avatars={mockAvatars.slice(0, 4)} max={3} size="md" />
      <AvatarGroup avatars={mockAvatars.slice(0, 4)} max={3} size="lg" />
    </View>
  ),
};

//#endregion Size Stories

//#region Configuration Stories

export const HighOverflow: Story = {
  args: {
    avatars: mockAvatars,
    max: 2,
  },
};

export const TightOverlap: Story = {
  args: {
    avatars: mockAvatars.slice(0, 5),
    max: 5,
    overlapRatio: 0.4,
  },
};

export const LooseOverlap: Story = {
  args: {
    avatars: mockAvatars.slice(0, 5),
    max: 5,
    overlapRatio: 0.1,
  },
};

//#endregion Configuration Stories
```
