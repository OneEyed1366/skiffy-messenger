# T3.07: Haptic Feedback Utilities

## Metadata

| Field        | Value               |
| ------------ | ------------------- |
| **ID**       | T3.07               |
| **Layer**    | L3 - Platform Utils |
| **Status**   | pending             |
| **Priority** | low                 |
| **Estimate** | 1h                  |
| **Parallel** | true                |
| **Assignee** | -                   |
| **Created**  | 2026-01-07          |
| **Updated**  | 2026-01-07          |

## Dependencies

| Task ID | Name               |
| ------- | ------------------ |
| T3.01   | Platform Detection |

## Blocks

| Task ID | Name                 |
| ------- | -------------------- |
| T10a.\* | Button components    |
| T10b.\* | Interactive elements |
| T10c.\* | Gesture handlers     |

## Description

Create haptic feedback utilities for providing tactile responses to user interactions. This is a common mobile UX pattern not present in the Mattermost web codebase but essential for native mobile feel. Uses `expo-haptics` for cross-platform haptic feedback.

**Haptic Types:**

- **Impact**: Physical tap sensation (light/medium/heavy)
- **Notification**: Success/warning/error feedback patterns
- **Selection**: Subtle feedback for selection changes

**Platform Considerations:**

- **iOS**: Full Taptic Engine support (iPhone 7+), falls back gracefully on older devices
- **Android**: Vibration API, less nuanced than iOS but functional
- **Web**: Not supported (no-op)

## Source Files

- `expo-haptics` package documentation
- iOS Human Interface Guidelines (Haptics)
- Material Design Haptic Feedback guidelines

## Target File

`apps/v2/src/utils/haptics.ts`

## Implementation

````typescript
// apps/v2/src/utils/haptics.ts

/**
 * Haptic feedback utilities
 *
 * Provides tactile feedback for user interactions.
 * Uses expo-haptics for cross-platform support.
 *
 * Note: Haptics are no-op on web and gracefully degrade on unsupported devices.
 */

import * as Haptics from "expo-haptics";
import { Platform } from "react-native";

//#region Types

export type IImpactStyle = "light" | "medium" | "heavy";

export type INotificationStyle = "success" | "warning" | "error";

export type IHapticOptions = {
  /** Skip haptic if conditions aren't met */
  enabled?: boolean;
};

//#endregion

//#region Impact Feedback

/**
 * Trigger light impact haptic feedback.
 *
 * Use for subtle UI interactions like toggling switches,
 * tapping lightweight buttons, or hover states.
 *
 * @example
 * ```typescript
 * // On switch toggle
 * const handleToggle = async () => {
 *   await impactLight();
 *   setEnabled(!enabled);
 * };
 * ```
 */
export async function impactLight(): Promise<void> {
  if (Platform.OS === "web") {
    return;
  }

  try {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
  } catch (error) {
    // Silently fail - haptics are enhancement, not critical
    console.debug("Haptic feedback not available:", error);
  }
}

/**
 * Trigger medium impact haptic feedback.
 *
 * Use for standard button taps, confirming selections,
 * or moderate UI interactions.
 *
 * @example
 * ```typescript
 * // On button press
 * const handlePress = async () => {
 *   await impactMedium();
 *   submitForm();
 * };
 * ```
 */
export async function impactMedium(): Promise<void> {
  if (Platform.OS === "web") {
    return;
  }

  try {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
  } catch (error) {
    console.debug("Haptic feedback not available:", error);
  }
}

/**
 * Trigger heavy impact haptic feedback.
 *
 * Use for significant actions like completing a task,
 * major confirmations, or dropping items in drag-and-drop.
 *
 * @example
 * ```typescript
 * // On drag-and-drop release
 * const handleDrop = async () => {
 *   await impactHeavy();
 *   reorderItems(dragIndex, dropIndex);
 * };
 * ```
 */
export async function impactHeavy(): Promise<void> {
  if (Platform.OS === "web") {
    return;
  }

  try {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Heavy);
  } catch (error) {
    console.debug("Haptic feedback not available:", error);
  }
}

/**
 * Trigger impact haptic with specified style.
 *
 * @param style - Impact intensity: "light" | "medium" | "heavy"
 *
 * @example
 * ```typescript
 * await impact("medium");
 * ```
 */
export async function impact(style: IImpactStyle): Promise<void> {
  switch (style) {
    case "light":
      return impactLight();
    case "medium":
      return impactMedium();
    case "heavy":
      return impactHeavy();
  }
}

//#endregion

//#region Notification Feedback

/**
 * Trigger success notification haptic.
 *
 * Use when an operation completes successfully,
 * like saving data, sending a message, or completing a task.
 *
 * @example
 * ```typescript
 * const handleSave = async () => {
 *   await saveData();
 *   await notificationSuccess();
 *   showToast("Saved!");
 * };
 * ```
 */
export async function notificationSuccess(): Promise<void> {
  if (Platform.OS === "web") {
    return;
  }

  try {
    await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
  } catch (error) {
    console.debug("Haptic feedback not available:", error);
  }
}

/**
 * Trigger warning notification haptic.
 *
 * Use when alerting the user to a potential issue,
 * like unsaved changes, approaching limits, or caution states.
 *
 * @example
 * ```typescript
 * const handleNavigateAway = async () => {
 *   if (hasUnsavedChanges) {
 *     await notificationWarning();
 *     showConfirmDialog();
 *   }
 * };
 * ```
 */
export async function notificationWarning(): Promise<void> {
  if (Platform.OS === "web") {
    return;
  }

  try {
    await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Warning);
  } catch (error) {
    console.debug("Haptic feedback not available:", error);
  }
}

/**
 * Trigger error notification haptic.
 *
 * Use when an operation fails or an error occurs,
 * like validation failure, network error, or invalid input.
 *
 * @example
 * ```typescript
 * const handleSubmit = async () => {
 *   const errors = validate(form);
 *   if (errors.length > 0) {
 *     await notificationError();
 *     showErrors(errors);
 *     return;
 *   }
 *   submit();
 * };
 * ```
 */
export async function notificationError(): Promise<void> {
  if (Platform.OS === "web") {
    return;
  }

  try {
    await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
  } catch (error) {
    console.debug("Haptic feedback not available:", error);
  }
}

/**
 * Trigger notification haptic with specified type.
 *
 * @param type - Notification type: "success" | "warning" | "error"
 *
 * @example
 * ```typescript
 * await notification("success");
 * ```
 */
export async function notification(type: INotificationStyle): Promise<void> {
  switch (type) {
    case "success":
      return notificationSuccess();
    case "warning":
      return notificationWarning();
    case "error":
      return notificationError();
  }
}

//#endregion

//#region Selection Feedback

/**
 * Trigger selection change haptic.
 *
 * Use when the user changes a selection, like moving through
 * a picker, scrolling a carousel, or highlighting items.
 *
 * This is the subtlest haptic, appropriate for frequent interactions.
 *
 * @example
 * ```typescript
 * // In a picker
 * const handleValueChange = async (value: string) => {
 *   await selectionChanged();
 *   setSelectedValue(value);
 * };
 *
 * // In a carousel
 * const handleSlideChange = async (index: number) => {
 *   await selectionChanged();
 *   setCurrentSlide(index);
 * };
 * ```
 */
export async function selectionChanged(): Promise<void> {
  if (Platform.OS === "web") {
    return;
  }

  try {
    await Haptics.selectionAsync();
  } catch (error) {
    console.debug("Haptic feedback not available:", error);
  }
}

//#endregion

//#region Utility Functions

/**
 * Check if haptic feedback is supported on this device.
 *
 * Note: This is a best-effort check. Some Android devices
 * report support but have weak/no vibration motors.
 *
 * @returns true if haptics are likely supported
 */
export function isHapticsSupported(): boolean {
  // Web never supports haptics
  if (Platform.OS === "web") {
    return false;
  }

  // iOS and Android support haptics on most devices
  return Platform.OS === "ios" || Platform.OS === "android";
}

/**
 * Create a haptic-enabled press handler.
 *
 * Wraps a function to add haptic feedback before execution.
 * Useful for creating consistent button handlers.
 *
 * @param handler - Function to call after haptic
 * @param style - Impact style (default: "light")
 * @returns Wrapped function with haptic feedback
 *
 * @example
 * ```typescript
 * const handlePress = withHaptic(() => {
 *   navigation.navigate("Settings");
 * });
 *
 * const handleImportantPress = withHaptic(() => {
 *   submitOrder();
 * }, "medium");
 *
 * <Pressable onPress={handlePress}>
 *   <Text>Settings</Text>
 * </Pressable>
 * ```
 */
export function withHaptic<T extends (...args: unknown[]) => unknown>(
  handler: T,
  style: IImpactStyle = "light",
): (...args: Parameters<T>) => Promise<ReturnType<T>> {
  return async (...args: Parameters<T>): Promise<ReturnType<T>> => {
    await impact(style);
    return handler(...args) as ReturnType<T>;
  };
}

//#endregion
````

## Index Export

```typescript
// apps/v2/src/utils/index.ts

export {
  // Impact
  impactLight,
  impactMedium,
  impactHeavy,
  impact,
  // Notification
  notificationSuccess,
  notificationWarning,
  notificationError,
  notification,
  // Selection
  selectionChanged,
  // Utilities
  isHapticsSupported,
  withHaptic,
} from "./haptics";

export type {
  IImpactStyle,
  INotificationStyle,
  IHapticOptions,
} from "./haptics";
```

## Platform Considerations

| Feature               | iOS                     | Android            | Web    |
| --------------------- | ----------------------- | ------------------ | ------ |
| Impact feedback       | Taptic Engine           | Vibration API      | No-op  |
| Notification feedback | Distinct patterns       | Vibration patterns | No-op  |
| Selection feedback    | Subtle tap              | Short vibration    | No-op  |
| Device support        | iPhone 7+ (full)        | Most devices       | None   |
| Fallback              | Silent on older devices | Silent if no motor | Silent |

### iOS Specifics

- **Taptic Engine**: iPhone 7 and later have dedicated haptic hardware
- **Three impact levels**: Light, Medium, Heavy map to physical sensations
- **Notification patterns**: Success, Warning, Error have distinct patterns
- **Selection**: Very subtle, designed for high-frequency use

### Android Specifics

- **Vibration API**: Uses device vibration motor
- **Pattern mapping**: Impact levels map to vibration duration/intensity
- **Device variance**: Quality varies significantly across devices
- **Battery consideration**: Excessive haptics can drain battery

### Best Practices

1. **Don't overuse**: Haptics should enhance, not annoy
2. **Respect user settings**: Some users disable haptics system-wide
3. **Test on devices**: Simulators don't provide accurate haptic feedback
4. **Use appropriate levels**: Light for frequent, Heavy for significant actions

## Acceptance Criteria

- [ ] Uses `expo-haptics` package
- [ ] `impactLight()` triggers light impact feedback
- [ ] `impactMedium()` triggers medium impact feedback
- [ ] `impactHeavy()` triggers heavy impact feedback
- [ ] `notificationSuccess()` triggers success pattern
- [ ] `notificationWarning()` triggers warning pattern
- [ ] `notificationError()` triggers error pattern
- [ ] `selectionChanged()` triggers selection feedback
- [ ] Web platform returns no-op (no errors)
- [ ] Errors caught silently (haptics are non-critical)
- [ ] All types prefixed with `I`
- [ ] Uses `#region` comments for organization
- [ ] Exported from `utils/index.ts`
- [ ] No `any` types
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/utils/haptics.spec.ts

import * as Haptics from "expo-haptics";
import { Platform } from "react-native";

import {
  impactLight,
  impactMedium,
  impactHeavy,
  impact,
  notificationSuccess,
  notificationWarning,
  notificationError,
  notification,
  selectionChanged,
  isHapticsSupported,
  withHaptic,
} from "./haptics";

jest.mock("expo-haptics");

const mockHaptics = Haptics as jest.Mocked<typeof Haptics>;

describe("haptics utilities", () => {
  const originalPlatform = Platform.OS;

  beforeEach(() => {
    jest.clearAllMocks();
    Object.defineProperty(Platform, "OS", { value: "ios", writable: true });
  });

  afterEach(() => {
    Object.defineProperty(Platform, "OS", { value: originalPlatform });
  });

  //#region Impact Feedback

  describe("impactLight", () => {
    it("triggers light impact on iOS", async () => {
      mockHaptics.impactAsync.mockResolvedValue();

      await impactLight();

      expect(mockHaptics.impactAsync).toHaveBeenCalledWith(
        Haptics.ImpactFeedbackStyle.Light,
      );
    });

    it("does nothing on web", async () => {
      Object.defineProperty(Platform, "OS", { value: "web" });

      await impactLight();

      expect(mockHaptics.impactAsync).not.toHaveBeenCalled();
    });

    it("catches errors silently", async () => {
      mockHaptics.impactAsync.mockRejectedValue(new Error("Not supported"));
      const consoleSpy = jest.spyOn(console, "debug").mockImplementation();

      await expect(impactLight()).resolves.not.toThrow();

      consoleSpy.mockRestore();
    });
  });

  describe("impactMedium", () => {
    it("triggers medium impact", async () => {
      mockHaptics.impactAsync.mockResolvedValue();

      await impactMedium();

      expect(mockHaptics.impactAsync).toHaveBeenCalledWith(
        Haptics.ImpactFeedbackStyle.Medium,
      );
    });
  });

  describe("impactHeavy", () => {
    it("triggers heavy impact", async () => {
      mockHaptics.impactAsync.mockResolvedValue();

      await impactHeavy();

      expect(mockHaptics.impactAsync).toHaveBeenCalledWith(
        Haptics.ImpactFeedbackStyle.Heavy,
      );
    });
  });

  describe("impact", () => {
    it("calls correct function for each style", async () => {
      mockHaptics.impactAsync.mockResolvedValue();

      await impact("light");
      expect(mockHaptics.impactAsync).toHaveBeenLastCalledWith(
        Haptics.ImpactFeedbackStyle.Light,
      );

      await impact("medium");
      expect(mockHaptics.impactAsync).toHaveBeenLastCalledWith(
        Haptics.ImpactFeedbackStyle.Medium,
      );

      await impact("heavy");
      expect(mockHaptics.impactAsync).toHaveBeenLastCalledWith(
        Haptics.ImpactFeedbackStyle.Heavy,
      );
    });
  });

  //#endregion

  //#region Notification Feedback

  describe("notificationSuccess", () => {
    it("triggers success notification", async () => {
      mockHaptics.notificationAsync.mockResolvedValue();

      await notificationSuccess();

      expect(mockHaptics.notificationAsync).toHaveBeenCalledWith(
        Haptics.NotificationFeedbackType.Success,
      );
    });

    it("does nothing on web", async () => {
      Object.defineProperty(Platform, "OS", { value: "web" });

      await notificationSuccess();

      expect(mockHaptics.notificationAsync).not.toHaveBeenCalled();
    });
  });

  describe("notificationWarning", () => {
    it("triggers warning notification", async () => {
      mockHaptics.notificationAsync.mockResolvedValue();

      await notificationWarning();

      expect(mockHaptics.notificationAsync).toHaveBeenCalledWith(
        Haptics.NotificationFeedbackType.Warning,
      );
    });
  });

  describe("notificationError", () => {
    it("triggers error notification", async () => {
      mockHaptics.notificationAsync.mockResolvedValue();

      await notificationError();

      expect(mockHaptics.notificationAsync).toHaveBeenCalledWith(
        Haptics.NotificationFeedbackType.Error,
      );
    });
  });

  describe("notification", () => {
    it("calls correct function for each type", async () => {
      mockHaptics.notificationAsync.mockResolvedValue();

      await notification("success");
      expect(mockHaptics.notificationAsync).toHaveBeenLastCalledWith(
        Haptics.NotificationFeedbackType.Success,
      );

      await notification("warning");
      expect(mockHaptics.notificationAsync).toHaveBeenLastCalledWith(
        Haptics.NotificationFeedbackType.Warning,
      );

      await notification("error");
      expect(mockHaptics.notificationAsync).toHaveBeenLastCalledWith(
        Haptics.NotificationFeedbackType.Error,
      );
    });
  });

  //#endregion

  //#region Selection Feedback

  describe("selectionChanged", () => {
    it("triggers selection feedback", async () => {
      mockHaptics.selectionAsync.mockResolvedValue();

      await selectionChanged();

      expect(mockHaptics.selectionAsync).toHaveBeenCalled();
    });

    it("does nothing on web", async () => {
      Object.defineProperty(Platform, "OS", { value: "web" });

      await selectionChanged();

      expect(mockHaptics.selectionAsync).not.toHaveBeenCalled();
    });
  });

  //#endregion

  //#region Utility Functions

  describe("isHapticsSupported", () => {
    it("returns true on iOS", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });

      expect(isHapticsSupported()).toBe(true);
    });

    it("returns true on Android", () => {
      Object.defineProperty(Platform, "OS", { value: "android" });

      expect(isHapticsSupported()).toBe(true);
    });

    it("returns false on web", () => {
      Object.defineProperty(Platform, "OS", { value: "web" });

      expect(isHapticsSupported()).toBe(false);
    });
  });

  describe("withHaptic", () => {
    it("wraps function with haptic feedback", async () => {
      mockHaptics.impactAsync.mockResolvedValue();
      const handler = jest.fn().mockReturnValue("result");

      const wrappedHandler = withHaptic(handler);
      const result = await wrappedHandler("arg1", "arg2");

      expect(mockHaptics.impactAsync).toHaveBeenCalledWith(
        Haptics.ImpactFeedbackStyle.Light,
      );
      expect(handler).toHaveBeenCalledWith("arg1", "arg2");
      expect(result).toBe("result");
    });

    it("uses specified impact style", async () => {
      mockHaptics.impactAsync.mockResolvedValue();
      const handler = jest.fn();

      const wrappedHandler = withHaptic(handler, "heavy");
      await wrappedHandler();

      expect(mockHaptics.impactAsync).toHaveBeenCalledWith(
        Haptics.ImpactFeedbackStyle.Heavy,
      );
    });
  });

  //#endregion
});
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- haptics
```

### Type Check

```bash
pnpm --filter @retrievly/app tsc --noEmit
```

## Usage Examples

### Button with Haptic Feedback

```typescript
import { Pressable, Text } from "react-native";
import { impactLight } from "@/utils/haptics";

function Button({ onPress, title }: { onPress: () => void; title: string }) {
  const handlePress = async () => {
    await impactLight();
    onPress();
  };

  return (
    <Pressable onPress={handlePress}>
      <Text>{title}</Text>
    </Pressable>
  );
}
```

### Form Validation with Haptic Feedback

```typescript
import { notificationError, notificationSuccess } from "@/utils/haptics";

async function handleSubmit(formData: FormData) {
  const errors = validateForm(formData);

  if (errors.length > 0) {
    await notificationError();
    setErrors(errors);
    return;
  }

  await submitForm(formData);
  await notificationSuccess();
  showToast("Saved successfully!");
}
```

### Picker with Selection Haptic

```typescript
import { Picker } from "@react-native-picker/picker";
import { selectionChanged } from "@/utils/haptics";

function ColorPicker({ value, onChange }: Props) {
  const handleValueChange = async (newValue: string) => {
    await selectionChanged();
    onChange(newValue);
  };

  return (
    <Picker selectedValue={value} onValueChange={handleValueChange}>
      <Picker.Item label="Red" value="red" />
      <Picker.Item label="Blue" value="blue" />
      <Picker.Item label="Green" value="green" />
    </Picker>
  );
}
```

## Notes

### New Utility (Not in Mattermost)

This utility is **new** and not migrated from Mattermost. It's added because:

1. **Native mobile expectation**: Users expect haptic feedback on mobile
2. **UX enhancement**: Provides tactile confirmation of actions
3. **Platform parity**: iOS/Android both support haptics
4. **Accessibility**: Can help users with visual impairments

### When to Use Haptics

| Scenario                  | Haptic Type         |
| ------------------------- | ------------------- |
| Button tap                | impactLight         |
| Toggle switch             | impactLight         |
| Tab change                | impactLight         |
| Pull to refresh (release) | impactMedium        |
| Drag and drop (release)   | impactHeavy         |
| Form submission success   | notificationSuccess |
| Validation error          | notificationError   |
| Delete confirmation       | notificationWarning |
| Picker scroll             | selectionChanged    |
| Carousel slide            | selectionChanged    |
