# T9.08: useChannelBookmarksQuery Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.08            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | medium           |
| **Estimate** | 2h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-06       |
| **Updated**  | 2026-01-07       |

## Dependencies

| Task ID | Name        |
| ------- | ----------- |
| T7.01   | API Client  |
| T7.02   | QueryClient |
| T7.03   | Query Keys  |

## Description

Create a TanStack Query hook to fetch and cache channel bookmarks (pinned links/files).
Includes mutation hooks for add/remove operations.

**Architecture Note:** Bookmarks are server state (from REST API), so this uses TanStack Query.
See `.docs/architecture/state-management.md`.

## Source Analysis

- **API Endpoints**:
  - `GET /api/v4/channels/{channel_id}/bookmarks`
  - `POST /api/v4/channels/{channel_id}/bookmarks`
  - `DELETE /api/v4/channels/{channel_id}/bookmarks/{bookmark_id}`

## Migration Target

- **Target File**: `apps/v2/src/hooks/useChannelBookmarksQuery/useChannelBookmarksQuery.ts`
- **Index Export**: `apps/v2/src/hooks/useChannelBookmarksQuery/index.ts`

## Implementation

```typescript
// apps/v2/src/hooks/useChannelBookmarksQuery/useChannelBookmarksQuery.ts

import {
  useQuery,
  useMutation,
  useQueryClient,
  UseQueryOptions,
} from "@tanstack/react-query";
import { channelsApi } from "@/api/channels";
import { queryKeys } from "@/queries/keys";
import type { IChannelBookmark, ICreateBookmarkPayload } from "@/types";

//#region Types

type IUseChannelBookmarksQueryOptions = Omit<
  UseQueryOptions<IChannelBookmark[], Error>,
  "queryKey" | "queryFn"
>;

//#endregion Types

//#region Query Hook

/**
 * Fetches and caches channel bookmarks using TanStack Query.
 *
 * @param channelId - Channel ID to fetch bookmarks for
 * @param options - TanStack Query options
 * @returns Query result with data, isLoading, error, etc.
 */
export function useChannelBookmarksQuery(
  channelId: string | null | undefined,
  options?: IUseChannelBookmarksQueryOptions,
) {
  return useQuery({
    queryKey: queryKeys.channels.bookmarks(channelId!),
    queryFn: () => channelsApi.getBookmarks(channelId!),
    enabled: !!channelId && (options?.enabled ?? true),
    staleTime: 1000 * 60 * 5, // 5 minutes - bookmarks don't change often
    ...options,
  });
}

//#endregion Query Hook

//#region Mutation Hooks

/**
 * Mutation hook to add a bookmark to a channel.
 */
export function useAddBookmarkMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      channelId,
      bookmark,
    }: {
      channelId: string;
      bookmark: ICreateBookmarkPayload;
    }) => channelsApi.createBookmark(channelId, bookmark),

    onSuccess: (newBookmark, { channelId }) => {
      queryClient.setQueryData<IChannelBookmark[]>(
        queryKeys.channels.bookmarks(channelId),
        (old) => (old ? [...old, newBookmark] : [newBookmark]),
      );
    },
  });
}

/**
 * Mutation hook to remove a bookmark from a channel.
 */
export function useRemoveBookmarkMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      channelId,
      bookmarkId,
    }: {
      channelId: string;
      bookmarkId: string;
    }) => channelsApi.deleteBookmark(channelId, bookmarkId),

    onSuccess: (_, { channelId, bookmarkId }) => {
      queryClient.setQueryData<IChannelBookmark[]>(
        queryKeys.channels.bookmarks(channelId),
        (old) => old?.filter((b) => b.id !== bookmarkId),
      );
    },
  });
}

//#endregion Mutation Hooks
```

## Index Export

```typescript
// apps/v2/src/hooks/useChannelBookmarksQuery/index.ts

export {
  useChannelBookmarksQuery,
  useAddBookmarkMutation,
  useRemoveBookmarkMutation,
} from "./useChannelBookmarksQuery";
```

## Acceptance Criteria

- [ ] Uses TanStack Query `useQuery` hook
- [ ] Query key uses `queryKeys.channels.bookmarks(channelId)`
- [ ] 5 minute staleTime (bookmarks don't change often)
- [ ] Provides `useAddBookmarkMutation` for adding bookmarks
- [ ] Provides `useRemoveBookmarkMutation` for removing bookmarks
- [ ] Mutations update cache optimistically
- [ ] Disabled when channelId is null/undefined
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/hooks/useChannelBookmarksQuery/useChannelBookmarksQuery.spec.ts

import { renderHook, waitFor } from "@testing-library/react-native";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useChannelBookmarksQuery } from "./useChannelBookmarksQuery";
import { channelsApi } from "@/api/channels";

jest.mock("@/api/channels");

const mockBookmarks = [
  { id: "bm-1", display_name: "Project Wiki", link_url: "https://wiki.example.com" },
  { id: "bm-2", display_name: "Design Docs", link_url: "https://docs.example.com" },
];

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}

describe("useChannelBookmarksQuery", () => {
  it("fetches bookmarks for channel", async () => {
    (channelsApi.getBookmarks as jest.Mock).mockResolvedValue(mockBookmarks);

    const { result } = renderHook(() => useChannelBookmarksQuery("ch-1"), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data).toEqual(mockBookmarks);
  });

  it("does not fetch when channelId is null", () => {
    const { result } = renderHook(() => useChannelBookmarksQuery(null), {
      wrapper: createWrapper(),
    });

    expect(result.current.fetchStatus).toBe("idle");
  });
});
```

## Notes

- **Long staleTime** — Bookmarks rarely change, so 5 minute cache is appropriate
- **Mutations update cache** — No need to refetch after add/remove
