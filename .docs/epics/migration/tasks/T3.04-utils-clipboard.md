# T3.04: Clipboard Utilities

## Metadata

| Field        | Value               |
| ------------ | ------------------- |
| **ID**       | T3.04               |
| **Layer**    | L3 - Platform Utils |
| **Status**   | pending             |
| **Priority** | medium              |
| **Estimate** | 1h                  |
| **Parallel** | true                |
| **Assignee** | -                   |
| **Created**  | 2026-01-07          |
| **Updated**  | 2026-01-07          |

## Dependencies

| Task ID | Name               |
| ------- | ------------------ |
| T3.01   | Platform Detection |

## Blocks

| Task ID | Name                |
| ------- | ------------------- |
| T10c.\* | Message components  |
| T10c.\* | Share functionality |

## Description

Create clipboard utilities for copying and reading text from the system clipboard. This is a platform-specific utility (L3) because clipboard access requires native platform APIs. Uses `expo-clipboard` for cross-platform clipboard access on iOS, Android, and web.

**Platform Considerations:**

- **iOS**: Full clipboard access, no special permissions required
- **Android**: Read clipboard may require user focus on Android 10+, write always works
- **Web**: Uses Clipboard API, may require secure context (HTTPS) and user gesture

## Source Files

- `expo-clipboard` package documentation
- Common clipboard patterns from Mattermost message actions

## Target File

`apps/v2/src/utils/clipboard.ts`

## Implementation

````typescript
// apps/v2/src/utils/clipboard.ts

/**
 * Clipboard utilities
 * Provides cross-platform clipboard access for copy/paste operations.
 *
 * Uses expo-clipboard for native clipboard integration.
 */

import * as Clipboard from "expo-clipboard";

//#region Types

export type IClipboardContent = {
  text: string;
  hasText: boolean;
};

//#endregion

//#region Clipboard Operations

/**
 * Copy text to the system clipboard.
 *
 * @param text - Text to copy to clipboard
 * @returns Promise resolving to true if copy succeeded, false otherwise
 *
 * @example
 * ```typescript
 * const success = await copyToClipboard("Hello, World!");
 * if (success) {
 *   showToast("Copied to clipboard");
 * }
 * ```
 */
export async function copyToClipboard(text: string): Promise<boolean> {
  try {
    await Clipboard.setStringAsync(text);
    return true;
  } catch (error) {
    console.error("Failed to copy to clipboard:", error);
    return false;
  }
}

/**
 * Read text from the system clipboard.
 *
 * Note: On Android 10+, clipboard read may be restricted when app is in background.
 * On web, requires secure context and may require user gesture.
 *
 * @returns Promise resolving to clipboard text, or empty string if unavailable
 *
 * @example
 * ```typescript
 * const text = await getClipboardText();
 * if (text) {
 *   handlePastedContent(text);
 * }
 * ```
 */
export async function getClipboardText(): Promise<string> {
  try {
    const text = await Clipboard.getStringAsync();
    return text ?? "";
  } catch (error) {
    console.error("Failed to read clipboard:", error);
    return "";
  }
}

/**
 * Check if the clipboard contains text content.
 *
 * More efficient than getClipboardText() when you only need to check availability.
 *
 * @returns Promise resolving to true if clipboard has text, false otherwise
 *
 * @example
 * ```typescript
 * const canPaste = await hasClipboardText();
 * setPasteButtonEnabled(canPaste);
 * ```
 */
export async function hasClipboardText(): Promise<boolean> {
  try {
    const hasString = await Clipboard.hasStringAsync();
    return hasString;
  } catch (error) {
    console.error("Failed to check clipboard:", error);
    return false;
  }
}

//#endregion

//#region Clipboard Content

/**
 * Get clipboard content with metadata.
 *
 * Convenience function that returns both text and availability status.
 *
 * @returns Promise resolving to clipboard content object
 *
 * @example
 * ```typescript
 * const content = await getClipboardContent();
 * if (content.hasText) {
 *   console.log("Clipboard contains:", content.text);
 * }
 * ```
 */
export async function getClipboardContent(): Promise<IClipboardContent> {
  try {
    const [text, hasText] = await Promise.all([
      Clipboard.getStringAsync(),
      Clipboard.hasStringAsync(),
    ]);

    return {
      text: text ?? "",
      hasText,
    };
  } catch (error) {
    console.error("Failed to get clipboard content:", error);
    return {
      text: "",
      hasText: false,
    };
  }
}

//#endregion
````

## Index Export

```typescript
// apps/v2/src/utils/index.ts

export {
  copyToClipboard,
  getClipboardText,
  hasClipboardText,
  getClipboardContent,
} from "./clipboard";

export type { IClipboardContent } from "./clipboard";
```

## Platform Considerations

| Platform | Behavior                                                            |
| -------- | ------------------------------------------------------------------- |
| iOS      | Full access, works in foreground and background                     |
| Android  | Write always works; read restricted in background on Android 10+    |
| Web      | Requires HTTPS (secure context), some browsers require user gesture |

### Android Specifics

On Android 10 (API 29) and higher, apps cannot access clipboard data unless:

- The app is the default input method editor (IME)
- The app currently has input focus
- The user explicitly pastes from the clipboard

The `getClipboardText()` function handles this gracefully by returning an empty string when access is restricted.

### Web Specifics

The Clipboard API requires:

- Secure context (HTTPS or localhost)
- User gesture for read operations in some browsers
- Clipboard permission may be requested

## Acceptance Criteria

- [ ] Uses `expo-clipboard` package
- [ ] `copyToClipboard()` returns boolean success status
- [ ] `getClipboardText()` returns clipboard text or empty string
- [ ] `hasClipboardText()` checks clipboard availability efficiently
- [ ] Error handling with console.error logging
- [ ] All types defined with `type` keyword and `I` prefix
- [ ] Uses `#region` comments for organization
- [ ] Exported from `utils/index.ts`
- [ ] No `any` types
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/utils/clipboard.spec.ts

import * as Clipboard from "expo-clipboard";

import {
  copyToClipboard,
  getClipboardText,
  hasClipboardText,
  getClipboardContent,
} from "./clipboard";

jest.mock("expo-clipboard");

const mockClipboard = Clipboard as jest.Mocked<typeof Clipboard>;

describe("clipboard utilities", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  //#region copyToClipboard

  describe("copyToClipboard", () => {
    it("returns true on successful copy", async () => {
      mockClipboard.setStringAsync.mockResolvedValue();

      const result = await copyToClipboard("test text");

      expect(result).toBe(true);
      expect(mockClipboard.setStringAsync).toHaveBeenCalledWith("test text");
    });

    it("returns false on error", async () => {
      mockClipboard.setStringAsync.mockRejectedValue(new Error("Copy failed"));
      const consoleSpy = jest.spyOn(console, "error").mockImplementation();

      const result = await copyToClipboard("test text");

      expect(result).toBe(false);
      expect(consoleSpy).toHaveBeenCalled();
      consoleSpy.mockRestore();
    });

    it("handles empty string", async () => {
      mockClipboard.setStringAsync.mockResolvedValue();

      const result = await copyToClipboard("");

      expect(result).toBe(true);
      expect(mockClipboard.setStringAsync).toHaveBeenCalledWith("");
    });
  });

  //#endregion

  //#region getClipboardText

  describe("getClipboardText", () => {
    it("returns clipboard text", async () => {
      mockClipboard.getStringAsync.mockResolvedValue("clipboard content");

      const result = await getClipboardText();

      expect(result).toBe("clipboard content");
    });

    it("returns empty string when clipboard is empty", async () => {
      mockClipboard.getStringAsync.mockResolvedValue("");

      const result = await getClipboardText();

      expect(result).toBe("");
    });

    it("returns empty string on error", async () => {
      mockClipboard.getStringAsync.mockRejectedValue(new Error("Read failed"));
      const consoleSpy = jest.spyOn(console, "error").mockImplementation();

      const result = await getClipboardText();

      expect(result).toBe("");
      expect(consoleSpy).toHaveBeenCalled();
      consoleSpy.mockRestore();
    });

    it("handles null response", async () => {
      mockClipboard.getStringAsync.mockResolvedValue(null as unknown as string);

      const result = await getClipboardText();

      expect(result).toBe("");
    });
  });

  //#endregion

  //#region hasClipboardText

  describe("hasClipboardText", () => {
    it("returns true when clipboard has text", async () => {
      mockClipboard.hasStringAsync.mockResolvedValue(true);

      const result = await hasClipboardText();

      expect(result).toBe(true);
    });

    it("returns false when clipboard is empty", async () => {
      mockClipboard.hasStringAsync.mockResolvedValue(false);

      const result = await hasClipboardText();

      expect(result).toBe(false);
    });

    it("returns false on error", async () => {
      mockClipboard.hasStringAsync.mockRejectedValue(new Error("Check failed"));
      const consoleSpy = jest.spyOn(console, "error").mockImplementation();

      const result = await hasClipboardText();

      expect(result).toBe(false);
      expect(consoleSpy).toHaveBeenCalled();
      consoleSpy.mockRestore();
    });
  });

  //#endregion

  //#region getClipboardContent

  describe("getClipboardContent", () => {
    it("returns content with text and hasText true", async () => {
      mockClipboard.getStringAsync.mockResolvedValue("content");
      mockClipboard.hasStringAsync.mockResolvedValue(true);

      const result = await getClipboardContent();

      expect(result).toEqual({
        text: "content",
        hasText: true,
      });
    });

    it("returns empty content when clipboard is empty", async () => {
      mockClipboard.getStringAsync.mockResolvedValue("");
      mockClipboard.hasStringAsync.mockResolvedValue(false);

      const result = await getClipboardContent();

      expect(result).toEqual({
        text: "",
        hasText: false,
      });
    });

    it("returns empty content on error", async () => {
      mockClipboard.getStringAsync.mockRejectedValue(new Error("Failed"));
      mockClipboard.hasStringAsync.mockRejectedValue(new Error("Failed"));
      const consoleSpy = jest.spyOn(console, "error").mockImplementation();

      const result = await getClipboardContent();

      expect(result).toEqual({
        text: "",
        hasText: false,
      });
      consoleSpy.mockRestore();
    });
  });

  //#endregion
});
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- clipboard
```

### Type Check

```bash
pnpm --filter @retrievly/app tsc --noEmit
```

## Migration Notes

### Why L3 (Platform Utils) Instead of L2 (Pure Utils)

Clipboard operations are platform-specific because:

1. **Native API dependency**: Requires `expo-clipboard` which wraps platform-specific clipboard APIs
2. **Permission handling**: Android 10+ has clipboard access restrictions
3. **Async operations**: All operations are Promise-based due to native bridge
4. **Platform behavior differences**: Web requires secure context, Android restricts background access

This differs from L2 Pure Utils which have no platform dependencies and can run in any JavaScript environment.
