# T4.10: Password Utilities

## Metadata

| Field        | Value                 |
| ------------ | --------------------- |
| **ID**       | T4.10                 |
| **Layer**    | L4 - Formatting Utils |
| **Status**   | pending               |
| **Priority** | medium                |
| **Estimate** | 1h                    |
| **Parallel** | true                  |
| **Assignee** | -                     |
| **Created**  | 2026-01-06            |
| **Updated**  | 2026-01-06            |

## Dependencies

| Task ID | Name |
| ------- | ---- |
| None    | -    |

## Blocks

| Task ID | Name                         |
| ------- | ---------------------------- |
| T11.\*  | Auth/Registration components |

## Description

Password validation and strength checking utilities. Validates passwords against configurable policy rules and calculates strength scores for UI feedback.

## Source Files

- `vendor/desktop/webapp/channels/src/utils/password.ts`
- `vendor/desktop/webapp/channels/src/components/signup/signup.tsx`

## Migration Target

- **Target File**: `apps/v2/src/utils/password/password.ts`
- **Index Export**: `apps/v2/src/utils/password/index.ts`

## Implementation

```typescript
// apps/v2/src/utils/password/password.ts

//#region Types

type IPasswordStrength = "weak" | "fair" | "good" | "strong";

type IPasswordPolicy = {
  minLength: number;
  maxLength: number;
  requireLowercase: boolean;
  requireUppercase: boolean;
  requireNumber: boolean;
  requireSymbol: boolean;
};

type IPasswordValidationResult = {
  valid: boolean;
  errors: string[];
};

//#endregion Types

//#region Constants

export const DEFAULT_PASSWORD_POLICY: IPasswordPolicy = {
  minLength: 8,
  maxLength: 72,
  requireLowercase: true,
  requireUppercase: true,
  requireNumber: true,
  requireSymbol: false,
};

const COMMON_PASSWORDS = new Set([
  "password",
  "123456",
  "password1",
  "qwerty",
  "letmein",
  "welcome",
  "monkey",
  "dragon",
  "master",
  "login",
  "abc123",
  "admin",
  "iloveyou",
  "trustno1",
  "sunshine",
]);

//#endregion Constants

//#region Validation

/**
 * Validate password against policy rules
 */
export function validatePassword(
  password: string,
  policy: IPasswordPolicy = DEFAULT_PASSWORD_POLICY,
): IPasswordValidationResult {
  const errors: string[] = [];

  if (password.length < policy.minLength) {
    errors.push(`Password must be at least ${policy.minLength} characters`);
  }

  if (password.length > policy.maxLength) {
    errors.push(`Password must be at most ${policy.maxLength} characters`);
  }

  if (policy.requireLowercase && !/[a-z]/.test(password)) {
    errors.push("Password must contain a lowercase letter");
  }

  if (policy.requireUppercase && !/[A-Z]/.test(password)) {
    errors.push("Password must contain an uppercase letter");
  }

  if (policy.requireNumber && !/\d/.test(password)) {
    errors.push("Password must contain a number");
  }

  if (
    policy.requireSymbol &&
    !/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
  ) {
    errors.push("Password must contain a symbol");
  }

  return {
    valid: errors.length === 0,
    errors,
  };
}

//#endregion Validation

//#region Strength

/**
 * Calculate password strength score (0-100)
 */
export function getPasswordStrengthScore(password: string): number {
  if (!password) return 0;

  let score = 0;

  // Length contribution (up to 30 points)
  score += Math.min(password.length * 2, 30);

  // Character variety (up to 40 points)
  if (/[a-z]/.test(password)) score += 10;
  if (/[A-Z]/.test(password)) score += 10;
  if (/\d/.test(password)) score += 10;
  if (/[^a-zA-Z0-9]/.test(password)) score += 10;

  // Bonus for mixing (up to 20 points)
  const varieties = [
    /[a-z]/.test(password),
    /[A-Z]/.test(password),
    /\d/.test(password),
    /[^a-zA-Z0-9]/.test(password),
  ].filter(Boolean).length;
  score += varieties * 5;

  // Penalties
  if (COMMON_PASSWORDS.has(password.toLowerCase())) {
    score = Math.min(score, 10);
  }

  // Repetitive patterns penalty
  if (/(.)\1{2,}/.test(password)) {
    score -= 10;
  }

  // Sequential patterns penalty
  if (/(?:abc|bcd|cde|123|234|345|qwe|wer)/i.test(password)) {
    score -= 10;
  }

  return Math.max(0, Math.min(100, score));
}

/**
 * Get password strength category
 */
export function checkPasswordStrength(password: string): IPasswordStrength {
  const score = getPasswordStrengthScore(password);

  if (score < 30) return "weak";
  if (score < 50) return "fair";
  if (score < 75) return "good";
  return "strong";
}

/**
 * Check if password is a commonly used password
 */
export function isCommonPassword(password: string): boolean {
  return COMMON_PASSWORDS.has(password.toLowerCase());
}

//#endregion Strength
```

## Index Export

```typescript
// apps/v2/src/utils/password/index.ts

export {
  validatePassword,
  getPasswordStrengthScore,
  checkPasswordStrength,
  isCommonPassword,
  DEFAULT_PASSWORD_POLICY,
} from "./password";
```

## Acceptance Criteria

- [ ] `validatePassword()` checks all policy rules
- [ ] `validatePassword()` returns specific error messages
- [ ] `getPasswordStrengthScore()` returns 0-100 score
- [ ] `checkPasswordStrength()` returns strength category
- [ ] Penalizes common passwords
- [ ] Penalizes repetitive/sequential patterns
- [ ] `DEFAULT_PASSWORD_POLICY` matches Mattermost defaults
- [ ] All types use `I` prefix naming convention
- [ ] TypeScript strict mode passes
- [ ] No `any` types

## Testing

```typescript
// apps/v2/src/utils/password/password.spec.ts

import {
  validatePassword,
  getPasswordStrengthScore,
  checkPasswordStrength,
  isCommonPassword,
  DEFAULT_PASSWORD_POLICY,
} from "./password";

//#region validatePassword Tests

describe("validatePassword", () => {
  it("validates against default policy", () => {
    const result = validatePassword("Aa1bcdef");
    expect(result.valid).toBe(true);
    expect(result.errors).toHaveLength(0);
  });

  it("rejects too short password", () => {
    const result = validatePassword("Aa1b");
    expect(result.valid).toBe(false);
    expect(result.errors).toContain("Password must be at least 8 characters");
  });

  it("rejects password without lowercase", () => {
    const result = validatePassword("ABCD1234");
    expect(result.valid).toBe(false);
    expect(result.errors).toContain("Password must contain a lowercase letter");
  });

  it("rejects password without uppercase", () => {
    const result = validatePassword("abcd1234");
    expect(result.valid).toBe(false);
    expect(result.errors).toContain(
      "Password must contain an uppercase letter",
    );
  });

  it("rejects password without number", () => {
    const result = validatePassword("Abcdefgh");
    expect(result.valid).toBe(false);
    expect(result.errors).toContain("Password must contain a number");
  });

  it("accepts custom policy", () => {
    const policy = {
      ...DEFAULT_PASSWORD_POLICY,
      requireSymbol: true,
    };
    const result = validatePassword("Aa1bcdef", policy);
    expect(result.valid).toBe(false);
    expect(result.errors).toContain("Password must contain a symbol");
  });

  it("returns multiple errors when applicable", () => {
    const result = validatePassword("abc");
    expect(result.errors.length).toBeGreaterThan(1);
  });
});

//#endregion validatePassword Tests

//#region getPasswordStrengthScore Tests

describe("getPasswordStrengthScore", () => {
  it("returns 0 for empty password", () => {
    expect(getPasswordStrengthScore("")).toBe(0);
  });

  it("returns low score for short passwords", () => {
    expect(getPasswordStrengthScore("abc")).toBeLessThan(30);
  });

  it("returns higher score for longer passwords", () => {
    const shortScore = getPasswordStrengthScore("Aa1!");
    const longScore = getPasswordStrengthScore("Aa1!Aa1!Aa1!");
    expect(longScore).toBeGreaterThan(shortScore);
  });

  it("increases score for character variety", () => {
    const lowercase = getPasswordStrengthScore("abcdefgh");
    const mixed = getPasswordStrengthScore("Abcd1234");
    const complex = getPasswordStrengthScore("Abcd12!@");
    expect(mixed).toBeGreaterThan(lowercase);
    expect(complex).toBeGreaterThan(mixed);
  });

  it("penalizes common passwords", () => {
    const score = getPasswordStrengthScore("password");
    expect(score).toBeLessThanOrEqual(10);
  });

  it("penalizes repetitive patterns", () => {
    const normal = getPasswordStrengthScore("Abcd1234");
    const repetitive = getPasswordStrengthScore("Aaaa1234");
    expect(repetitive).toBeLessThan(normal);
  });

  it("returns max 100", () => {
    const score = getPasswordStrengthScore("SuperSecure!Password123$%");
    expect(score).toBeLessThanOrEqual(100);
  });
});

//#endregion getPasswordStrengthScore Tests

//#region checkPasswordStrength Tests

describe("checkPasswordStrength", () => {
  it("returns weak for simple passwords", () => {
    expect(checkPasswordStrength("abc")).toBe("weak");
    expect(checkPasswordStrength("password")).toBe("weak");
  });

  it("returns fair for medium passwords", () => {
    expect(checkPasswordStrength("abcd1234")).toBe("fair");
  });

  it("returns good for decent passwords", () => {
    expect(checkPasswordStrength("Abcd1234!")).toBe("good");
  });

  it("returns strong for complex passwords", () => {
    expect(checkPasswordStrength("MyStr0ng!Pass#2024")).toBe("strong");
  });
});

//#endregion checkPasswordStrength Tests

//#region isCommonPassword Tests

describe("isCommonPassword", () => {
  it("detects common passwords", () => {
    expect(isCommonPassword("password")).toBe(true);
    expect(isCommonPassword("123456")).toBe(true);
    expect(isCommonPassword("qwerty")).toBe(true);
  });

  it("is case insensitive", () => {
    expect(isCommonPassword("PASSWORD")).toBe(true);
    expect(isCommonPassword("Password")).toBe(true);
  });

  it("returns false for uncommon passwords", () => {
    expect(isCommonPassword("xK9#mP2$vL")).toBe(false);
  });
});

//#endregion isCommonPassword Tests
```

### Run Tests

```bash
pnpm --filter @retrievly/app test:unit -- password
```
