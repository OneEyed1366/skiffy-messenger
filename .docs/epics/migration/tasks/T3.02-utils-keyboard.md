# T3.02: Keyboard Utilities

## Metadata

| Field        | Value      |
| ------------ | ---------- |
| **ID**       | T3.02      |
| **Layer**    | L3 - Utils |
| **Status**   | pending    |
| **Priority** | medium     |
| **Estimate** | 1h         |
| **Parallel** | true       |
| **Assignee** | -          |
| **Created**  | 2026-01-04 |
| **Updated**  | 2026-01-04 |

## Dependencies

| Task ID | Name             |
| ------- | ---------------- |
| T3.01   | Platform Helpers |

## Blocks

| Task ID | Name    |
| ------- | ------- |
| T10c.XX | TextBox |
| T10c.XX | Search  |

## Description

Migrate keyboard utilities from Mattermost web app to React Native.

The source implementation provides:

1. `cmdOrCtrlPressed()` - Detects Cmd (Mac) or Ctrl (Windows/Linux) modifier key
2. `isKeyPressed()` - Checks if a specific key was pressed, handling different keyboard layouts
3. `KeyCodes` constant - Maps key names to [key, keyCode] tuples

**Platform Considerations:**

- **Desktop (Tauri)**: Full keyboard shortcut support via web APIs
- **Mobile (iOS/Android)**: Limited keyboard events; hardware keyboards only on tablets
- React Native doesn't have direct `KeyboardEvent` access on mobile - uses `react-native-keyevent` or TextInput's `onKeyPress` with limited key info

The implementation provides a cross-platform abstraction that:

- Works natively on desktop/web
- Gracefully degrades on mobile (returns false for modifier checks when unavailable)
- Exports key constants for use in TextInput `onKeyPress` handlers

## Source Files

- `vendor/desktop/webapp/channels/src/utils/keyboard.ts`
- `vendor/desktop/webapp/channels/src/utils/constants.tsx` (KeyCodes section, lines 1834-1931)

## Target File

`apps/v2/src/utils/keyboard.ts`

## Implementation

````typescript
// apps/v2/src/utils/keyboard.ts

/**
 * Keyboard utilities
 * Migrated from: vendor/desktop/webapp/channels/src/utils/keyboard.ts
 *
 * Provides cross-platform keyboard handling for desktop (Tauri) and mobile.
 * Mobile support is limited to TextInput onKeyPress events.
 */

import { Platform } from "react-native";

import { isMac } from "@/utils/platform";

//#region Types

/**
 * Key definition tuple: [key string, keyCode number]
 * - key[0]: Used for KeyboardEvent.key (modern browsers)
 * - key[1]: Used for KeyboardEvent.keyCode (legacy fallback)
 */
export type IKeyCode = readonly [string, number];

/**
 * Keyboard event interface compatible with both web KeyboardEvent
 * and React Native TextInput onKeyPress event.
 */
export type IKeyboardEvent = {
  key?: string;
  keyCode?: number;
  metaKey?: boolean;
  ctrlKey?: boolean;
  altKey?: boolean;
  shiftKey?: boolean;
};

//#endregion

//#region Key Codes

/**
 * Key code constants for keyboard event handling.
 * Each entry is [key, keyCode] tuple.
 *
 * @example
 * ```typescript
 * if (isKeyPressed(event, KEY_CODES.ENTER)) {
 *   handleSubmit();
 * }
 * ```
 */
export const KEY_CODES = {
  BACKSPACE: ["Backspace", 8],
  TAB: ["Tab", 9],
  ENTER: ["Enter", 13],
  SHIFT: ["Shift", 16],
  CTRL: ["Control", 17],
  ALT: ["Alt", 18],
  CAPS_LOCK: ["CapsLock", 20],
  ESCAPE: ["Escape", 27],
  SPACE: [" ", 32],
  PAGE_UP: ["PageUp", 33],
  PAGE_DOWN: ["PageDown", 34],
  END: ["End", 35],
  HOME: ["Home", 36],
  LEFT: ["ArrowLeft", 37],
  UP: ["ArrowUp", 38],
  RIGHT: ["ArrowRight", 39],
  DOWN: ["ArrowDown", 40],
  DELETE: ["Delete", 46],
  ZERO: ["0", 48],
  ONE: ["1", 49],
  TWO: ["2", 50],
  THREE: ["3", 51],
  FOUR: ["4", 52],
  FIVE: ["5", 53],
  SIX: ["6", 54],
  SEVEN: ["7", 55],
  EIGHT: ["8", 56],
  NINE: ["9", 57],
  A: ["a", 65],
  B: ["b", 66],
  C: ["c", 67],
  D: ["d", 68],
  E: ["e", 69],
  F: ["f", 70],
  G: ["g", 71],
  H: ["h", 72],
  I: ["i", 73],
  J: ["j", 74],
  K: ["k", 75],
  L: ["l", 76],
  M: ["m", 77],
  N: ["n", 78],
  O: ["o", 79],
  P: ["p", 80],
  Q: ["q", 81],
  R: ["r", 82],
  S: ["s", 83],
  T: ["t", 84],
  U: ["u", 85],
  V: ["v", 86],
  W: ["w", 87],
  X: ["x", 88],
  Y: ["y", 89],
  Z: ["z", 90],
  CMD: ["Meta", 91],
  SEMICOLON: [";", 186],
  EQUAL: ["=", 187],
  COMMA: [",", 188],
  DASH: ["-", 189],
  PERIOD: [".", 190],
  FORWARD_SLASH: ["/", 191],
  OPEN_BRACKET: ["[", 219],
  BACK_SLASH: ["\\", 220],
  CLOSE_BRACKET: ["]", 221],
  COMPOSING: ["Composing", 229],
} as const satisfies Record<string, IKeyCode>;

//#endregion

//#region Keyboard Utilities

/**
 * Checks if the platform-specific command key is pressed.
 * - Mac: Meta key (Cmd)
 * - Windows/Linux: Ctrl key
 *
 * On mobile platforms without modifier key support, returns false.
 *
 * @param event - Keyboard event to check
 * @param allowAlt - If true, allows Alt key to be pressed alongside Ctrl (Windows/Linux only)
 * @returns True if Cmd (Mac) or Ctrl (others) is pressed
 *
 * @example
 * ```typescript
 * // Handle Cmd+S / Ctrl+S
 * if (cmdOrCtrlPressed(event) && isKeyPressed(event, KEY_CODES.S)) {
 *   handleSave();
 * }
 * ```
 */
export function cmdOrCtrlPressed(
  event: IKeyboardEvent,
  allowAlt = false,
): boolean {
  // Mobile platforms don't reliably report modifier keys
  if (Platform.OS === "ios" || Platform.OS === "android") {
    // Only available with external keyboard, check if properties exist
    if (event.metaKey === undefined && event.ctrlKey === undefined) {
      return false;
    }
  }

  const isMacPlatform = isMac();

  if (allowAlt) {
    return (
      (isMacPlatform && !!event.metaKey) || (!isMacPlatform && !!event.ctrlKey)
    );
  }

  return (
    (isMacPlatform && !!event.metaKey) ||
    (!isMacPlatform && !!event.ctrlKey && !event.altKey)
  );
}

/**
 * Checks if a specific key was pressed.
 * Handles different keyboard layouts by checking both key and keyCode.
 *
 * @param event - Keyboard event to check
 * @param key - Key code tuple to match against [key, keyCode]
 * @returns True if the specified key was pressed
 *
 * @example
 * ```typescript
 * if (isKeyPressed(event, KEY_CODES.ENTER)) {
 *   handleSubmit();
 * }
 *
 * // With modifier
 * if (cmdOrCtrlPressed(event) && isKeyPressed(event, KEY_CODES.V)) {
 *   handlePaste();
 * }
 * ```
 */
export function isKeyPressed(event: IKeyboardEvent, key: IKeyCode): boolean {
  // Skip if composing (IME input in progress)
  if (event.keyCode === KEY_CODES.COMPOSING[1]) {
    return false;
  }

  // Primary check: event.key (modern browsers, handles different layouts)
  if (
    typeof event.key !== "undefined" &&
    event.key !== "Unidentified" &&
    event.key !== "Dead"
  ) {
    const isPressedByKey =
      event.key === key[0] || event.key === key[0].toUpperCase();
    if (isPressedByKey) {
      return true;
    }
  }

  // Fallback: keyCode for different language keyboards
  return event.keyCode === key[1];
}

/**
 * Checks if Enter key was pressed without Shift modifier.
 * Useful for form submission vs. newline handling.
 *
 * @param event - Keyboard event to check
 * @returns True if Enter pressed without Shift
 */
export function isEnterPressed(event: IKeyboardEvent): boolean {
  return isKeyPressed(event, KEY_CODES.ENTER) && !event.shiftKey;
}

/**
 * Checks if Escape key was pressed.
 *
 * @param event - Keyboard event to check
 * @returns True if Escape was pressed
 */
export function isEscapePressed(event: IKeyboardEvent): boolean {
  return isKeyPressed(event, KEY_CODES.ESCAPE);
}

//#endregion
````

## Index Export

```typescript
// apps/v2/src/utils/index.ts

export {
  cmdOrCtrlPressed,
  isKeyPressed,
  isEnterPressed,
  isEscapePressed,
  KEY_CODES,
} from "./keyboard";
export type { IKeyCode, IKeyboardEvent } from "./keyboard";
```

## Acceptance Criteria

- [ ] Imports `isMac` from `@/utils/platform` (T3.01 dependency)
- [ ] `KEY_CODES` constant exported with common key definitions
- [ ] `cmdOrCtrlPressed()` handles Mac (Meta) vs others (Ctrl)
- [ ] `isKeyPressed()` handles both `key` and `keyCode` checks
- [ ] Graceful degradation on mobile (returns false when modifiers unavailable)
- [ ] Helper functions `isEnterPressed()` and `isEscapePressed()` included
- [ ] All types prefixed with `I`
- [ ] Uses `#region` comments for organization
- [ ] Exported from `utils/index.ts`
- [ ] No `any` types
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/utils/keyboard.spec.ts

import { Platform } from "react-native";

import {
  cmdOrCtrlPressed,
  isKeyPressed,
  isEnterPressed,
  isEscapePressed,
  KEY_CODES,
} from "./keyboard";
import * as platformUtils from "./platform";

jest.mock("./platform");

const mockPlatformUtils = platformUtils as jest.Mocked<typeof platformUtils>;

describe("keyboard utilities", () => {
  beforeEach(() => {
    jest.clearAllMocks();
    mockPlatformUtils.isMac.mockReturnValue(false);
  });

  //#region cmdOrCtrlPressed

  describe("cmdOrCtrlPressed", () => {
    it("returns true for Ctrl on non-Mac", () => {
      mockPlatformUtils.isMac.mockReturnValue(false);

      const event = { ctrlKey: true, altKey: false };
      expect(cmdOrCtrlPressed(event)).toBe(true);
    });

    it("returns false for Ctrl+Alt on non-Mac without allowAlt", () => {
      mockPlatformUtils.isMac.mockReturnValue(false);

      const event = { ctrlKey: true, altKey: true };
      expect(cmdOrCtrlPressed(event)).toBe(false);
    });

    it("returns true for Ctrl+Alt on non-Mac with allowAlt", () => {
      mockPlatformUtils.isMac.mockReturnValue(false);

      const event = { ctrlKey: true, altKey: true };
      expect(cmdOrCtrlPressed(event, true)).toBe(true);
    });

    it("returns true for Meta on Mac", () => {
      mockPlatformUtils.isMac.mockReturnValue(true);

      const event = { metaKey: true };
      expect(cmdOrCtrlPressed(event)).toBe(true);
    });

    it("returns false for Ctrl on Mac", () => {
      mockPlatformUtils.isMac.mockReturnValue(true);

      const event = { ctrlKey: true };
      expect(cmdOrCtrlPressed(event)).toBe(false);
    });

    it("returns false when no modifier pressed", () => {
      const event = { ctrlKey: false, metaKey: false };
      expect(cmdOrCtrlPressed(event)).toBe(false);
    });
  });

  //#endregion

  //#region isKeyPressed

  describe("isKeyPressed", () => {
    it("matches by key string", () => {
      const event = { key: "Enter" };
      expect(isKeyPressed(event, KEY_CODES.ENTER)).toBe(true);
    });

    it("matches by key string case-insensitive", () => {
      const event = { key: "A" };
      expect(isKeyPressed(event, KEY_CODES.A)).toBe(true);
    });

    it("matches by keyCode fallback", () => {
      const event = { key: "Unidentified", keyCode: 13 };
      expect(isKeyPressed(event, KEY_CODES.ENTER)).toBe(true);
    });

    it("returns false during IME composition", () => {
      const event = { keyCode: 229 };
      expect(isKeyPressed(event, KEY_CODES.ENTER)).toBe(false);
    });

    it("returns false for non-matching key", () => {
      const event = { key: "Enter", keyCode: 13 };
      expect(isKeyPressed(event, KEY_CODES.ESCAPE)).toBe(false);
    });

    it("handles Dead key events", () => {
      const event = { key: "Dead", keyCode: 65 };
      expect(isKeyPressed(event, KEY_CODES.A)).toBe(true);
    });
  });

  //#endregion

  //#region Helper Functions

  describe("isEnterPressed", () => {
    it("returns true for Enter without Shift", () => {
      const event = { key: "Enter", shiftKey: false };
      expect(isEnterPressed(event)).toBe(true);
    });

    it("returns false for Enter with Shift", () => {
      const event = { key: "Enter", shiftKey: true };
      expect(isEnterPressed(event)).toBe(false);
    });
  });

  describe("isEscapePressed", () => {
    it("returns true for Escape key", () => {
      const event = { key: "Escape" };
      expect(isEscapePressed(event)).toBe(true);
    });

    it("returns false for other keys", () => {
      const event = { key: "Enter" };
      expect(isEscapePressed(event)).toBe(false);
    });
  });

  //#endregion

  //#region KEY_CODES

  describe("KEY_CODES", () => {
    it("has correct ENTER definition", () => {
      expect(KEY_CODES.ENTER).toEqual(["Enter", 13]);
    });

    it("has correct ESCAPE definition", () => {
      expect(KEY_CODES.ESCAPE).toEqual(["Escape", 27]);
    });

    it("has correct modifier keys", () => {
      expect(KEY_CODES.CTRL).toEqual(["Control", 17]);
      expect(KEY_CODES.CMD).toEqual(["Meta", 91]);
      expect(KEY_CODES.ALT).toEqual(["Alt", 18]);
      expect(KEY_CODES.SHIFT).toEqual(["Shift", 16]);
    });
  });

  //#endregion
});
```

Run tests:

```bash
pnpm --filter @retrievly/app test:unit -- keyboard
```

## Notes

### Mobile Limitations

On mobile platforms (iOS/Android):

- **Virtual keyboard**: Does not trigger standard KeyboardEvent with modifier keys
- **External keyboard**: Full support on tablets with hardware keyboards
- **TextInput onKeyPress**: Limited to basic key detection (no reliable modifier keys)

The implementation gracefully handles these limitations by:

1. Checking for undefined modifier properties on mobile
2. Returning false for `cmdOrCtrlPressed` when modifiers are unavailable
3. Still supporting basic key detection via `isKeyPressed`

### Desktop (Tauri) Support

Full keyboard shortcut support on desktop via web APIs. The implementation is identical to the source web app behavior.
