# T9.13: useChannelCategoriesQuery Hook

## Metadata

| Field        | Value            |
| ------------ | ---------------- |
| **ID**       | T9.13            |
| **Layer**    | L9 - State Hooks |
| **Status**   | pending          |
| **Priority** | high             |
| **Estimate** | 2h               |
| **Parallel** | true             |
| **Assignee** | -                |
| **Created**  | 2026-01-06       |
| **Updated**  | 2026-01-07       |

## Dependencies

| Task ID | Name        |
| ------- | ----------- |
| T7.01   | API Client  |
| T7.02   | QueryClient |
| T7.03   | Query Keys  |

## Description

Create a TanStack Query hook to fetch channel sidebar categories (Favorites, Channels,
Direct Messages, custom categories). Uses the `select` option to transform and sort data.

**Architecture Note:** Channel categories are server state (from REST API), so this uses
TanStack Query. See `.docs/architecture/state-management.md`.

## Source Analysis

- **Redux Selector**: `vendor/desktop/webapp/platform/client/src/selectors/entities/channel_categories.ts`
- **API Endpoint**: `GET /api/v4/users/{user_id}/teams/{team_id}/channels/categories`

## Migration Target

- **Target File**: `apps/v2/src/hooks/useChannelCategoriesQuery/useChannelCategoriesQuery.ts`
- **Index Export**: `apps/v2/src/hooks/useChannelCategoriesQuery/index.ts`

## Implementation

````typescript
// apps/v2/src/hooks/useChannelCategoriesQuery/useChannelCategoriesQuery.ts

import {
  useQuery,
  useMutation,
  useQueryClient,
  UseQueryOptions,
} from "@tanstack/react-query";
import { channelsApi } from "@/api/channels";
import { queryKeys } from "@/queries/keys";
import type { IChannelCategory, IChannel } from "@/types";

//#region Types

type IRawCategoriesResponse = {
  categories: IChannelCategory[];
  order: string[];
};

type ICategoryWithOrder = IChannelCategory & {
  sortOrder: number;
};

type IUseChannelCategoriesQueryOptions = Omit<
  UseQueryOptions<IRawCategoriesResponse, Error, ICategoryWithOrder[]>,
  "queryKey" | "queryFn" | "select"
>;

//#endregion Types

//#region Helpers

function selectSortedCategories(
  data: IRawCategoriesResponse,
): ICategoryWithOrder[] {
  const orderMap = new Map(data.order.map((id, index) => [id, index]));

  return data.categories
    .map((category) => ({
      ...category,
      sortOrder: orderMap.get(category.id) ?? 999,
    }))
    .sort((a, b) => a.sortOrder - b.sortOrder);
}

//#endregion Helpers

//#region Query Hook

/**
 * Fetches and caches channel categories for a team using TanStack Query.
 * Categories are automatically sorted by their order.
 *
 * @param teamId - Team ID to fetch categories for
 * @param options - TanStack Query options
 * @returns Query result with sorted categories
 *
 * @example
 * ```tsx
 * function Sidebar({ teamId }: { teamId: string }) {
 *   const { data: categories, isLoading } = useChannelCategoriesQuery(teamId);
 *
 *   return categories?.map((category) => (
 *     <CategorySection key={category.id} category={category} />
 *   ));
 * }
 * ```
 */
export function useChannelCategoriesQuery(
  teamId: string | null | undefined,
  options?: IUseChannelCategoriesQueryOptions,
) {
  return useQuery({
    queryKey: queryKeys.channels.categories(teamId!),
    queryFn: () => channelsApi.getChannelCategories(teamId!),
    select: selectSortedCategories,
    enabled: !!teamId && (options?.enabled ?? true),
    staleTime: 1000 * 60, // 1 minute
    ...options,
  });
}

//#endregion Query Hook

//#region Mutation Hooks

/**
 * Mutation hook to move a channel to a different category.
 */
export function useMoveChannelToCategoryMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      teamId,
      channelId,
      categoryId,
    }: {
      teamId: string;
      channelId: string;
      categoryId: string;
    }) => channelsApi.moveChannelToCategory(teamId, channelId, categoryId),

    onSuccess: (_, { teamId }) => {
      // Invalidate categories to refetch
      queryClient.invalidateQueries({
        queryKey: queryKeys.channels.categories(teamId),
      });
    },
  });
}

/**
 * Mutation hook to reorder categories.
 */
export function useReorderCategoriesMutation() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({
      teamId,
      categoryIds,
    }: {
      teamId: string;
      categoryIds: string[];
    }) => channelsApi.reorderCategories(teamId, categoryIds),

    onSuccess: (_, { teamId }) => {
      queryClient.invalidateQueries({
        queryKey: queryKeys.channels.categories(teamId),
      });
    },
  });
}

//#endregion Mutation Hooks
````

## Index Export

```typescript
// apps/v2/src/hooks/useChannelCategoriesQuery/index.ts

export {
  useChannelCategoriesQuery,
  useMoveChannelToCategoryMutation,
  useReorderCategoriesMutation,
} from "./useChannelCategoriesQuery";
```

## Acceptance Criteria

- [ ] Uses TanStack Query `useQuery` hook
- [ ] Uses `select` option to sort categories by order
- [ ] Query key uses `queryKeys.channels.categories(teamId)`
- [ ] Provides `useMoveChannelToCategoryMutation` for moving channels
- [ ] Provides `useReorderCategoriesMutation` for reordering
- [ ] Mutations invalidate categories query
- [ ] Disabled when teamId is null/undefined
- [ ] TypeScript strict mode passes

## Testing

```typescript
// apps/v2/src/hooks/useChannelCategoriesQuery/useChannelCategoriesQuery.spec.ts

import { renderHook, waitFor } from "@testing-library/react-native";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useChannelCategoriesQuery } from "./useChannelCategoriesQuery";
import { channelsApi } from "@/api/channels";

jest.mock("@/api/channels");

const mockResponse = {
  categories: [
    { id: "cat-1", display_name: "Favorites", type: "favorites", channel_ids: [] },
    { id: "cat-2", display_name: "Channels", type: "channels", channel_ids: [] },
  ],
  order: ["cat-1", "cat-2"],
};

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
}

describe("useChannelCategoriesQuery", () => {
  it("fetches and sorts categories", async () => {
    (channelsApi.getChannelCategories as jest.Mock).mockResolvedValue(mockResponse);

    const { result } = renderHook(() => useChannelCategoriesQuery("team-1"), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });

    expect(result.current.data).toHaveLength(2);
    expect(result.current.data?.[0].display_name).toBe("Favorites");
    expect(result.current.data?.[0].sortOrder).toBe(0);
  });
});
```

## Notes

- **Derived data** — Uses TQ `select` for memoized transformation (no useMemo needed)
- **WebSocket updates** — Category changes from `sidebar_category_*` events invalidate query
