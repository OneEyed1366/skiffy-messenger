# T3.01: Platform Detection

## Metadata

| Field        | Value               |
| ------------ | ------------------- |
| **ID**       | T3.01               |
| **Layer**    | L3 - Platform Utils |
| **Status**   | pending             |
| **Priority** | high                |
| **Estimate** | 2h                  |
| **Parallel** | true                |
| **Assignee** | -                   |
| **Created**  | 2026-01-04          |
| **Updated**  | 2026-01-04          |

## Dependencies

None

## Blocks

| Task ID | Name                  |
| ------- | --------------------- |
| T3.02   | Clipboard Utils       |
| T3.03   | Keyboard Utils        |
| T10a.\* | Navigation components |
| T10b.\* | Settings components   |
| T10c.\* | Profile components    |

## Description

Migrate platform detection utilities from Mattermost's user agent parsing to React Native's Platform API. The original implementation uses browser user agent strings which are not applicable in React Native. This migration provides native platform detection using the built-in Platform module.

## Source Files

- `vendor/desktop/webapp/channels/src/utils/user_agent.tsx`

## Target File

`apps/v2/src/utils/platform.ts`

## Implementation

```typescript
// apps/v2/src/utils/platform.ts

/**
 * Platform detection utilities
 * Migrated from: vendor/desktop/webapp/channels/src/utils/user_agent.tsx
 *
 * NOTE: Original implementation used browser user agent parsing.
 * React Native uses the Platform API for native detection.
 */

import { Platform } from "react-native";

//#region Platform Types

export type IPlatformOS = "ios" | "android" | "windows" | "macos" | "web";

export type IPlatformInfo = {
  os: IPlatformOS;
  version: string | number;
  isIos: boolean;
  isAndroid: boolean;
  isMobile: boolean;
  isDesktop: boolean;
  isWeb: boolean;
};

//#endregion

//#region Core Platform Detection

/**
 * Check if running on iOS
 */
export function isIos(): boolean {
  return Platform.OS === "ios";
}

/**
 * Check if running on Android
 */
export function isAndroid(): boolean {
  return Platform.OS === "android";
}

/**
 * Check if running on a mobile platform (iOS or Android)
 */
export function isMobile(): boolean {
  return Platform.OS === "ios" || Platform.OS === "android";
}

/**
 * Check if running on web platform
 */
export function isWeb(): boolean {
  return Platform.OS === "web";
}

//#endregion

//#region Desktop Detection (Tauri)

/**
 * Check if running as a desktop app (Tauri)
 * In React Native context, this checks for macos/windows platforms
 */
export function isDesktopApp(): boolean {
  return Platform.OS === "macos" || Platform.OS === "windows";
}

/**
 * Check if running on Windows desktop
 */
export function isWindows(): boolean {
  return Platform.OS === "windows";
}

/**
 * Check if running on macOS desktop
 */
export function isMac(): boolean {
  return Platform.OS === "macos";
}

/**
 * Check if running Windows desktop app
 */
export function isWindowsApp(): boolean {
  return isDesktopApp() && isWindows();
}

/**
 * Check if running macOS desktop app
 */
export function isMacApp(): boolean {
  return isDesktopApp() && isMac();
}

//#endregion

//#region Platform Version

/**
 * Get the current platform version
 * Returns OS version on mobile, empty string on web/desktop
 */
export function getPlatformVersion(): string | number {
  return Platform.Version;
}

/**
 * Check if iOS version is at least the specified version
 */
export function isIosVersionAtLeast(version: number): boolean {
  if (!isIos()) {
    return false;
  }
  const currentVersion =
    typeof Platform.Version === "string"
      ? parseFloat(Platform.Version)
      : Platform.Version;
  return currentVersion >= version;
}

/**
 * Check if Android API level is at least the specified level
 */
export function isAndroidApiLevelAtLeast(apiLevel: number): boolean {
  if (!isAndroid()) {
    return false;
  }
  const currentApiLevel =
    typeof Platform.Version === "number"
      ? Platform.Version
      : parseInt(String(Platform.Version), 10);
  return currentApiLevel >= apiLevel;
}

//#endregion

//#region Platform Info

/**
 * Get comprehensive platform information
 */
export function getPlatformInfo(): IPlatformInfo {
  const os = Platform.OS as IPlatformOS;

  return {
    os,
    version: Platform.Version,
    isIos: isIos(),
    isAndroid: isAndroid(),
    isMobile: isMobile(),
    isDesktop: isDesktopApp(),
    isWeb: isWeb(),
  };
}

//#endregion

//#region Platform Select

/**
 * Select a value based on the current platform
 * Type-safe wrapper around Platform.select
 */
export function platformSelect<T>(options: {
  ios?: T;
  android?: T;
  native?: T;
  web?: T;
  default: T;
}): T {
  return Platform.select({
    ios: options.ios,
    android: options.android,
    native: options.native,
    web: options.web,
    default: options.default,
  }) as T;
}

//#endregion
```

## Index Export

```typescript
// apps/v2/src/utils/index.ts

export {
  isIos,
  isAndroid,
  isMobile,
  isWeb,
  isDesktopApp,
  isWindows,
  isMac,
  isWindowsApp,
  isMacApp,
  getPlatformVersion,
  isIosVersionAtLeast,
  isAndroidApiLevelAtLeast,
  getPlatformInfo,
  platformSelect,
} from "./platform";

export type { IPlatformOS, IPlatformInfo } from "./platform";
```

## Acceptance Criteria

- [ ] All functions use React Native Platform API (no user agent parsing)
- [ ] All types defined with `type` keyword and `I` prefix
- [ ] Uses `#region` comments for organization
- [ ] Exported from `utils/index.ts`
- [ ] No `any` types
- [ ] TypeScript strict mode passes
- [ ] Unit tests cover all platform scenarios

## Testing

```typescript
// apps/v2/src/utils/platform.spec.tsx

import { Platform } from "react-native";

import {
  isIos,
  isAndroid,
  isMobile,
  isWeb,
  isDesktopApp,
  isWindows,
  isMac,
  getPlatformVersion,
  isIosVersionAtLeast,
  isAndroidApiLevelAtLeast,
  getPlatformInfo,
  platformSelect,
} from "./platform";

describe("Platform Utils", () => {
  const originalPlatform = Platform.OS;
  const originalVersion = Platform.Version;

  afterEach(() => {
    // Reset Platform mock
    Object.defineProperty(Platform, "OS", { value: originalPlatform });
    Object.defineProperty(Platform, "Version", { value: originalVersion });
  });

  //#region iOS Detection

  describe("isIos", () => {
    it("returns true on iOS", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      expect(isIos()).toBe(true);
    });

    it("returns false on Android", () => {
      Object.defineProperty(Platform, "OS", { value: "android" });
      expect(isIos()).toBe(false);
    });
  });

  //#endregion

  //#region Android Detection

  describe("isAndroid", () => {
    it("returns true on Android", () => {
      Object.defineProperty(Platform, "OS", { value: "android" });
      expect(isAndroid()).toBe(true);
    });

    it("returns false on iOS", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      expect(isAndroid()).toBe(false);
    });
  });

  //#endregion

  //#region Mobile Detection

  describe("isMobile", () => {
    it("returns true on iOS", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      expect(isMobile()).toBe(true);
    });

    it("returns true on Android", () => {
      Object.defineProperty(Platform, "OS", { value: "android" });
      expect(isMobile()).toBe(true);
    });

    it("returns false on web", () => {
      Object.defineProperty(Platform, "OS", { value: "web" });
      expect(isMobile()).toBe(false);
    });
  });

  //#endregion

  //#region Web Detection

  describe("isWeb", () => {
    it("returns true on web", () => {
      Object.defineProperty(Platform, "OS", { value: "web" });
      expect(isWeb()).toBe(true);
    });

    it("returns false on mobile", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      expect(isWeb()).toBe(false);
    });
  });

  //#endregion

  //#region Desktop Detection

  describe("isDesktopApp", () => {
    it("returns true on macOS", () => {
      Object.defineProperty(Platform, "OS", { value: "macos" });
      expect(isDesktopApp()).toBe(true);
    });

    it("returns true on Windows", () => {
      Object.defineProperty(Platform, "OS", { value: "windows" });
      expect(isDesktopApp()).toBe(true);
    });

    it("returns false on mobile", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      expect(isDesktopApp()).toBe(false);
    });
  });

  //#endregion

  //#region Version Checks

  describe("isIosVersionAtLeast", () => {
    it("returns true when iOS version is sufficient", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      Object.defineProperty(Platform, "Version", { value: "16.0" });
      expect(isIosVersionAtLeast(15)).toBe(true);
    });

    it("returns false when iOS version is insufficient", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      Object.defineProperty(Platform, "Version", { value: "14.0" });
      expect(isIosVersionAtLeast(15)).toBe(false);
    });

    it("returns false on non-iOS platforms", () => {
      Object.defineProperty(Platform, "OS", { value: "android" });
      expect(isIosVersionAtLeast(15)).toBe(false);
    });
  });

  describe("isAndroidApiLevelAtLeast", () => {
    it("returns true when API level is sufficient", () => {
      Object.defineProperty(Platform, "OS", { value: "android" });
      Object.defineProperty(Platform, "Version", { value: 33 });
      expect(isAndroidApiLevelAtLeast(31)).toBe(true);
    });

    it("returns false when API level is insufficient", () => {
      Object.defineProperty(Platform, "OS", { value: "android" });
      Object.defineProperty(Platform, "Version", { value: 29 });
      expect(isAndroidApiLevelAtLeast(31)).toBe(false);
    });

    it("returns false on non-Android platforms", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      expect(isAndroidApiLevelAtLeast(31)).toBe(false);
    });
  });

  //#endregion

  //#region Platform Info

  describe("getPlatformInfo", () => {
    it("returns correct info for iOS", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      Object.defineProperty(Platform, "Version", { value: "16.0" });

      const info = getPlatformInfo();

      expect(info.os).toBe("ios");
      expect(info.isIos).toBe(true);
      expect(info.isAndroid).toBe(false);
      expect(info.isMobile).toBe(true);
      expect(info.isDesktop).toBe(false);
      expect(info.isWeb).toBe(false);
    });
  });

  //#endregion

  //#region Platform Select

  describe("platformSelect", () => {
    it("selects iOS value on iOS", () => {
      Object.defineProperty(Platform, "OS", { value: "ios" });
      jest.spyOn(Platform, "select").mockReturnValue("ios-value");

      const result = platformSelect({
        ios: "ios-value",
        android: "android-value",
        default: "default-value",
      });

      expect(result).toBe("ios-value");
    });
  });

  //#endregion
});
```

```bash
pnpm --filter @retrievly/app test:unit -- platform
pnpm --filter @retrievly/app tsc --noEmit
```

## Migration Notes

### API Differences

| Original (user_agent.tsx)       | New (platform.ts)       | Notes                              |
| ------------------------------- | ----------------------- | ---------------------------------- |
| `userAgent().indexOf('iPhone')` | `Platform.OS === 'ios'` | Native API, no string parsing      |
| `isIosWeb()`, `isAndroidWeb()`  | Removed                 | N/A in native context              |
| `isMobileApp()`                 | `isMobile()`            | All mobile is "app" in RN          |
| `isChrome()`, `isFirefox()`     | Removed                 | Browser detection not applicable   |
| `getDesktopVersion()`           | Removed                 | Use Tauri APIs for desktop version |
| `isInternetExplorer()`          | Removed                 | Legacy browser not applicable      |

### Not Migrated

The following functions are browser-specific and have no React Native equivalent:

- `isChrome()`, `isSafari()`, `isFirefox()`, `isEdge()`, `isChromiumEdge()`
- `isIosSafari()`, `isIosChrome()`, `isIosFirefox()`
- `isAndroidChrome()`, `isAndroidFirefox()`
- `isIosWeb()`, `isAndroidWeb()`, `isMobileApp()`
- `isChromebook()`, `isInternetExplorer()`
- `isWindows7()`, `isLinux()`
- `getDesktopVersion()`
